# Global Architecture Map

## Overview

This document provides a comprehensive view of all DENIS system components, their relationships, and integration points.

## System Topology

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    NODES                                               │
│                                                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────────┐    │
│  │                           nodomac (macOS)                                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │    │
│  │  │   Chat CP   │  │   Overlay   │  │Control Room│  │  AtlasLite  │     │    │
│  │  │   Layer     │  │  Filesystem │  │   Steps    │  │    API      │     │    │
│  │  │  :9999      │  │   :19999    │  │             │  │   :19998    │     │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │    │
│  │         │                │                │                │               │    │
│  │         └────────────────┴────────────────┴────────────────┘               │    │
│  │                                    │                                        │    │
│  │                          ┌─────────┴─────────┐                            │    │
│  │                          │   nodomac.db     │                            │    │
│  │                          │   (SQLite)       │                            │    │
│  │                          └───────────────────┘                            │    │
│  └──────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                         │
│  ═══════════════════════════════════════════════════════════════════════════════════   │
│                                                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────────┐    │
│  │                              nodo1 (Linux - Localhost)                      │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │    │
│  │  │   Denis    │  │ Inference   │  │   Memory   │  │ Metacognitive│    │    │
│  │  │ Unified API │  │  Gateway   │  │   System   │  │    System    │     │    │
│  │  │   :9999    │  │             │  │             │  │              │     │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │    │
│  │         │                │                │                │               │    │
│  │         └────────────────┴────────────────┴────────────────┘               │    │
│  │                                    │                                        │    │
│  │         ┌─────────────────────────┼─────────────────────────┐             │    │
│  │         │                         │                         │             │    │
│  │         ▼                         ▼                         ▼             │    │
│  │  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐      │    │
│  │  │   Neo4j    │        │   Redis    │        │  Provider   │      │    │
│  │  │ (metagraph)│        │  (cache)   │        │ Registry    │      │    │
│  │  └─────────────┘        └─────────────┘        └─────────────┘      │    │
│  └──────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                         │
│  ═══════════════════════════════════════════════════════════════════════════════════   │
│                                                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────────┐    │
│  │                              nodo2 (Linux - 10.10.10.2)                     │    │
│  │  GPU: 1050 Ti 4GB                                                           │    │
│  │                                                                                 │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │    │
│  │  │   LLM       │  │   LLM       │  │    TTS      │  │   Voice     │     │    │
│  │  │  Server    │  │  Server     │  │   (Piper)   │  │  Pipeline   │     │    │
│  │  │  :8003     │  │  :8006-8   │  │   :8005     │  │             │     │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │    │
│  │                                                                                 │
│  │  [Future: Frontend Build Node]                                                │    │
│  └──────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Component Relationships

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              SERVICE LAYER                                           │
│                                                                                     │
│  ┌─────────────┐                                                                         │
│  │  Chat CP    │◀────────────────────┐                                                 │
│  │ (Feature    │                     │                                                 │
│  │  Flagged)   │                     │                                                 │
│  └──────┬──────┘                     │                                                 │
│         │                            │                                                 │
│         │ reads                     │ writes                                          │
│         ▼                            ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐      │
│  │                              NEO4J GRAPH                                    │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐        │      │
│  │  │ SystemState│  │Component   │  │Provider   │  │FeatureFlag │        │      │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘        │      │
│  │        │                │               │              │                    │      │
│  │        └────────────────┴───────────────┴──────────────┘                    │      │
│  │                              │                                              │      │
│  │                              ▼                                              │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐        │      │
│  │  │   Node     │  │HealthState│  │Decision    │  │ Event      │        │      │
│  │  │ (topology)│  │(aliveness)│  │  Trace     │  │(audit log) │        │      │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘        │      │
│  └─────────────────────────────────────────────────────────────────────────────┘      │
│                                    │                                                │
└────────────────────────────────────┼────────────────────────────────────────────────┘
                                     │
                                     │ reads/writes
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           DATA LAYER                                               │
│                                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │   Neo4j     │    │   Redis     │    │   SQLite    │    │ Filesystem  │      │
│  │ (graph)     │    │ (cache)     │    │(operational)│    │ (artifacts) │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Network Connections

```
                    Tailscale / Local Network
                    
        nodomac ◄──────────────► nodo1 ◄──────────────► nodo2
          │                          │                          │
          │   SSH (port 22)         │   HTTP (:8003-8008)     │
          │   API (:9999)           │   LLM Servers            │
          │   API (:19998)          │   TTS (:8005)           │
          │   API (:19999)          │                          │
          │                          │                          │
          └──────────────────────────┴──────────────────────────┘
                                        │
                                        ▼
                              Home Assistant (future)
                              - GPS events
                              - Camera streams
                              - Sensor data
```

## External Integrations

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            EXTERNAL SERVICES                                         │
│                                                                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   OpenAI       │    │   Anthropic     │    │    Groq        │              │
│  │   API          │    │   API           │    │    API          │              │
│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘              │
│           │                      │                      │                         │
│           │        Chat CP       │                      │                         │
│           └──────────┬───────────┘──────────────────────┘                         │
│                      │                                                             │
│                      ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐      │
│  │                     HOME ASSISTANT (Future)                              │      │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐             │      │
│  │  │   GPS   │  │ Cameras  │  │ Sensors  │  │  Lights  │             │      │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘             │      │
│  └─────────────────────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow Examples

### Example 1: Chat Request

```
User ──POST /v1/chat──▶ Denis API (:9999)
                              │
                              ├──▶ Inference Gateway
                              │         │
                              │         ├──▶ OpenAI ──▶ Response
                              │         │
                              │         ├──▶ Anthropic ──▶ Response
                              │         │
                              │         └──▶ Local Fallback ──▶ Response
                              │
                             ▶ Write Decision └── Trace ──▶ Neo4j
```

### Example 2: Overlay Scan

```
Control Room ──▶ overlay_scan step
                    │
                    ├──▶ Scan files on nodomac
                    │         │
                    │         └──▶ probes_report.json (artifact)
                    │
                    ├──▶ Index in SQLite (overlay_entries)
                    │
                    ├──▶ Write Manifest to Neo4j
                    │
                    └──▶ Push to Denis (optional)
```

### Example 3: IoT Event (Future)

```
Home Assistant ──▶ GPS Event ──▶ Denis API
                              │
                              ├──▶ Update Graph (Device state)
                              │
                              ├──▶ Trigger Action ──▶ Inference
                              │
                              └──▶ Log Event ──▶ Neo4j
```

## Component Inventory

| Component | Type | Node | Port | Dependencies |
|-----------|------|------|------|---------------|
| Denis Unified API | Service | nodo1 | 9999 | Neo4j, Redis |
| Inference Gateway | Service | nodo1 | - | OpenAI, Anthropic, Groq |
| Chat CP | Service | nodomac | 9999 | Keyring |
| Overlay FS | Service | nodomac | 19999 | SQLite |
| Control Room | Orchestration | nodomac | - | SQLite |
| AtlasLite | Service | nodomac | 19998 | SQLite |
| LLM Server | Service | nodo2 | 8003-8008 | - |
| TTS (Piper) | Service | nodo2 | 8005 | - |

## Ports Summary

| Port | Service | Node |
|------|---------|------|
| 9999 | Denis Unified API | nodo1 |
| 9999 | Chat CP API | nodomac |
| 19998 | AtlasLite API | nodomac |
| 19999 | Overlay API | nodomac |
| 8003 | LLM (qwen) | nodo2 |
| 8005 | TTS (Piper) | nodo2 |
| 8006 | LLM (smollm) | nodo2 |
| 8007 | LLM (safety) | nodo2 |
| 8008 | LLM (intent) | nodo2 |
