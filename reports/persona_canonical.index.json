{
  "schema_version": 1,
  "doc_type": "source_index",
  "source": {
    "path": "/media/jotah/SSD_denis/denis_persona_canonical.py",
    "sha256": "ddbe16e1dbaf1d85b3008e96f07fcf5219eddf2b62786bbdfb9f90a2d2a5afae",
    "bytes": 861053,
    "line_count": 22797
  },
  "generated_utc": "2026-02-14T00:29:33.597136+00:00",
  "anchors": [
    {
      "anchor_id": "A:functiondef:register_memory_routers",
      "kind": "functiondef",
      "name": "register_memory_routers",
      "start_line": 324,
      "end_line": 327,
      "snippet_hash": "18a15dbfe21c6379f8183fe6627545c484e236586c1e57ecbfc9291a1da57927",
      "excerpt": "    def register_memory_routers(app):  # type: ignore\n        raise RuntimeError(\n            \"Memory API router import failed; refusing stub fallback in canonical entrypoint\"\n        ) from _MEMORY_API_IMPORT_ERROR",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_auth_manager",
      "kind": "asyncfunctiondef",
      "name": "get_auth_manager",
      "start_line": 410,
      "end_line": 411,
      "snippet_hash": "f9642a4e185f6a7b524a2ad30def000ea6b520aaba210a719867b61bb20fff9c",
      "excerpt": "    async def get_auth_manager():  # type: ignore\n        raise HTTPException(status_code=501, detail=\"Auth module not available\")",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_current_user",
      "kind": "asyncfunctiondef",
      "name": "get_current_user",
      "start_line": 421,
      "end_line": 461,
      "snippet_hash": "9eb041f1ada5c9632cbdd14dc7f2839e3b3db1c623f2ec6394bb731f5f84697b",
      "excerpt": "async def get_current_user(\n    credentials: HTTPAuthorizationCredentials = Depends(security),\n    request: Request = None,  # type: ignore[assignment]\n) -> User:\n    \"\"\"\n    Dependency para verificar token y obtener usuario actual\n    Usa ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_current_user_optional",
      "kind": "asyncfunctiondef",
      "name": "get_current_user_optional",
      "start_line": 464,
      "end_line": 523,
      "snippet_hash": "7183e52a9eb5bde67bbe99cc37922909fcefb349110ca8fe30453b267b8dd559",
      "excerpt": "async def get_current_user_optional(\n    authorization: Optional[str] = Header(None),\n    request: Request = None,  # type: ignore[assignment]\n) -> Optional[User]:\n    \"\"\"\n    Dependency opcional - permite acceso sin auth pero detecta user ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:require_permission",
      "kind": "functiondef",
      "name": "require_permission",
      "start_line": 526,
      "end_line": 546,
      "snippet_hash": "b5e4c36037d46720776cb9d57384f4745b349c2e02b7cae3437548c24f918468",
      "excerpt": "def require_permission(permission: str):\n    \"\"\"\n    Decorator para verificar permiso especÃ­fico\n\n    @require_permission(\"code:write\")\n    async def create_code(user: User = Depends(get_current_user)):\n        ...\n    \"\"\"\n\n    async def pe",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:permission_checker",
      "kind": "asyncfunctiondef",
      "name": "permission_checker",
      "start_line": 535,
      "end_line": 544,
      "snippet_hash": "410fd758ee18b4fce60b46539c54d88b5d0607dbdb50ca850e1d3fabe35602b4",
      "excerpt": "    async def permission_checker(user: User = Depends(get_current_user)):\n        if not _HAS_AUTH:\n            raise HTTPException(status_code=501, detail=\"Auth module not available\")\n\n        auth_manager = await get_auth_manager()\n      ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_has_any_role",
      "kind": "functiondef",
      "name": "_has_any_role",
      "start_line": 552,
      "end_line": 557,
      "snippet_hash": "e5f37d47507d2dcb8bb54e444e14bb5e2f84cb0e671d1e035a44e336bb6ebecd",
      "excerpt": "def _has_any_role(user: User, roles: set) -> bool:\n    try:\n        r = set((user.roles or []))\n    except Exception:\n        r = set()\n    return bool(r.intersection(roles))",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:require_roles",
      "kind": "functiondef",
      "name": "require_roles",
      "start_line": 560,
      "end_line": 579,
      "snippet_hash": "028a546ba308d9915dd1764d6c040dae2aa89812f3e42061a3b12d7f567305ac",
      "excerpt": "def require_roles(allowed_roles: list):\n    \"\"\"\n    Hard role gate (independent from fine-grained permissions).\n    Use for \"IDE/refactor factory\" where we want strong, profile-level separation.\n    \"\"\"\n\n    allowed = set(\n        [str(x).s",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:role_checker",
      "kind": "asyncfunctiondef",
      "name": "role_checker",
      "start_line": 570,
      "end_line": 577,
      "snippet_hash": "c29763cc89236f7fdd6f837cb8bf9078a7d8bd055e847374760f53a9f202fa43",
      "excerpt": "    async def role_checker(user: User = Depends(get_current_user)):\n        roles = [str(x).strip().lower() for x in (user.roles or [])]\n        if allowed.intersection(set(roles)):\n            return user\n        raise HTTPException(\n     ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_is_owner_user_id_fallback",
      "kind": "functiondef",
      "name": "_is_owner_user_id_fallback",
      "start_line": 595,
      "end_line": 599,
      "snippet_hash": "ac25fee1ba20fa209981ca0abfb72d1e1fad0eab8a80bcfcfa0746beddf0569d",
      "excerpt": "def _is_owner_user_id_fallback(user_id: str) -> bool:\n    # Fallback when requests don't carry Authorization yet (legacy frontend).\n    # This is NOT a security boundary; it is a compatibility bridge.\n    s = (user_id or \"\").strip().lower()",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_caller_is_owner",
      "kind": "functiondef",
      "name": "_caller_is_owner",
      "start_line": 602,
      "end_line": 607,
      "snippet_hash": "cc7371d6349cf810226191e055f210b2053cd9820993c4162fb8cb4cd28b5595",
      "excerpt": "def _caller_is_owner() -> bool:\n    try:\n        roles = [str(x).strip().lower() for x in (_CALLER_ROLES.get() or [])]\n    except Exception:\n        roles = []\n    return (\"owner\" in roles) or (\"superadmin\" in roles)",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_is_trusted_local_host",
      "kind": "functiondef",
      "name": "_is_trusted_local_host",
      "start_line": 610,
      "end_line": 628,
      "snippet_hash": "802a5a2c646563a7e34e889f9d5c417436d650bfcae988f6e02225c3ce11d5bc",
      "excerpt": "def _is_trusted_local_host(host: str) -> bool:\n    s = (host or \"\").strip().lower()\n    if not s:\n        # In-process clients or some proxies may not expose request.client.\n        # Treat as trusted-local for owner-mode compatibility.\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_safe_parse_nonnegative_int",
      "kind": "functiondef",
      "name": "_safe_parse_nonnegative_int",
      "start_line": 631,
      "end_line": 636,
      "snippet_hash": "cceabd10dfb59a2aec201951b36c3f5db44820ce42f734188750549fa32ead24",
      "excerpt": "def _safe_parse_nonnegative_int(raw: str, default: int = 0) -> int:\n    try:\n        parsed = int(str(raw or \"\").strip())\n        return parsed if parsed >= 0 else default\n    except Exception:\n        return default",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_tool_is_ide_or_code",
      "kind": "functiondef",
      "name": "_tool_is_ide_or_code",
      "start_line": 639,
      "end_line": 667,
      "snippet_hash": "6779bc0732eff5b9b085288a3aa79c8b0aab4a00274eee21ab032689f6ed9ac5",
      "excerpt": "def _tool_is_ide_or_code(tool_id: str) -> bool:\n    t = (tool_id or \"\").strip()\n    if not t:\n        return False\n    if t.startswith((\"generate_\", \"debug_\", \"refactor_\", \"git_\", \"security_\")):\n        return True\n    if t in {\n        # f",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_deny_code_only",
      "kind": "functiondef",
      "name": "_deny_code_only",
      "start_line": 670,
      "end_line": 676,
      "snippet_hash": "4b3cbcda9739592ceb2acee499b7cb512866192316ceaeefef037de7f7382f00",
      "excerpt": "def _deny_code_only() -> dict:\n    # Return \"success\": True so tool formatting doesn't prefix with \"Error ejecutando ...\".\n    msg = _OWNER_CODE_ONLY_MESSAGE\n    return {\n        \"success\": True,\n        \"result\": {\"output\": msg, \"analysis\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_is_uuid",
      "kind": "functiondef",
      "name": "_is_uuid",
      "start_line": 748,
      "end_line": 752,
      "snippet_hash": "8ad998b8c19a733329ddc492c2b0df0df3b2d01ae9a6a77081ce5d0464d3a3e7",
      "excerpt": "def _is_uuid(s: str) -> bool:\n    try:\n        return bool(_RE_UUID.match((s or \"\").strip()))\n    except Exception:\n        return False",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:canonicalize_user_id",
      "kind": "functiondef",
      "name": "canonicalize_user_id",
      "start_line": 755,
      "end_line": 793,
      "snippet_hash": "59cbf651659d7bfdd44cde46bf5fe4fcd917a824bc6e849c4f6310bc56624e22",
      "excerpt": "def canonicalize_user_id(user_id: str) -> str:\n    \"\"\"\n    Normalize user_id to avoid identity/memory drift (e.g., 'Jotah' vs UUID).\n    If owner mode is enabled and DENIS_OWNER_USER_ID is a UUID, map common aliases to it.\n    \"\"\"\n    uid =",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_load_env_from_file",
      "kind": "functiondef",
      "name": "_load_env_from_file",
      "start_line": 799,
      "end_line": 821,
      "snippet_hash": "b1ed8e5d6c36b22646eac2871ae590b249abd23e24d7c3496bd2beea56541959",
      "excerpt": "def _load_env_from_file(path: Path, *, override: bool) -> None:\n    if not path.exists():\n        return\n    for line in path.read_text(errors=\"ignore\").splitlines():\n        line = line.strip()\n        if not line or line.startswith(\"#\") o",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_ensure_env",
      "kind": "functiondef",
      "name": "_ensure_env",
      "start_line": 824,
      "end_line": 829,
      "snippet_hash": "de3e5c622ea818355381af8ebd03623cb0cfb9304a49d835847a00d24825982a",
      "excerpt": "def _ensure_env() -> None:\n    # Load .env first, then let .env.prod override it for production.\n    _load_env_from_file(Path(\".env\"), override=False)\n    _load_env_from_file(Path(\".env.prod\"), override=True)\n    # Local-only production sec",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_sanitize_neo4j_uri",
      "kind": "functiondef",
      "name": "_sanitize_neo4j_uri",
      "start_line": 832,
      "end_line": 854,
      "snippet_hash": "f4291b10837152128e8dcbddfd9ab037649180420440a20e076926bb9620e19e",
      "excerpt": "def _sanitize_neo4j_uri(uri: str) -> str:\n    # Trim duplicated schemes like 'bolt://...bolt://...' to the first occurrence.\n    schemes = [\n        \"neo4j+s://\",\n        \"neo4j+ssc://\",\n        \"neo4j://\",\n        \"bolt+s://\",\n        \"bol",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_neo4j_cfg_from_docker",
      "kind": "functiondef",
      "name": "_neo4j_cfg_from_docker",
      "start_line": 857,
      "end_line": 879,
      "snippet_hash": "2653454852e4fccbda5e76e0ad300caf98c96970aeeb520d1a47a785519ec272",
      "excerpt": "def _neo4j_cfg_from_docker(container: str) -> Optional[Dict[str, str]]:\n    \"\"\"\n    Best-effort: read NEO4J_AUTH from a running Neo4j Docker container without printing secrets.\n    Expected format: 'user/password' or 'none'.\n    \"\"\"\n    try",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:resolve_neo4j_config",
      "kind": "functiondef",
      "name": "resolve_neo4j_config",
      "start_line": 882,
      "end_line": 894,
      "snippet_hash": "bcf22afe9f528af3f80250fcbec5fe75d15501c362d54fe257443421bd3409da",
      "excerpt": "def resolve_neo4j_config() -> Dict[str, str]:\n    _ensure_env()\n    uri = _sanitize_neo4j_uri(os.getenv(\"NEO4J_URI\", \"bolt://127.0.0.1:7687\"))\n    user = os.getenv(\"NEO4J_USER\", \"neo4j\")\n    password = os.getenv(\"NEO4J_PASSWORD\") or os.gete",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_infer_media_type",
      "kind": "functiondef",
      "name": "_infer_media_type",
      "start_line": 1238,
      "end_line": 1246,
      "snippet_hash": "378f6be2218c2b0f6668b4e51994d36c80e8b9896f4da986574a0e0d51ee05bb",
      "excerpt": "def _infer_media_type(url: str) -> str:\n    u = (url or \"\").lower()\n    if re.search(r\"\\.(png|jpe?g|gif|webp)(\\?|#|$)\", u):\n        return \"image\"\n    if re.search(r\"\\.(mp4|webm|mov|m4v)(\\?|#|$)\", u):\n        return \"video\"\n    if re.search",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:extract_media_request",
      "kind": "functiondef",
      "name": "extract_media_request",
      "start_line": 1249,
      "end_line": 1287,
      "snippet_hash": "83b25461d6a8d09391ee5f54d7f82a6dfcc3cd489db44357180a1f03f7cee7e9",
      "excerpt": "def extract_media_request(text: str) -> Optional[Dict[str, Any]]:\n    \"\"\"\n    If the user is asking to show/play media and includes a URL, emit a UI media event.\n    We keep it conservative: only trigger when a URL exists AND the text is cl",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:extract_image_search_request",
      "kind": "functiondef",
      "name": "extract_image_search_request",
      "start_line": 1290,
      "end_line": 1374,
      "snippet_hash": "35872d5523546b8839a20e8feb0fc69c24e3f4e2c9772d4b7f5307d9a21e34cc",
      "excerpt": "def extract_image_search_request(text: str) -> Optional[Dict[str, Any]]:\n    \"\"\"\n    Detect requests like:\n    - \"muestrame imagenes de gatos\"\n    - \"quiero ver fotos de auroras boreales\"\n    - \"busca 6 imagenes de arquitectura brutalista\"\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_image_gallery_urls",
      "kind": "functiondef",
      "name": "build_image_gallery_urls",
      "start_line": 1377,
      "end_line": 1401,
      "snippet_hash": "cbbd79d045fecbb383dd1cb641095f6bebc26c79732d584cafb4f79eba855f81",
      "excerpt": "def build_image_gallery_urls(query: str, count: int = 4) -> List[str]:\n    \"\"\"\n    Build deterministic, API-key-free image URLs.\n    Uses public providers with seeded URLs for stable cards.\n    \"\"\"\n    q = re.sub(r\"\\s+\", \" \", (query or \"\").",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:extract_media_control",
      "kind": "functiondef",
      "name": "extract_media_control",
      "start_line": 1404,
      "end_line": 1429,
      "snippet_hash": "b789a9fad5b7fda5e0da2dff3f13b66087901f1fc35f69ca23584486d77271a1",
      "excerpt": "def extract_media_control(text: str) -> Optional[Dict[str, Any]]:\n    \"\"\"\n    Extract simple media control commands from user text.\n    Used so Denis can control playback like the user.\n    \"\"\"\n    if not text:\n        return None\n    tl = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:_LocalIntentRouter",
      "kind": "classdef",
      "name": "_LocalIntentRouter",
      "start_line": 1449,
      "end_line": 1546,
      "snippet_hash": "18c2396d50a356f2942935cae098db2e3e41c5e2675b4812dadd95737c41ef20",
      "excerpt": "class _LocalIntentRouter:\n    def __init__(self):\n        self.ready = False\n        self.embedder = None\n        self.seed_intents: List[str] = []\n        self.seed_embs: Optional[torch.Tensor] = None\n        self._maybe_load()\n\n    def _m",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:__init__",
      "kind": "functiondef",
      "name": "__init__",
      "start_line": 1450,
      "end_line": 1455,
      "snippet_hash": "fa0b307a051f7a0478fd91cccdf679795bc386724106326ad2603dd9b20e5d0f",
      "excerpt": "    def __init__(self):\n        self.ready = False\n        self.embedder = None\n        self.seed_intents: List[str] = []\n        self.seed_embs: Optional[torch.Tensor] = None\n        self._maybe_load()",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_maybe_load",
      "kind": "functiondef",
      "name": "_maybe_load",
      "start_line": 1457,
      "end_line": 1480,
      "snippet_hash": "5a90704a74cfc0b660aabeb8a721639195dca26c92c5c1760a9e362b7bf2e21a",
      "excerpt": "    def _maybe_load(self):\n        try:\n            base = Path(__file__).parent\n            path = base / \"models\" / \"embeddings\" / \"miniLM\"\n            if not path.exists():\n                logger.warning(\"Local intent router missing embe",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_encode",
      "kind": "functiondef",
      "name": "_encode",
      "start_line": 1482,
      "end_line": 1490,
      "snippet_hash": "97c8cee98f7fa3250494e42ee1feaae06b879c5313d7d2151e8413c8e132232f",
      "excerpt": "    def _encode(self, tok, model, texts: List[str]) -> torch.Tensor:\n        with torch.no_grad():\n            inputs = tok(texts, padding=True, truncation=True, return_tensors=\"pt\").to(\n                model.device\n            )\n          ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_build_seed_index",
      "kind": "functiondef",
      "name": "_build_seed_index",
      "start_line": 1492,
      "end_line": 1533,
      "snippet_hash": "d856befc3fcedc060cee5fec449ee8c06dcf057cc3af8b5aef3c76ee13650627",
      "excerpt": "    def _build_seed_index(self, tok, model):\n        seed_examples = {\n            \"gps_distance\": [\n                \"distancia entre X y Y\",\n                \"ruta de Madrid a Barcelona\",\n                \"cuantos kilometros hay de Vic a Man",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:route",
      "kind": "functiondef",
      "name": "route",
      "start_line": 1535,
      "end_line": 1546,
      "snippet_hash": "2ba1a5c851d33e609aff80dc9d8abd0d35cc9c1993a3a5d21588872fd3f5c95f",
      "excerpt": "    def route(self, text: str) -> Optional[Dict[str, Any]]:\n        if not self.ready or not self.embedder or self.seed_embs is None:\n            return None\n        tok, model = self.embedder\n        emb = self._encode(tok, model, [text]) ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_normalize_place",
      "kind": "functiondef",
      "name": "_normalize_place",
      "start_line": 1552,
      "end_line": 1559,
      "snippet_hash": "0f6206d3fdd8c2784da3ebde5ac8ebb50d9d9201ce206f91ca12b9b29d828492",
      "excerpt": "def _normalize_place(p: str) -> str:\n    p = (p or \"\").strip()\n    # Remove surrounding quotes and common punctuation.\n    p = p.strip(\" \\t\\r\\n\\\"'()[]{}\")\n    p = p.strip(\" .,!?:;\")\n    # Collapse whitespace.\n    p = re.sub(r\"\\s+\", \" \", p)\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:extract_gps_route",
      "kind": "functiondef",
      "name": "extract_gps_route",
      "start_line": 1562,
      "end_line": 1605,
      "snippet_hash": "ae9c26ba7082fc3134e67f8f3c60e6be092191cb2f6a78a4be9b5fadb7c7f7a2",
      "excerpt": "def extract_gps_route(text: str) -> Optional[Dict[str, str]]:\n    \"\"\"\n    Best-effort extraction for queries like:\n    - \"Cuanta distancia hay de Vic a Manresa\"\n    - \"Ruta desde Vic hasta Manresa\"\n    - \"Vic a Manresa (distancia)\"\n    - \"d",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:force_intent_router",
      "kind": "functiondef",
      "name": "force_intent_router",
      "start_line": 1608,
      "end_line": 1617,
      "snippet_hash": "f713a27dc965f00a9b2160fb0356149257162eed73e98e51be04be064465a445",
      "excerpt": "def force_intent_router(text: str) -> Optional[Dict[str, Any]]:\n    \"\"\"\n    Lightweight router that overrides NLU for high-precision patterns\n    to avoid misclassification by Rasa. Returns dict with intent/params\n    or None if no override",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_infer_pragmatic_intent_override",
      "kind": "functiondef",
      "name": "_infer_pragmatic_intent_override",
      "start_line": 1620,
      "end_line": 1688,
      "snippet_hash": "ea01af315aa7f14931e790fd72e6d05eb6d380bd24e07e35b34e2826456a3d56",
      "excerpt": "def _infer_pragmatic_intent_override(\n    text: str, current_intent: str, current_confidence: float\n) -> Optional[str]:\n    \"\"\"\n    Lightweight sanity pass for technical intents.\n    Used only when NLU confidence is weak/ambiguous to avoid ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_extract_first_path",
      "kind": "functiondef",
      "name": "_extract_first_path",
      "start_line": 1696,
      "end_line": 1704,
      "snippet_hash": "ba4893634441749a33a42d5b85578dd4805b6ccb4ba165e2e095cff7f155a87c",
      "excerpt": "def _extract_first_path(text: str) -> str:\n    if not text:\n        return \"\"\n    m = _RE_ABS_PATH.search(text)\n    if not m:\n        return \"\"\n    p = (m.group(\"path\") or \"\").strip()\n    # Trim trailing punctuation.\n    return p.rstrip(\").",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_extract_glob",
      "kind": "functiondef",
      "name": "_extract_glob",
      "start_line": 1707,
      "end_line": 1711,
      "snippet_hash": "d58cb9eaeac83c1884950ceec07cfb0cdf573dea94445c3dc553f8ed141649ab",
      "excerpt": "def _extract_glob(text: str) -> str:\n    if not text:\n        return \"\"\n    m = _RE_GLOB.search(text)\n    return (m.group(\"glob\") or \"\").strip() if m else \"\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_looks_like_tool_request",
      "kind": "functiondef",
      "name": "_looks_like_tool_request",
      "start_line": 1714,
      "end_line": 1765,
      "snippet_hash": "0ef7f20215343970ef95cb8bdf8e3384b5405099c98a91ef10659ba8b5de54ba",
      "excerpt": "def _looks_like_tool_request(text: str) -> bool:\n    if not text:\n        return False\n    tl = text.lower()\n    # If the user mentions a filesystem path or file-like token, it's often a tool request.\n    if \"/\" in tl or any(\n        ext in",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_tool_to_intent",
      "kind": "functiondef",
      "name": "_tool_to_intent",
      "start_line": 1768,
      "end_line": 1780,
      "snippet_hash": "19cb941bc435c351c2a23d1174234b9d797b98481e5e6ab7592b0916cea9e79d",
      "excerpt": "def _tool_to_intent(tool_id: str) -> Optional[str]:\n    \"\"\"\n    Map a Tool Executor tool_id to an intent key that routes through INTENT_TO_TOOL.\n    Prefer identity mapping (intent == tool_id), otherwise use the first intent that maps to it",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_tool_search_override",
      "kind": "asyncfunctiondef",
      "name": "_tool_search_override",
      "start_line": 1783,
      "end_line": 1848,
      "snippet_hash": "5fd6d273c8cbe295c49e7aa38c75c181d113ef32c95d6aef361c86295fce87b4",
      "excerpt": "async def _tool_search_override(\n    text: str, raw_intent: str, raw_confidence: float\n) -> Optional[Dict[str, Any]]:\n    \"\"\"\n    When Rasa misclassifies a tool-shaped request (common), use Tool Executor's own\n    lightweight search as an i",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_route_urls",
      "kind": "functiondef",
      "name": "build_route_urls",
      "start_line": 1851,
      "end_line": 1857,
      "snippet_hash": "dc9af5748a930894866d57783b1d7f62bde130f80a925295150c3092c5dca8cc",
      "excerpt": "def build_route_urls(origin: str, destination: str) -> Dict[str, str]:\n    o = _urlquote(origin)\n    d = _urlquote(destination)\n    return {\n        \"google_maps\": f\"https://www.google.com/maps/dir/?api=1&origin={o}&destination={d}&travelmo",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_destination_urls",
      "kind": "functiondef",
      "name": "build_destination_urls",
      "start_line": 1860,
      "end_line": 1869,
      "snippet_hash": "29dc31593495500fffae0a2acf789a304bcbf666d7f54ab35c04e12893195e11",
      "excerpt": "def build_destination_urls(destination: str) -> Dict[str, str]:\n    \"\"\"\n    Destination-only URLs. Useful when we don't know the user's origin, but we still\n    want a deterministic, non-hallucinated \"open in maps\" result.\n    \"\"\"\n    d = _",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:build_core_capabilities_response",
      "kind": "asyncfunctiondef",
      "name": "build_core_capabilities_response",
      "start_line": 1872,
      "end_line": 1940,
      "snippet_hash": "361acb5e6e834bf76e02408dc4da11d03553ddb0933bafb1211a64b4f3213089",
      "excerpt": "async def build_core_capabilities_response(\n    user_id: str, identity_data: Optional[Dict[str, Any]] = None\n) -> str:\n    \"\"\"\n    Core-centric capabilities response.\n    Avoids hallucinated \"I can do anything\" answers by grounding in real ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_looks_like_code_snippet",
      "kind": "functiondef",
      "name": "_looks_like_code_snippet",
      "start_line": 1943,
      "end_line": 1956,
      "snippet_hash": "69a1574171d8d1f374cd893893134babae988b168df4b71795279212e9794a86",
      "excerpt": "def _looks_like_code_snippet(text: str) -> bool:\n    if not text:\n        return False\n    tl = text.lower()\n    if \"```\" in tl:\n        return True\n    # Lightweight heuristics for python-ish code.\n    return (\n        any(\n            tok",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:tool_params_sufficient",
      "kind": "functiondef",
      "name": "tool_params_sufficient",
      "start_line": 1959,
      "end_line": 1977,
      "snippet_hash": "de79ff50f52f9d8e2da4683248f0c1ba4fc5d0d405da1d7651b6d681453b6ba5",
      "excerpt": "def tool_params_sufficient(\n    tool_id: str, params: Dict[str, Any], original_text: str\n) -> bool:\n    # Tools that require a concrete target.\n    if tool_id in (\n        \"analyze_complexity\",\n        \"lint_code\",\n        \"type_check\",\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:connect_request_allowed",
      "kind": "functiondef",
      "name": "connect_request_allowed",
      "start_line": 2010,
      "end_line": 2034,
      "snippet_hash": "3178380a4d3e30fe243195d449bf7a72a869bcf1f382a124468a447a1fb28407",
      "excerpt": "def connect_request_allowed(\n    text: str, intent: str, confidence: float, entities: List[Dict[str, Any]]\n) -> bool:\n    \"\"\"\n    Prevent accidental Home Assistant routing when NLU misclassifies.\n    Only allow Connect if we have strong evi",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_looks_like_cjk_language",
      "kind": "functiondef",
      "name": "_looks_like_cjk_language",
      "start_line": 2037,
      "end_line": 2049,
      "snippet_hash": "e3f05de41479da1d56eaf831ea8b489529f2e36efe999455354ad95a65659fdc",
      "excerpt": "def _looks_like_cjk_language(text: str) -> bool:\n    if not text:\n        return False\n    # If there's kana, it's Japanese with very high probability.\n    if _RE_HAS_KANA.search(text):\n        return True\n    # Otherwise, detect heavy CJK ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_rewrite_to_spanish",
      "kind": "asyncfunctiondef",
      "name": "_rewrite_to_spanish",
      "start_line": 2052,
      "end_line": 2083,
      "snippet_hash": "31a0f852d3df27668cccbb1ee03113ffe22e51bc9600475b4dbdc9319770197e",
      "excerpt": "async def _rewrite_to_spanish(text: str) -> str:\n    \"\"\"\n    Best-effort rewrite to Spanish (single-shot). If it fails, return original.\n    Uses the primary dialog model directly (cheaper than full swarm race).\n    \"\"\"\n    try:\n        mes",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:enforce_output_language",
      "kind": "asyncfunctiondef",
      "name": "enforce_output_language",
      "start_line": 2086,
      "end_line": 2095,
      "snippet_hash": "73ad8ff91f9d817ff1311f3001c5dcb4b1a9a6dce26633de41414bf4ea70f318",
      "excerpt": "async def enforce_output_language(response_text: str) -> str:\n    if not DENIS_LANGUAGE_ENFORCE:\n        return response_text\n    if DENIS_FORCE_LANGUAGE != \"es\":\n        return response_text\n    if not response_text:\n        return respons",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_system_prompt",
      "kind": "functiondef",
      "name": "build_system_prompt",
      "start_line": 2098,
      "end_line": 2343,
      "snippet_hash": "093ff063ed80f3940eafa06bf2d47afa67bb63df02198fde76acc856e5207370",
      "excerpt": "def build_system_prompt(\n    ocean: Dict[str, float],\n    user_id: str = \"usuario\",\n    identity_data: Dict = None,\n    episodic_context: str = \"\",\n    emotional_state: str = \"neutral\",\n    task_type: str = \"dialog\",\n    parlai_signals: Opt",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_system_prompt_compact",
      "kind": "functiondef",
      "name": "build_system_prompt_compact",
      "start_line": 2346,
      "end_line": 2408,
      "snippet_hash": "e8335c626cd8f9e2ffcbc6e070fad129c52e7aaa79a7a7b4f5affb1bef15d660",
      "excerpt": "def build_system_prompt_compact(\n    *,\n    user_id: str,\n    identity_data: Optional[Dict[str, Any]] = None,\n    episodic_context: str = \"\",\n    emotional_state: str = \"neutral\",\n    task_type: str = \"dialog\",\n    extra_instructions: str =",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_read_first_line_secret_file",
      "kind": "functiondef",
      "name": "_read_first_line_secret_file",
      "start_line": 2426,
      "end_line": 2448,
      "snippet_hash": "71bd1e32763ffa647907cfd0bf1fbdf3bd69ccb9f878ca9179e94b9c3b32cc95",
      "excerpt": "def _read_first_line_secret_file(path_s: str) -> str:\n    \"\"\"\n    Read a secret value from a file without logging it.\n    Returns the first non-empty line, stripped of quotes and optional 'Bearer ' prefix.\n    \"\"\"\n    if not path_s:\n       ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_normalize_bearer_token",
      "kind": "functiondef",
      "name": "_normalize_bearer_token",
      "start_line": 2451,
      "end_line": 2457,
      "snippet_hash": "8bbc6d35039dc84114f9deaa8079aadec89e652f5747cbd9d43d6e53c66cd658",
      "excerpt": "def _normalize_bearer_token(token: Optional[str]) -> str:\n    if not token:\n        return \"\"\n    s = str(token).strip().strip('\"').strip(\"'\").strip()\n    if s.lower().startswith(\"bearer \"):\n        s = s[7:].strip()\n    return s",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_resolve_secrets_master_key_with_source",
      "kind": "functiondef",
      "name": "_resolve_secrets_master_key_with_source",
      "start_line": 2460,
      "end_line": 2481,
      "snippet_hash": "5f548ddb6ea46dbb52de359b2db2b299c6d8668c932239fd4312956583d92aa1",
      "excerpt": "def _resolve_secrets_master_key_with_source() -> tuple[str, str]:\n    \"\"\"\n    Resolve the vault master key (do not log).\n    Returns (key, source_id) where source_id is non-sensitive.\n    \"\"\"\n    k = (os.getenv(\"DENIS_SECRETS_MASTER_KEY\") o",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_resolve_secrets_master_key",
      "kind": "functiondef",
      "name": "_resolve_secrets_master_key",
      "start_line": 2484,
      "end_line": 2485,
      "snippet_hash": "575014ec67a482ff1e5e86f0823985c2e45e148f4486f01f47f4e9bccd5ee0b8",
      "excerpt": "def _resolve_secrets_master_key() -> str:\n    return _resolve_secrets_master_key_with_source()[0]",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_resolve_admin_key",
      "kind": "functiondef",
      "name": "_resolve_admin_key",
      "start_line": 2488,
      "end_line": 2499,
      "snippet_hash": "be837025a9eaac036244b511b3e3d4d666d1f2f764b9af9dd01a6ab0c37eb95e",
      "excerpt": "def _resolve_admin_key() -> str:\n    \"\"\"\n    Resolve admin key for write/list endpoints (do not log).\n    Supports env or file-based configuration.\n    \"\"\"\n    k = (os.getenv(\"DENIS_ADMIN_KEY\") or \"\").strip()\n    if k:\n        return k\n    ",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:ConversationGuardrails",
      "kind": "classdef",
      "name": "ConversationGuardrails",
      "start_line": 2515,
      "end_line": 2577,
      "snippet_hash": "a84ead2c550fe4049d6b9d76230f9f5c1d961f656fb127520b0d7b8fdbfa035c",
      "excerpt": "class ConversationGuardrails:\n    \"\"\"Production guardrails: anti-loop, rate-limit, duplicate detection.\"\"\"\n\n    def __init__(self):\n        self.session_responses: Dict[str, collections.deque] = {}\n        self.user_requests: Dict[str, coll",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:__init__",
      "kind": "functiondef",
      "name": "__init__",
      "start_line": 2518,
      "end_line": 2526,
      "snippet_hash": "616ac86825f78a50698e1ff109ccf4ba56c758fe7ed77272c61c79c995459fc4",
      "excerpt": "    def __init__(self):\n        self.session_responses: Dict[str, collections.deque] = {}\n        self.user_requests: Dict[str, collections.deque] = {}\n        self.max_requests_per_minute = 30\n        self.max_duplicate_ratio = 0.6\n       ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:check_rate_limit",
      "kind": "functiondef",
      "name": "check_rate_limit",
      "start_line": 2528,
      "end_line": 2543,
      "snippet_hash": "0771c5c075d4c34a391f3865c865f3ae67bb098178bcb920201013fddc3f35dc",
      "excerpt": "    def check_rate_limit(self, user_id: str) -> Optional[str]:\n        now = time.monotonic()\n        if user_id not in self.user_requests:\n            self.user_requests[user_id] = collections.deque(\n                maxlen=self.max_request",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:check_anti_loop",
      "kind": "functiondef",
      "name": "check_anti_loop",
      "start_line": 2545,
      "end_line": 2565,
      "snippet_hash": "a18e172755cc617dbcd139bd26b30199330bc0e7422ed67b461bfa05c27abaf6",
      "excerpt": "    def check_anti_loop(self, session_id: str, response_text: str) -> bool:\n        if session_id not in self.session_responses:\n            self.session_responses[session_id] = collections.deque(\n                maxlen=self.response_histor",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_word_similarity",
      "kind": "functiondef",
      "name": "_word_similarity",
      "start_line": 2567,
      "end_line": 2571,
      "snippet_hash": "a8a4b56f185f3c82ed94cbca56f5635b79b08e40c83750eec1c433216263479b",
      "excerpt": "    def _word_similarity(self, a: str, b: str) -> float:\n        set_a, set_b = set(a.split()), set(b.split())\n        if not set_a or not set_b:\n            return 0.0\n        return len(set_a & set_b) / len(set_a | set_b)",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:cleanup",
      "kind": "functiondef",
      "name": "cleanup",
      "start_line": 2573,
      "end_line": 2577,
      "snippet_hash": "18af01264cfe6e19d8c13317ed5f1eac1b8f73b0f188b799f9b0ce99d1a0fca7",
      "excerpt": "    def cleanup(self, max_sessions: int = 500):\n        for store in (self.session_responses, self.user_requests):\n            if len(store) > max_sessions:\n                for k in list(store.keys())[: len(store) // 2]:\n                   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:trace_id",
      "kind": "functiondef",
      "name": "trace_id",
      "start_line": 2681,
      "end_line": 2683,
      "snippet_hash": "7775c7a284a6dd0f36c01a2a0bac3aad6b4349b69368d43e709fdf261b9780e2",
      "excerpt": "def trace_id() -> str:\n    raw = f\"{datetime.utcnow().isoformat()}:{uuid.uuid4().hex[:8]}\"\n    return hashlib.sha256(raw.encode()).hexdigest()[:16]",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_prefetch_text_hash",
      "kind": "functiondef",
      "name": "_prefetch_text_hash",
      "start_line": 2686,
      "end_line": 2689,
      "snippet_hash": "f038503558f29805cb24c51e248b93c6dcee9c41f8153ea937bc34a64391088a",
      "excerpt": "def _prefetch_text_hash(text: str) -> str:\n    # Keep hashing consistent between WS prefetch (partial) and final submit.\n    norm = (text or \"\").strip()\n    return hashlib.md5(norm.encode()).hexdigest()[:8]",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_url_origin",
      "kind": "functiondef",
      "name": "_url_origin",
      "start_line": 2692,
      "end_line": 2697,
      "snippet_hash": "5fe1b9cc69e5270454d4b5f175ff7cac73ba844f6f5ac3906eb84940bef065ad",
      "excerpt": "def _url_origin(u: str) -> str:\n    s = str(u or \"\").strip()\n    if not s:\n        return \"\"\n    m = re.match(r\"^(https?://[^/]+)\", s)\n    return (m.group(1) if m else s).rstrip(\"/\")",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:graph_get_service_url",
      "kind": "asyncfunctiondef",
      "name": "graph_get_service_url",
      "start_line": 2700,
      "end_line": 2736,
      "snippet_hash": "3524c2dc476c9d22207f3c24eba208eee1031384de83ba226cf1ee18653fdb73",
      "excerpt": "async def graph_get_service_url(service_id: str, fallback_url: str) -> str:\n    \"\"\"\n    Resolve runtime service URL from graph (Service/APIEndpoint) with cached fallback.\n    \"\"\"\n    sid = str(service_id or \"\").strip().lower()\n    fb = str(",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:graph_service_drift_snapshot",
      "kind": "asyncfunctiondef",
      "name": "graph_service_drift_snapshot",
      "start_line": 2739,
      "end_line": 2775,
      "snippet_hash": "f6b98298b30ab57cf8acc926f28325080370e96f9acdac7e90ab5c140f108814",
      "excerpt": "async def graph_service_drift_snapshot() -> Dict[str, Any]:\n    \"\"\"\n    Compare graph desired URLs vs runtime configured URLs.\n    \"\"\"\n    mapping = {\n        \"rasa_nlu\": RASA_URL,\n        \"rasa_actions\": RASA_ACTIONS_URL,\n        \"parlai_n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:lifespan",
      "kind": "asyncfunctiondef",
      "name": "lifespan",
      "start_line": 2782,
      "end_line": 3470,
      "snippet_hash": "69371b82f3896dcc82de8fefff95e21159a0ac8841b93a8e7415d8da4c9f4bb7",
      "excerpt": "async def lifespan(app: FastAPI):\n    global redis_client, neo4j_driver, neo4j_async_driver, http_client, connect_plugin, constitution, secrets_backend, pg_memory, context_memory, _scheduler_task, _proactive_task, _graph_reconciler_task\n\n  ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_scheduler_loop",
      "kind": "asyncfunctiondef",
      "name": "_scheduler_loop",
      "start_line": 3186,
      "end_line": 3306,
      "snippet_hash": "1b28336dc328c75fb9a9997c934b5dd1ca8569eb1e3b930e6911807490290ded",
      "excerpt": "            async def _scheduler_loop():\n                while True:\n                    try:\n                        due = await scheduler.due(limit=20)\n                        for task in due or []:\n                            task_key = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_proactive_loop",
      "kind": "asyncfunctiondef",
      "name": "_proactive_loop",
      "start_line": 3335,
      "end_line": 3374,
      "snippet_hash": "20c20d4b88456ca3de05db655ccbb728763a5db6c5119496d3932af266f54ba2",
      "excerpt": "            async def _proactive_loop():\n                urls = {\n                    \"persona\": f\"http://127.0.0.1:{PERSONA_PORT}/health\",\n                    \"rasa\": f\"{RASA_URL}/\",\n                    \"swarm\": f\"{SWARM_SERVICE_URL}/healt",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:serve_ui",
      "kind": "asyncfunctiondef",
      "name": "serve_ui",
      "start_line": 3512,
      "end_line": 3516,
      "snippet_hash": "5b043d675df3bdb4c7a2db6c5d25096ccec161ea3737d8213ca8ee7132b4f913",
      "excerpt": "        async def serve_ui():\n            idx = FRONT_DIST / \"index.html\"\n            if idx.is_file():\n                return FileResponse(str(idx))\n            raise HTTPException(status_code=404, detail=\"UI not built\")",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:ide_embed",
      "kind": "asyncfunctiondef",
      "name": "ide_embed",
      "start_line": 3529,
      "end_line": 3556,
      "snippet_hash": "efae03eb2a036ba26bc3488826f38636768fbf68f9aaa3409da8a10afb4a71df",
      "excerpt": "async def ide_embed():\n    target = _IDE_URL or \"http://localhost:3030\"\n    html = f\"\"\"\n    <!doctype html>\n    <html>\n      <head>\n        <meta charset='utf-8'>\n        <title>Denis IDE</title>\n        <style>\n          html, body, iframe",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:ConversationRequest",
      "kind": "classdef",
      "name": "ConversationRequest",
      "start_line": 3628,
      "end_line": 3635,
      "snippet_hash": "f4f9095e05c2345eb8b02a4b65a237854758543ee9be6ddc262752d8005d63c8",
      "excerpt": "class ConversationRequest(BaseModel):\n    text: str\n    user_id: str = \"Jotah\"\n    session_id: Optional[str] = None\n    conversation_id: Optional[str] = None\n    language: str = \"es\"\n    voice_mode: bool = False\n    context: Dict[str, Any] ",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:ConversationResponse",
      "kind": "classdef",
      "name": "ConversationResponse",
      "start_line": 3638,
      "end_line": 3651,
      "snippet_hash": "2da78c24f30fb54dca720d3c44a87b7891f404114a4ba138460f4c01d26f1e5a",
      "excerpt": "class ConversationResponse(BaseModel):\n    text: str\n    intent: str\n    confidence: float\n    entities: List[Dict[str, Any]]\n    session_id: str\n    trace_id: str\n    source: str\n    latency_ms: float\n    swarm_model: Optional[str] = None\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:CoTFeedbackRequest",
      "kind": "classdef",
      "name": "CoTFeedbackRequest",
      "start_line": 3654,
      "end_line": 3657,
      "snippet_hash": "ff49d9bc2df6af9c92464fd01a2ecc35e8ee50f92395e09ae5736473b542b52f",
      "excerpt": "class CoTFeedbackRequest(BaseModel):\n    trace_id: str = Field(..., description=\"trace_id of the turn to rate\")\n    rating: int = Field(..., description=\"+1 (good) or -1 (bad)\")\n    notes: str = Field(\"\", description=\"Optional feedback note",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:MemoryStoreRequest",
      "kind": "classdef",
      "name": "MemoryStoreRequest",
      "start_line": 3660,
      "end_line": 3675,
      "snippet_hash": "eb746662dbb22bf3cc2eb21f953044fa95f9c86eac43fec857744628e186483c",
      "excerpt": "class MemoryStoreRequest(BaseModel):\n    \"\"\"\n    Generic memory ingestion endpoint (used by Rasa Actions + internal subsystems).\n    Layer is a free-form key (we also attempt to map it to the 12-layer model).\n    \"\"\"\n\n    user_id: str\n    s",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:MemoryStoreResponse",
      "kind": "classdef",
      "name": "MemoryStoreResponse",
      "start_line": 3678,
      "end_line": 3682,
      "snippet_hash": "2f927f1ad926eeabe55db2e6feeeafec3caaa3b62555e90b1ec95cf1080ffd84",
      "excerpt": "class MemoryStoreResponse(BaseModel):\n    ok: bool\n    memory_id: Optional[str] = None\n    session_id: Optional[str] = None\n    trace_id: Optional[str] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:HealthResponse",
      "kind": "classdef",
      "name": "HealthResponse",
      "start_line": 3685,
      "end_line": 3691,
      "snippet_hash": "f5fa3ada5702741d0e18186c1b02c96ab5f4c21b3201502efbc8bf471b29ccf8",
      "excerpt": "class HealthResponse(BaseModel):\n    status: str\n    version: str\n    timestamp: str\n    components: Dict[str, Any]\n    uptime_seconds: float\n    trace_id: str",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:RegisterRequest",
      "kind": "classdef",
      "name": "RegisterRequest",
      "start_line": 3697,
      "end_line": 3702,
      "snippet_hash": "a1a48894dafcee2c7a50a6f90e4e931c5334501a283dd6371761516ce9d3560b",
      "excerpt": "class RegisterRequest(BaseModel):\n    email: str\n    username: str\n    password: str\n    display_name: Optional[str] = None\n    org_slug: Optional[str] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:LoginRequest",
      "kind": "classdef",
      "name": "LoginRequest",
      "start_line": 3705,
      "end_line": 3707,
      "snippet_hash": "2d82d9f47508ba9803ba705c0813bfc7cd9737a5dda4f849a5c7ccbbb987be7d",
      "excerpt": "class LoginRequest(BaseModel):\n    email: str\n    password: str",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:RefreshRequest",
      "kind": "classdef",
      "name": "RefreshRequest",
      "start_line": 3710,
      "end_line": 3711,
      "snippet_hash": "5cfce4c27b66aeea19e71908ce8958d64d6639b1781db4d117d67fbf6d9d27d1",
      "excerpt": "class RefreshRequest(BaseModel):\n    refresh_token: str",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:NextcloudLoginRequest",
      "kind": "classdef",
      "name": "NextcloudLoginRequest",
      "start_line": 3714,
      "end_line": 3715,
      "snippet_hash": "4642ba053451f505b965ab0d8bc3097569efa5766f1139b06e40f6ffa4d91f01",
      "excerpt": "class NextcloudLoginRequest(BaseModel):\n    nextcloud_token: str",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:CreateAPIKeyRequest",
      "kind": "classdef",
      "name": "CreateAPIKeyRequest",
      "start_line": 3718,
      "end_line": 3721,
      "snippet_hash": "0ae5036759ff730934426473a40a89c422cea90de607bf43c9bff647f6e56ff9",
      "excerpt": "class CreateAPIKeyRequest(BaseModel):\n    name: str\n    scopes: List[str]\n    expires_in_days: Optional[int] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:UserResponse",
      "kind": "classdef",
      "name": "UserResponse",
      "start_line": 3724,
      "end_line": 3733,
      "snippet_hash": "7c3116691f272c8aa42f348f860e4cdd8497651c5e75396e89b309498317d4e7",
      "excerpt": "class UserResponse(BaseModel):\n    user_id: str\n    email: str\n    username: str\n    display_name: Optional[str]\n    org_id: Optional[str]\n    roles: List[str]\n    permissions: List[str]\n    preferences: Dict[str, Any]\n    status: str",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:TokenResponse",
      "kind": "classdef",
      "name": "TokenResponse",
      "start_line": 3736,
      "end_line": 3741,
      "snippet_hash": "4e36bf526775ec795ff0d022b9a816fb6b3d19ba11e24e9be013a8c27993cb0d",
      "excerpt": "class TokenResponse(BaseModel):\n    access_token: str\n    refresh_token: str\n    token_type: str\n    expires_in: int\n    user: UserResponse",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:auth_register",
      "kind": "asyncfunctiondef",
      "name": "auth_register",
      "start_line": 3750,
      "end_line": 3767,
      "snippet_hash": "76c515a3b1b518693cdcb66e9c99fdac99253e49ac7ed13bf6dd07e6c8579522",
      "excerpt": "async def auth_register(req: RegisterRequest):\n    if not _HAS_AUTH:\n        raise HTTPException(status_code=501, detail=\"Auth module not available\")\n    auth = await get_auth_manager()\n    # register + auto-login (never log passwords)\n    ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:auth_login",
      "kind": "asyncfunctiondef",
      "name": "auth_login",
      "start_line": 3771,
      "end_line": 3778,
      "snippet_hash": "9fe886571cd7e03265f2594643439f06cfd04dbbd9f1c1994251bca441aa8e18",
      "excerpt": "async def auth_login(req: LoginRequest):\n    if not _HAS_AUTH:\n        raise HTTPException(status_code=501, detail=\"Auth module not available\")\n    auth = await get_auth_manager()\n    try:\n        return await auth.login(req.email, req.pass",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:auth_login_nextcloud",
      "kind": "asyncfunctiondef",
      "name": "auth_login_nextcloud",
      "start_line": 3782,
      "end_line": 3789,
      "snippet_hash": "bb8e4ade0b90fea3fd7a58e52992cad0894f41f12fbb7ce1a6f19635724ef3c5",
      "excerpt": "async def auth_login_nextcloud(req: NextcloudLoginRequest):\n    if not _HAS_AUTH:\n        raise HTTPException(status_code=501, detail=\"Auth module not available\")\n    auth = await get_auth_manager()\n    try:\n        return await auth.login_",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:auth_refresh",
      "kind": "asyncfunctiondef",
      "name": "auth_refresh",
      "start_line": 3793,
      "end_line": 3800,
      "snippet_hash": "3860c7eafe8ccd6778559fbfd8828dbb72a7598f2a12ed469d9a45c1c8fdbac9",
      "excerpt": "async def auth_refresh(req: RefreshRequest):\n    if not _HAS_AUTH:\n        raise HTTPException(status_code=501, detail=\"Auth module not available\")\n    auth = await get_auth_manager()\n    try:\n        return await auth.refresh_access_token(",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:auth_me",
      "kind": "asyncfunctiondef",
      "name": "auth_me",
      "start_line": 3804,
      "end_line": 3816,
      "snippet_hash": "7f77ade477cdfece19a5f2d40806d2052b8687e3fff81bcde6c8c4ce460176e6",
      "excerpt": "async def auth_me(current_user: User = Depends(get_current_user)):\n    # Return a stable shape for UI consumption (no secrets).\n    return {\n        \"user_id\": current_user.user_id,\n        \"email\": current_user.email,\n        \"username\": c",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_sse_ticket_prune",
      "kind": "functiondef",
      "name": "_sse_ticket_prune",
      "start_line": 3826,
      "end_line": 3837,
      "snippet_hash": "9962f714ce6bb811073d3178b52966a8a0faf391cb9c3b3835e8af00ac33ea5b",
      "excerpt": "def _sse_ticket_prune(now_ms: Optional[int] = None) -> None:\n    try:\n        now = int(now_ms or (time.time() * 1000))\n    except Exception:\n        return\n    dead = []\n    for k, v in list(_SSE_TICKETS.items()):\n        exp = int(v.get(\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:auth_sse_ticket",
      "kind": "asyncfunctiondef",
      "name": "auth_sse_ticket",
      "start_line": 3841,
      "end_line": 3868,
      "snippet_hash": "082a1b9623485dff198b5416f07fc6d400d95cc531400e5c75c906926e2739a6",
      "excerpt": "async def auth_sse_ticket(\n    request: Request, current_user: User = Depends(get_current_user)\n):\n    \"\"\"\n    Mint a short-lived ticket for SSE/EventSource clients (which can't set Authorization headers).\n    The ticket is NOT a bearer tok",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_resolve_sse_ticket",
      "kind": "functiondef",
      "name": "_resolve_sse_ticket",
      "start_line": 3871,
      "end_line": 3886,
      "snippet_hash": "9c2252ad3ce5a48eb081e72e67e9b8019ee7273204788460f5530ae95ae13483",
      "excerpt": "def _resolve_sse_ticket(ticket: Optional[str]) -> Optional[Dict[str, Any]]:\n    if not ticket:\n        return None\n    _sse_ticket_prune()\n    t = (ticket or \"\").strip()\n    if not t:\n        return None\n    v = _SSE_TICKETS.get(t)\n    if n",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:APIKeyResponse",
      "kind": "classdef",
      "name": "APIKeyResponse",
      "start_line": 3889,
      "end_line": 3896,
      "snippet_hash": "14cceb96d229166292b76beb55b2de04f29d3876419dc4e2b7e0edbbcaa85f65",
      "excerpt": "class APIKeyResponse(BaseModel):\n    key_id: str\n    name: str\n    key_prefix: str\n    scopes: List[str]\n    created_at: str\n    last_used_at: Optional[str]\n    expires_at: Optional[str]",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:SecretRequest",
      "kind": "classdef",
      "name": "SecretRequest",
      "start_line": 3899,
      "end_line": 3902,
      "snippet_hash": "cf61e4a56b95e5fb132912829b9b5266e6dfd8fdc4eb61b8906fba052f2c1432",
      "excerpt": "class SecretRequest(BaseModel):\n    key: str\n    value: str\n    description: Optional[str] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:SecretResponse",
      "kind": "classdef",
      "name": "SecretResponse",
      "start_line": 3905,
      "end_line": 3910,
      "snippet_hash": "8931c0fd29e8c70594c60415593865866f494b2625ae1f9ec3affedbbdb7e526",
      "excerpt": "class SecretResponse(BaseModel):\n    secret_id: str\n    key: str\n    description: Optional[str]\n    created_at: str\n    expires_at: Optional[str]",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:MusicPlayRequest",
      "kind": "classdef",
      "name": "MusicPlayRequest",
      "start_line": 3916,
      "end_line": 3919,
      "snippet_hash": "cd00852f92d136790fa1819d7cf1ecb79f0639e7dd664258f6be8a2b7ba32002",
      "excerpt": "class MusicPlayRequest(BaseModel):\n    url: str = Field(\n        ..., description=\"Local path (under DENIS_MUSIC_LOCAL_ROOT) or http(s) URL\"\n    )",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:MusicVolumeRequest",
      "kind": "classdef",
      "name": "MusicVolumeRequest",
      "start_line": 3922,
      "end_line": 3923,
      "snippet_hash": "d1d1dff9ceeda20bcab5df026327605fbe731518fa49d04318c1dc10aae2e5cc",
      "excerpt": "class MusicVolumeRequest(BaseModel):\n    volume: float = Field(..., ge=0.0, le=1.0)",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:emit_event",
      "kind": "asyncfunctiondef",
      "name": "emit_event",
      "start_line": 3929,
      "end_line": 3962,
      "snippet_hash": "8b27491197700ef4ba9ec5c6980504e0562312b89374664869d2ebed16601da8",
      "excerpt": "async def emit_event(event_type: str, actor_id: str, payload: Dict[str, Any]):\n    \"\"\"Emit event to Redis pub/sub and persist.\"\"\"\n    event = {\n        \"event_id\": str(uuid.uuid4()),\n        \"type\": event_type,\n        \"source\": \"persona_ca",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_pipecat_should_mirror_local_event",
      "kind": "functiondef",
      "name": "_pipecat_should_mirror_local_event",
      "start_line": 3965,
      "end_line": 3983,
      "snippet_hash": "2c3a6418b61eba213977ce56b046e658eda72cf5d7f9b609d4f79f37cd6a1833",
      "excerpt": "def _pipecat_should_mirror_local_event(event_type: str) -> bool:\n    if DENIS_PIPECAT_ALWAYS_SYNC:\n        return True\n    ev = str(event_type or \"\").strip().lower()\n    if not ev:\n        return False\n    if ev.startswith((\"voice.\", \"assis",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_publish_local_bus_event",
      "kind": "asyncfunctiondef",
      "name": "_publish_local_bus_event",
      "start_line": 3986,
      "end_line": 4015,
      "snippet_hash": "c3de969dc28cf8f7142a140a640d519598083ac3a748b4627009367471cf1393",
      "excerpt": "async def _publish_local_bus_event(\n    session_id: str, user_id: str, event_type: str, data: Dict[str, Any]\n) -> None:\n    \"\"\"\n    Publish to DenisEventBus v2 (used by /v1/events/stream).\n    This is independent from Redis pubsub emit_even",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:pipecat_emit_event",
      "kind": "asyncfunctiondef",
      "name": "pipecat_emit_event",
      "start_line": 4018,
      "end_line": 4097,
      "snippet_hash": "529df568c4b576c52b1d30cf9b5b7694fdf6ae8ff65e99035a6d20b9f07ba3b8",
      "excerpt": "async def pipecat_emit_event(\n    event_type: str,\n    payload: Dict[str, Any],\n    *,\n    session_id: str = \"\",\n    user_id: str = \"\",\n    trace_id_val: str = \"\",\n) -> bool:\n    \"\"\"\n    Best-effort sync of conversation/runtime events to Pi",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_identity_person_name",
      "kind": "functiondef",
      "name": "_identity_person_name",
      "start_line": 4100,
      "end_line": 4106,
      "snippet_hash": "a270229589ea973fb7855e62d95ca523aa965f1a1088530c41d74469861619a0",
      "excerpt": "def _identity_person_name(user_id: str) -> str:\n    uid = str(user_id or \"\").strip()\n    if not uid:\n        return \"Usuario\"\n    if _is_uuid(uid):\n        return \"Usuario\"\n    return uid[:80]",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:identity_core_sync_interaction",
      "kind": "asyncfunctiondef",
      "name": "identity_core_sync_interaction",
      "start_line": 4109,
      "end_line": 4155,
      "snippet_hash": "489a95864857fa77e4155009d3d233b26e3fe69292497084510d09cf3e6d90e1",
      "excerpt": "async def identity_core_sync_interaction(\n    *,\n    user_id: str,\n    message: str,\n    session_id: str,\n    trace_id_val: str,\n    intent: str,\n    confidence: float,\n    entities: Optional[List[Dict[str, Any]]] = None,\n    extras: Option",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:identity_core_record_event",
      "kind": "asyncfunctiondef",
      "name": "identity_core_record_event",
      "start_line": 4158,
      "end_line": 4191,
      "snippet_hash": "3dc9dc5abdfdccd52219820933c8d0adea66808af2a23da6c249b260f2d9a672",
      "excerpt": "async def identity_core_record_event(\n    *,\n    user_id: str,\n    event_type: str,\n    description: str,\n    tags: Optional[List[str]] = None,\n    importance: float = 0.55,\n    emotional_valence: float = 0.0,\n) -> bool:\n    \"\"\"\n    Record ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_media_state_key",
      "kind": "functiondef",
      "name": "_media_state_key",
      "start_line": 4194,
      "end_line": 4195,
      "snippet_hash": "1d0d5b79aeead9cac93671a534bc966ef1ae6f15d9b10554ea197adb6809b64f",
      "excerpt": "def _media_state_key(session_id: str, user_id: str) -> str:\n    return f\"denis:ui:media:state:{session_id}:{user_id}\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:ui_media_get_state",
      "kind": "asyncfunctiondef",
      "name": "ui_media_get_state",
      "start_line": 4198,
      "end_line": 4208,
      "snippet_hash": "2f44b93f6343dbbd8926bdccecc7eedca6ae3b80d9ad89defeccc5b32fed9772",
      "excerpt": "async def ui_media_get_state(session_id: str, user_id: str) -> Optional[Dict[str, Any]]:\n    if not redis_client:\n        return None\n    try:\n        raw = await redis_client.get(_media_state_key(session_id, user_id))\n        if not raw:\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:ui_media_set_state",
      "kind": "asyncfunctiondef",
      "name": "ui_media_set_state",
      "start_line": 4211,
      "end_line": 4222,
      "snippet_hash": "47718a999e6d99663e92396ec42a22b5f727a33dfee8ac78b06a96059999243b",
      "excerpt": "async def ui_media_set_state(\n    session_id: str, user_id: str, state: Dict[str, Any], ttl_s: int = 60 * 60 * 24 * 7\n) -> None:\n    if not redis_client:\n        return\n    try:\n        dump = json.dumps(state, ensure_ascii=True, separators",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:tool_executor_tools_count",
      "kind": "asyncfunctiondef",
      "name": "tool_executor_tools_count",
      "start_line": 4313,
      "end_line": 4334,
      "snippet_hash": "50b0eb2426918bab3ff41dfeb2bad0a8004ac87cc493ad21afcdb7fcf8cf8b40",
      "excerpt": "async def tool_executor_tools_count() -> int:\n    \"\"\"Best-effort: read the real tool count from tool executor health.\"\"\"\n    now = time.monotonic()\n    cached = _TOOLS_HEALTH_CACHE.get(\"tools_count\")\n    if cached is not None and (\n        ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_get_ocean_traits",
      "kind": "asyncfunctiondef",
      "name": "neo4j_get_ocean_traits",
      "start_line": 4337,
      "end_line": 4390,
      "snippet_hash": "0ff85788a0341d057e1a8bad4560c9f95285080c056483102593d70e7cd4b297",
      "excerpt": "async def neo4j_get_ocean_traits(user_id: str) -> Dict[str, float]:\n    \"\"\"Get OCEAN personality traits from Neo4j graph.\"\"\"\n    uid = str(user_id or \"\").strip().lower() or \"anonymous\"\n    if not neo4j_async_driver:\n        return OCEAN_TRA",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_get_identity",
      "kind": "asyncfunctiondef",
      "name": "neo4j_get_identity",
      "start_line": 4393,
      "end_line": 4449,
      "snippet_hash": "2c88bc7208a992fa93540b3f9a41962e3d843a485fb98f79e6323e0fa9c69cd6",
      "excerpt": "async def neo4j_get_identity() -> Dict[str, Any]:\n    \"\"\"Get Denis identity data from Neo4j graph: layers, tools, capabilities.\"\"\"\n    identity = {\"layers\": [], \"tools_count\": 0, \"capabilities\": [], \"roles\": []}\n    if not neo4j_async_drive",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_get_episodic_memory",
      "kind": "asyncfunctiondef",
      "name": "neo4j_get_episodic_memory",
      "start_line": 4452,
      "end_line": 4500,
      "snippet_hash": "d24e47e189317dd989739b230d47978e62993228edcc362db5009bf8e586b0f6",
      "excerpt": "async def neo4j_get_episodic_memory(user_id: str, current_text: str) -> str:\n    \"\"\"Get relevant episodic memories from past conversations with this user.\"\"\"\n    if not neo4j_async_driver:\n        # Fallback: when Neo4j is offline, use Post",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_extract_concepts",
      "kind": "functiondef",
      "name": "_extract_concepts",
      "start_line": 4577,
      "end_line": 4590,
      "snippet_hash": "6a052f6c1ca9d93776ee73c85781b1bd6ece19c9f11b500370cd9e915169f139",
      "excerpt": "def _extract_concepts(text: str, *, max_terms: int = 8) -> List[str]:\n    \"\"\"Heuristic concept extraction to build (:ConceptNode) links without extra deps.\"\"\"\n    if not text:\n        return []\n    words = re.findall(r\"[A-Za-z0-9_]{4,}\", te",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_persist_turn",
      "kind": "asyncfunctiondef",
      "name": "neo4j_persist_turn",
      "start_line": 4593,
      "end_line": 4695,
      "snippet_hash": "cbf412be4d58f3f63a7abeba6a23669eda019b5c33af46f4dcb39c2f2e3044ea",
      "excerpt": "async def neo4j_persist_turn(\n    session_id: str,\n    user_id: str,\n    user_text: str,\n    response_text: str,\n    intent: str,\n    trace_id_val: str,\n    *,\n    user_text_effective: str = \"\",\n    thinking: str = \"\",\n    confidence_score:",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_memory_schema_spec",
      "kind": "functiondef",
      "name": "_memory_schema_spec",
      "start_line": 4698,
      "end_line": 4815,
      "snippet_hash": "96dccd9929792fb419897f96e56ba822052b245f4d813a06a5474390c56313bd",
      "excerpt": "def _memory_schema_spec() -> Dict[str, Any]:\n    \"\"\"\n    Canonical memory schema spec for Neo4j (stored in-graph for traceability).\n\n    User requirement: two primary domains of memory stored separately:\n    1) relational (people/relationsh",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_ensure_memory_schema",
      "kind": "asyncfunctiondef",
      "name": "neo4j_ensure_memory_schema",
      "start_line": 4818,
      "end_line": 4867,
      "snippet_hash": "f36f3c7a6d237cd453b9aed5393a6540e441dc114aa6f4e610bd646c10632158",
      "excerpt": "async def neo4j_ensure_memory_schema() -> None:\n    \"\"\"Best-effort: ensure constraints/indexes + store schema spec in graph.\"\"\"\n    if not neo4j_async_driver:\n        return\n    try:\n        async with neo4j_async_driver.session() as sessio",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_ensure_conversation_schema",
      "kind": "asyncfunctiondef",
      "name": "neo4j_ensure_conversation_schema",
      "start_line": 4870,
      "end_line": 4911,
      "snippet_hash": "25739b7d717a9ea53205750c583a366a676c924a33eaeccfe44c75ff14da962e",
      "excerpt": "async def neo4j_ensure_conversation_schema() -> None:\n    \"\"\"Best-effort: ensure core conversation/event constraints and indexes.\"\"\"\n    if not neo4j_async_driver:\n        return\n    try:\n        async with neo4j_async_driver.session() as s",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_ensure_cognitive_schema",
      "kind": "asyncfunctiondef",
      "name": "neo4j_ensure_cognitive_schema",
      "start_line": 4914,
      "end_line": 4983,
      "snippet_hash": "0adb02b06c812928ecc28d121e9cc4b27cd81d0b4a908e5370b19bf04abb1e5e",
      "excerpt": "async def neo4j_ensure_cognitive_schema() -> None:\n    \"\"\"Best-effort: ensure cognitive loop schema (4-loop + 12-layer links).\"\"\"\n    if not neo4j_async_driver:\n        return\n    try:\n        async with neo4j_async_driver.session() as sess",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_ensure_graphfirst_schema",
      "kind": "asyncfunctiondef",
      "name": "neo4j_ensure_graphfirst_schema",
      "start_line": 4986,
      "end_line": 5076,
      "snippet_hash": "c0d9323377f6ceb434b71146d622ed41f884901f0100089693ed00378adfa012",
      "excerpt": "async def neo4j_ensure_graphfirst_schema() -> None:\n    \"\"\"\n    Compatibility layer for graph-first cognition contracts expected by Denis:\n    - (:Persona)-[:HAS_TRAIT]->(:Trait)\n    - (:Persona)-[:MODELS_USER]->(:UserMindModel)\n    - (:Tur",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_persist_mental_control",
      "kind": "asyncfunctiondef",
      "name": "neo4j_persist_mental_control",
      "start_line": 5079,
      "end_line": 5275,
      "snippet_hash": "f27d335e8ebec6eb2e59eb5bf1b4cd46ee035423bfb545d8cd471638949c081c",
      "excerpt": "async def neo4j_persist_mental_control(\n    *,\n    session_id: str,\n    user_id: str,\n    trace_id_val: str,\n    intent: str,\n    task_type: str,\n    mental_control: Dict[str, Any],\n    cot_control: Optional[Dict[str, Any]],\n    nlu_confide",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_redact_sensitive",
      "kind": "functiondef",
      "name": "_redact_sensitive",
      "start_line": 5289,
      "end_line": 5315,
      "snippet_hash": "88498fe1daadc6648e12109108e7e438eab1f19f958e21ec9689edd4657fbacb",
      "excerpt": "def _redact_sensitive(obj: Any, *, _depth: int = 0) -> Any:\n    \"\"\"\n    Best-effort redaction for proposal payloads. This prevents accidental storage of secrets\n    inside ChangeProposal.plan_json / description.\n    \"\"\"\n    if _depth > 6:\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_ensure_proposals_schema",
      "kind": "asyncfunctiondef",
      "name": "neo4j_ensure_proposals_schema",
      "start_line": 5318,
      "end_line": 5339,
      "snippet_hash": "504c40a7cdae904b85443be0b30bba2a4184fa3ecb98dd650e45c9c30f8f08c2",
      "excerpt": "async def neo4j_ensure_proposals_schema() -> None:\n    \"\"\"Best-effort: ensure ChangeProposal constraints/indexes exist.\"\"\"\n    if not neo4j_async_driver:\n        return\n    try:\n        async with neo4j_async_driver.session() as session:\n  ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_ensure_graph_contract_v1",
      "kind": "asyncfunctiondef",
      "name": "neo4j_ensure_graph_contract_v1",
      "start_line": 5342,
      "end_line": 5378,
      "snippet_hash": "74757de4f76d9ff52318110a8ce9d9418a7608f560ec04e5dd170b0dbb7916e4",
      "excerpt": "async def neo4j_ensure_graph_contract_v1() -> None:\n    \"\"\"\n    Graph Contract v1 baseline:\n    Service, APIEndpoint, Intent, Tool, RoutePolicy, Turn, Event, Memory, ChangeProposal.\n    \"\"\"\n    if not neo4j_async_driver:\n        return\n    ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_seed_runtime_service_catalog",
      "kind": "asyncfunctiondef",
      "name": "neo4j_seed_runtime_service_catalog",
      "start_line": 5381,
      "end_line": 5434,
      "snippet_hash": "35f020dbecb95102c31f3952f951e9bdac3c9743975f95f25d1dcbaea09304ea",
      "excerpt": "async def neo4j_seed_runtime_service_catalog() -> None:\n    \"\"\"Keep desired runtime endpoints in graph (Service/APIEndpoint).\"\"\"\n    if not neo4j_async_driver:\n        return\n    rows = [\n        (\"persona\", f\"http://127.0.0.1:{PERSONA_PORT",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_seed_intent_tool_routes",
      "kind": "asyncfunctiondef",
      "name": "neo4j_seed_intent_tool_routes",
      "start_line": 5437,
      "end_line": 5488,
      "snippet_hash": "21b201a59fb33ba2d37e1ddd5939164348f819b14854343e09621097ef6b9f16",
      "excerpt": "async def neo4j_seed_intent_tool_routes() -> None:\n    \"\"\"\n    Persist Intent->Tool routing policy in graph and keep it auditable.\n    \"\"\"\n    if not neo4j_async_driver:\n        return\n    try:\n        async with neo4j_async_driver.session(",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_refresh_intent_tool_routes_to_runtime",
      "kind": "asyncfunctiondef",
      "name": "neo4j_refresh_intent_tool_routes_to_runtime",
      "start_line": 5491,
      "end_line": 5516,
      "snippet_hash": "5dd13427c3af586975cd30f3bbc61cbd8f7fefac202b2aab61f2bc18079482d8",
      "excerpt": "async def neo4j_refresh_intent_tool_routes_to_runtime() -> int:\n    \"\"\"\n    Pull graph policy into runtime map (INTENT_TO_TOOL) to avoid hardcoded-only routing.\n    \"\"\"\n    if not neo4j_async_driver:\n        return 0\n    applied = 0\n    try",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_reconcile_turns",
      "kind": "asyncfunctiondef",
      "name": "neo4j_reconcile_turns",
      "start_line": 5519,
      "end_line": 5594,
      "snippet_hash": "13463dc8310478c649376b3d1b1aface0457249c15e20e976dfd3eee39252160",
      "excerpt": "async def neo4j_reconcile_turns() -> Dict[str, int]:\n    if not neo4j_async_driver:\n        return {}\n    out = {\"turn_total\": 0, \"turn_missing_core\": 0}\n    try:\n        async with neo4j_async_driver.session() as session:\n            await",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_reconcile_events",
      "kind": "asyncfunctiondef",
      "name": "neo4j_reconcile_events",
      "start_line": 5597,
      "end_line": 5656,
      "snippet_hash": "ad804bc8b5552bb358650b908dbf73ce7b3ddae7b4ab03ee2ee81dadefac9f07",
      "excerpt": "async def neo4j_reconcile_events() -> Dict[str, int]:\n    if not neo4j_async_driver:\n        return {}\n    out = {\"event_total\": 0, \"event_missing_uid\": 0, \"event_id_duplicates\": 0}\n    try:\n        async with neo4j_async_driver.session() a",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_reconcile_memory",
      "kind": "asyncfunctiondef",
      "name": "neo4j_reconcile_memory",
      "start_line": 5659,
      "end_line": 5720,
      "snippet_hash": "32cfa0bfcb9ce763c356a23308c29f3b3f43a53a504811d9e3162940a15be6b0",
      "excerpt": "async def neo4j_reconcile_memory() -> Dict[str, int]:\n    if not neo4j_async_driver:\n        return {}\n    out = {\"technical_memory_nonempty\": 0, \"technical_about_project\": 0}\n    try:\n        async with neo4j_async_driver.session() as sess",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_reconcile_graphroute_coverage",
      "kind": "asyncfunctiondef",
      "name": "neo4j_reconcile_graphroute_coverage",
      "start_line": 5723,
      "end_line": 5810,
      "snippet_hash": "ba8460a85c00994d21bdd24de74ea8b44b40bfad08f8bfc6b81d5dd07f25d94e",
      "excerpt": "async def neo4j_reconcile_graphroute_coverage() -> Dict[str, int]:\n    if not neo4j_async_driver:\n        return {}\n    out = {\"turn_total\": 0, \"turn_with_graphroute\": 0}\n    try:\n        async with neo4j_async_driver.session() as session:\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_collect_graph_kpis",
      "kind": "asyncfunctiondef",
      "name": "neo4j_collect_graph_kpis",
      "start_line": 5813,
      "end_line": 5936,
      "snippet_hash": "40e8e27fa07625fb8d17e7cfa99fafe2ee49c83760335b1289ea48b9fe8f9a4a",
      "excerpt": "async def neo4j_collect_graph_kpis() -> Dict[str, Any]:\n    if not neo4j_async_driver:\n        return {\"ok\": False, \"reason\": \"neo4j_offline\"}\n    out: Dict[str, Any] = {}\n    try:\n        async with neo4j_async_driver.session() as session:",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:pct",
      "kind": "functiondef",
      "name": "pct",
      "start_line": 5886,
      "end_line": 5887,
      "snippet_hash": "b1a9b927c341c84f8d7e7bb2bfe8102069d955dcaca34117e474dffa5329a5a9",
      "excerpt": "            def pct(num: int, den: int) -> float:\n                return round((float(num) / float(den) * 100.0), 2) if den > 0 else 0.0",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_run_reconcilers_once",
      "kind": "asyncfunctiondef",
      "name": "neo4j_run_reconcilers_once",
      "start_line": 5939,
      "end_line": 5957,
      "snippet_hash": "0182855d853a214a41361bab110b9c701c5b655ed552b6697d20c998dfe3db2d",
      "excerpt": "async def neo4j_run_reconcilers_once(reason: str = \"manual\") -> Dict[str, Any]:\n    \"\"\"\n    A/B/C/D reconcilers:\n    A Turn orphan repair\n    B Event backfill/dedupe\n    C Memory normalization\n    D GraphRoute coverage\n    \"\"\"\n    turn = aw",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_graph_reconciler_loop",
      "kind": "asyncfunctiondef",
      "name": "_graph_reconciler_loop",
      "start_line": 5960,
      "end_line": 5975,
      "snippet_hash": "ecffa1a8cc5a53ea1ce97acbecd3e49fbdd535826d3d1bd53f1a33c7785d83a4",
      "excerpt": "async def _graph_reconciler_loop() -> None:\n    while True:\n        try:\n            report = await neo4j_run_reconcilers_once(reason=\"scheduler\")\n            await neo4j_refresh_intent_tool_routes_to_runtime()\n            kpis = await neo4",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_upsert_change_proposal",
      "kind": "asyncfunctiondef",
      "name": "neo4j_upsert_change_proposal",
      "start_line": 5978,
      "end_line": 6066,
      "snippet_hash": "3aa1b0d17e40a1612c4860bafd5d984ee96908c0585fd3be3d388653aea26fa2",
      "excerpt": "async def neo4j_upsert_change_proposal(\n    *,\n    proposal_key: str,\n    title: str,\n    description: str,\n    risk: str,\n    rollback: str,\n    plan: Dict[str, Any],\n    user_id: str,\n    session_id: Optional[str],\n    trace_id_val: Optio",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_list_change_proposals",
      "kind": "asyncfunctiondef",
      "name": "neo4j_list_change_proposals",
      "start_line": 6069,
      "end_line": 6097,
      "snippet_hash": "fb337c075901dbc8297df63751d04b052d289456823ed68063714ca7db93812f",
      "excerpt": "async def neo4j_list_change_proposals(\n    *,\n    status: str,\n    user_id: Optional[str],\n    limit: int = 50,\n) -> List[Dict[str, Any]]:\n    if not neo4j_async_driver:\n        raise RuntimeError(\"Neo4j offline\")\n    st = (status or \"pendi",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_set_proposal_status",
      "kind": "asyncfunctiondef",
      "name": "neo4j_set_proposal_status",
      "start_line": 6100,
      "end_line": 6134,
      "snippet_hash": "a91cc635c56c73628f78f69573ce3bc4fd1c3f2c54e627de31f60a841a3bd969",
      "excerpt": "async def neo4j_set_proposal_status(\n    *,\n    proposal_id: str,\n    status: str,\n    decided_by: str,\n    note: str = \"\",\n) -> Dict[str, Any]:\n    if not neo4j_async_driver:\n        raise RuntimeError(\"Neo4j offline\")\n    st = (status or ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_criticality_from_importance",
      "kind": "functiondef",
      "name": "_criticality_from_importance",
      "start_line": 6137,
      "end_line": 6150,
      "snippet_hash": "e25cdc865bb9eded27b2e3ba4df92dadb099d954466ced86505f785856dc81a1",
      "excerpt": "def _criticality_from_importance(score: float) -> str:\n    try:\n        s = float(score)\n    except Exception:\n        s = 0.5\n    if s >= 0.9:\n        return \"critical\"\n    if s >= 0.75:\n        return \"high\"\n    if s >= 0.55:\n        retu",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_quantization_strategy_for",
      "kind": "functiondef",
      "name": "_quantization_strategy_for",
      "start_line": 6153,
      "end_line": 6163,
      "snippet_hash": "2f8ea9f9d66fdc84ec563b333fc525df15160dee2c9686d3c28ffc5e00d949ec",
      "excerpt": "def _quantization_strategy_for(criticality: str) -> str:\n    c = (criticality or \"\").strip().lower()\n    if c == \"critical\":\n        return \"none\"\n    if c == \"high\":\n        return \"light\"\n    if c == \"medium\":\n        return \"medium\"\n    ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_compression_strategy_for",
      "kind": "functiondef",
      "name": "_compression_strategy_for",
      "start_line": 6166,
      "end_line": 6174,
      "snippet_hash": "9fbeac3878d30c17b4853ad2ada19a524ece06f2683edc7902d7aa5dc8022ea8",
      "excerpt": "def _compression_strategy_for(layer_id: int, domain: str) -> str:\n    # Keep procedural/code/identity/goals readable and diffable.\n    if int(layer_id) in (5, 6, 9, 11, 12):\n        return \"none\"\n    if (domain or \"\").strip().lower() == \"re",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_looks_like_uuid",
      "kind": "functiondef",
      "name": "_looks_like_uuid",
      "start_line": 6182,
      "end_line": 6186,
      "snippet_hash": "e4c0a2790f20dce2984971086a83e95c472b692c3bf09e5b277284b8f3ff8738",
      "excerpt": "def _looks_like_uuid(s: str) -> bool:\n    try:\n        return bool(_UUID_RE.match((s or \"\").strip()))\n    except Exception:\n        return False",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_chunk_text_for_graph",
      "kind": "functiondef",
      "name": "_chunk_text_for_graph",
      "start_line": 6189,
      "end_line": 6211,
      "snippet_hash": "11f1d04da3153ea13bb9c1068ec7cb3775f7d566720d3ef44855acbeb601fe53",
      "excerpt": "def _chunk_text_for_graph(text: str, max_chars: int = 700) -> List[Dict[str, Any]]:\n    t = (text or \"\").strip()\n    if not t:\n        return []\n    # Simple, deterministic chunking: keeps Cypher payload bounded.\n    chunks: List[Dict[str, ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_infer_memory_domain",
      "kind": "functiondef",
      "name": "_infer_memory_domain",
      "start_line": 6214,
      "end_line": 6240,
      "snippet_hash": "d276f4b2831cc78bba6101d658afecfdf3e0ac67fe181d49f5bcdfe9041549a0",
      "excerpt": "def _infer_memory_domain(layer: str, data: Dict[str, Any]) -> str:\n    l = (layer or \"\").strip().lower()\n    if any(\n        k in l for k in (\"relational\", \"persona\", \"relationship\", \"people\", \"person\")\n    ):\n        return \"relational\"\n  ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_map_layer_to_memos_layer",
      "kind": "functiondef",
      "name": "_map_layer_to_memos_layer",
      "start_line": 6243,
      "end_line": 6266,
      "snippet_hash": "baf91fc5d196f9ff242082c258658b268af9d30e0509514284d72705d4f887df",
      "excerpt": "def _map_layer_to_memos_layer(layer: str) -> Tuple[int, str]:\n    \"\"\"\n    Map free-form layer keys into the 12-layer model (best-effort).\n    We store both layer_id and layer_name in graph for consistent querying.\n    \"\"\"\n    raw = (layer o",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_format_memory_summary",
      "kind": "functiondef",
      "name": "_format_memory_summary",
      "start_line": 6269,
      "end_line": 6325,
      "snippet_hash": "f9a60b34fb6b8909b82aaef9823c1dda9e9efac04ffcbc20f119417d0c1da76e",
      "excerpt": "def _format_memory_summary(\n    domain: str, subtype: str, data: Dict[str, Any]\n) -> Tuple[str, str, List[str], List[str], str]:\n    \"\"\"\n    Returns (summary, content, tags, person_names, project_name).\n    Keep summary short; content may b",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_persist_memories",
      "kind": "asyncfunctiondef",
      "name": "neo4j_persist_memories",
      "start_line": 6328,
      "end_line": 6475,
      "snippet_hash": "f22fd8a7fe94b7e5249ef23b1875986178a10c85ce757877f76ada6703dcc73d",
      "excerpt": "async def neo4j_persist_memories(\n    *,\n    user_id: str,\n    session_id: str,\n    trace_id_val: str,\n    memories: List[Dict[str, Any]],\n) -> bool:\n    \"\"\"\n    Persist Memory nodes in Neo4j and attach them to Denis Persona (YO), the User,",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:rag_get_context",
      "kind": "asyncfunctiondef",
      "name": "rag_get_context",
      "start_line": 6478,
      "end_line": 6561,
      "snippet_hash": "e7369ba85b4cb663b1e69b109521c77bacba4d6929ad66e298bf484d673ddb59",
      "excerpt": "async def rag_get_context(query: str, task_type: str = \"dialog\", top_k: int = 3) -> str:\n    \"\"\"Query Qdrant collections for relevant context via RAG.\n    Returns formatted context string for injection into LLM prompt.\"\"\"\n    contexts = []\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_search_one",
      "kind": "asyncfunctiondef",
      "name": "_search_one",
      "start_line": 6509,
      "end_line": 6538,
      "snippet_hash": "c69ff007729dfa7efc36c42fe6c01e3ffa72230c6746608c14025ea3a6799b2a",
      "excerpt": "        async def _search_one(coll_key: str, coll_name: str) -> List[str]:\n            try:\n                search_resp = await client.post(\n                    f\"{QDRANT_URL}/collections/{coll_name}/points/search\",\n                    json",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:validate_communication_claim",
      "kind": "asyncfunctiondef",
      "name": "validate_communication_claim",
      "start_line": 6564,
      "end_line": 6603,
      "snippet_hash": "5bf433d40fb7de22510d442dcb45f8b779777c635a6b523c9f2fd0a645f8e325",
      "excerpt": "async def validate_communication_claim(\n    claim: str, context: Dict[str, Any]\n) -> Dict[str, Any]:\n    \"\"\"\n    CONSTITUTION ENFORCEMENT: Validate any claim about system status before communication.\n\n    REGLA CONSTITUCIONAL: Toda afirmaci",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:constitution_enforced_response",
      "kind": "asyncfunctiondef",
      "name": "constitution_enforced_response",
      "start_line": 6606,
      "end_line": 6644,
      "snippet_hash": "e1469f70cbcfd1f5fc1c24df11e5d72fd24bbc9aa3848d93dad463246435e09b",
      "excerpt": "async def constitution_enforced_response(\n    original_response: str, context: Dict[str, Any]\n) -> str:\n    \"\"\"\n    CONSTITUTION ENFORCEMENT: Filter and modify responses to ensure constitutional compliance.\n\n    Si la respuesta contiene afi",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_or_create_session",
      "kind": "asyncfunctiondef",
      "name": "get_or_create_session",
      "start_line": 6650,
      "end_line": 6669,
      "snippet_hash": "c53d561846f4f6cc0798a4e57c06a6ff373e36fbf031bb6bcf1d555430c7dfdf",
      "excerpt": "async def get_or_create_session(session_id: Optional[str], user_id: str) -> str:\n    \"\"\"Get or create a session, return session_id.\"\"\"\n    if not session_id:\n        session_id = f\"ses_{uuid.uuid4().hex[:12]}\"\n    if redis_client:\n        k",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_session_context",
      "kind": "asyncfunctiondef",
      "name": "get_session_context",
      "start_line": 6672,
      "end_line": 6681,
      "snippet_hash": "78a770c466b342bbb07744a7ec52167196f91110bfc46f790e4a1db92d0d113b",
      "excerpt": "async def get_session_context(session_id: str) -> Dict[str, Any]:\n    \"\"\"Get session context (last N turns) from Redis.\"\"\"\n    if not redis_client:\n        return {}\n    key = f\"denis:session:{session_id}:history\"\n    try:\n        history =",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_session_history",
      "kind": "asyncfunctiondef",
      "name": "get_session_history",
      "start_line": 6684,
      "end_line": 6699,
      "snippet_hash": "e0a47e7edae790bed42b48f035dcdcfd18970d63517985df2413c0fecd5574d0",
      "excerpt": "async def get_session_history(session_id: str, limit: int = 20) -> List[Dict[str, Any]]:\n    \"\"\"Get up to `limit` recent turns from Redis (most recent first).\"\"\"\n    if not redis_client:\n        return []\n    key = f\"denis:session:{session_",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:save_turn_to_session",
      "kind": "asyncfunctiondef",
      "name": "save_turn_to_session",
      "start_line": 6702,
      "end_line": 6722,
      "snippet_hash": "9e9e4652c3d89916a9a2cfaea896acb8487e7a8c82f5d86ddfa134bb475f0558",
      "excerpt": "async def save_turn_to_session(\n    session_id: str, user_text: str, response_text: str, intent: str\n):\n    \"\"\"Save turn to session history in Redis.\"\"\"\n    if not redis_client:\n        return\n    key = f\"denis:session:{session_id}:history\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_nlu_intent_is_unknown",
      "kind": "functiondef",
      "name": "_nlu_intent_is_unknown",
      "start_line": 6738,
      "end_line": 6739,
      "snippet_hash": "b332edda5d6681cd21783b6d36564c74366412eedb41c713c4b83d439d8b8375",
      "excerpt": "def _nlu_intent_is_unknown(intent: Any) -> bool:\n    return str(intent or \"\").strip().lower() in _NLU_UNKNOWN_LABELS",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:rasa_parse",
      "kind": "asyncfunctiondef",
      "name": "rasa_parse",
      "start_line": 6742,
      "end_line": 6771,
      "snippet_hash": "3dd1f011b873bd324c893d23b94e9b45639ed2952878eed980fb113b02b62c10",
      "excerpt": "async def rasa_parse(text: str) -> Dict[str, Any]:\n    \"\"\"Call Rasa NLU for intent/entity extraction. Returns real NLU result.\"\"\"\n    try:\n        rasa_base = await graph_get_service_url(\"rasa_nlu\", RASA_URL)\n        resp = await http_clien",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:parlai_nlu_parse",
      "kind": "asyncfunctiondef",
      "name": "parlai_nlu_parse",
      "start_line": 6814,
      "end_line": 6864,
      "snippet_hash": "224af4345ef54de5d94f3e9afc0b67012ec7ef818e92540a5d4fd0e7bbb01cb2",
      "excerpt": "async def parlai_nlu_parse(text: str) -> Dict[str, Any]:\n    \"\"\"\n    Call ParlAI NLU (Rasa-compatible /model/parse).\n\n    ParlAI runs in parallel with Rasa:\n    - provides dialog-act + emotional/relational signals\n    - provides resilience ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:oceanai_nlu_parse",
      "kind": "asyncfunctiondef",
      "name": "oceanai_nlu_parse",
      "start_line": 6867,
      "end_line": 6920,
      "snippet_hash": "211258a030f347eeb0774e4d86a14731a81f17d75af1fc89aa98192b737dd6cc",
      "excerpt": "async def oceanai_nlu_parse(text: str) -> Dict[str, Any]:\n    \"\"\"\n    Second parser from OceanAI canonical (9999) to complement Persona local parsing.\n    \"\"\"\n    if not DENIS_OCEANAI_SECOND_PARSE_ENABLED:\n        return {\n            \"inte",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:nlu_parse",
      "kind": "asyncfunctiondef",
      "name": "nlu_parse",
      "start_line": 6923,
      "end_line": 7089,
      "snippet_hash": "00ded3ccbe3815622cf18759283800cdabe6281f9b106338321859af594c0e53",
      "excerpt": "async def nlu_parse(text: str) -> Dict[str, Any]:\n    \"\"\"\n    Run 2-stage parsing in parallel:\n    - Local parser set (Rasa + ParlAI) in 8084\n    - OceanAI canonical parser (9999) as second opinion\n    - Rasa dominates technical/macro routi",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_intent_valid",
      "kind": "functiondef",
      "name": "_intent_valid",
      "start_line": 7016,
      "end_line": 7017,
      "snippet_hash": "fecaa0ab20386512ea9774c5cd34d80061cdf77f2c04be880da4f75c38da6aa4",
      "excerpt": "    def _intent_valid(v: str) -> bool:\n        return not _nlu_intent_is_unknown(v)",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_graph_watcher_snapshot",
      "kind": "asyncfunctiondef",
      "name": "neo4j_graph_watcher_snapshot",
      "start_line": 7092,
      "end_line": 7230,
      "snippet_hash": "49d6c642985ff1088b33e834535091565ce337627d385c09ab64383668c12f45",
      "excerpt": "async def neo4j_graph_watcher_snapshot(user_id: str, text: str) -> Dict[str, Any]:\n    \"\"\"\n    Graph-first watcher.\n    Reads user-centric intent/task history from Neo4j and emits candidate intents.\n    \"\"\"\n    concepts = _extract_concepts(",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:graph_expert_votes",
      "kind": "functiondef",
      "name": "graph_expert_votes",
      "start_line": 7233,
      "end_line": 7337,
      "snippet_hash": "a36ee461fef2bbff1e91ce8cb912e6a5b9d788fc61dca2790d4d165ded0fa2f0",
      "excerpt": "def graph_expert_votes(\n    *,\n    text: str,\n    intent: str,\n    confidence: float,\n    nlu: Dict[str, Any],\n    watcher_snapshot: Dict[str, Any],\n    chain_parts_count: int = 0,\n) -> List[Dict[str, Any]]:\n    \"\"\"\n    Expert voting stage ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:graph_executor_decision",
      "kind": "functiondef",
      "name": "graph_executor_decision",
      "start_line": 7340,
      "end_line": 7414,
      "snippet_hash": "667dc03665443b371e96b7a6f10de4b96ec8f6da6860faae62793ad86d771aea",
      "excerpt": "def graph_executor_decision(\n    *,\n    intent: str,\n    confidence: float,\n    watcher_snapshot: Dict[str, Any],\n    expert_votes: List[Dict[str, Any]],\n) -> Dict[str, Any]:\n    \"\"\"Final deterministic decision from watcher + expert votes.\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_persist_graph_route",
      "kind": "asyncfunctiondef",
      "name": "neo4j_persist_graph_route",
      "start_line": 7417,
      "end_line": 7485,
      "snippet_hash": "b645489a0a05a6de59f94d6afc9193d8eb986386dd48a9a55850b50ddf420dcd",
      "excerpt": "async def neo4j_persist_graph_route(\n    *,\n    trace_id_val: str,\n    session_id: str,\n    user_id: str,\n    text: str,\n    intent_before: str,\n    intent_after: str,\n    confidence_before: float,\n    confidence_after: float,\n    route_dat",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:graph_first_route",
      "kind": "asyncfunctiondef",
      "name": "graph_first_route",
      "start_line": 7488,
      "end_line": 7543,
      "snippet_hash": "f407049aa643361f48aad9352b98a647582d8637aea11e483f7b284527f9c8d4",
      "excerpt": "async def graph_first_route(\n    *,\n    user_id: str,\n    session_id: str,\n    trace_id_val: str,\n    text: str,\n    intent: str,\n    confidence: float,\n    nlu: Dict[str, Any],\n    chain_parts_count: int = 0,\n) -> Dict[str, Any]:\n    \"\"\"Or",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:swarm_generate",
      "kind": "asyncfunctiondef",
      "name": "swarm_generate",
      "start_line": 7549,
      "end_line": 7819,
      "snippet_hash": "6523962ae2a3f1b2386af4084a333ca526c742243f6cc822f2f7d13bcbf06e4d",
      "excerpt": "async def swarm_generate(\n    text: str,\n    intent: str,\n    session_context: Dict,\n    ocean_traits: Dict[str, float],\n    system_prompt_override: str = None,\n    uncertainty: Optional[float] = None,\n    stream: bool = False,\n) -> Dict[st",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:smx_stream_generator",
      "kind": "asyncfunctiondef",
      "name": "smx_stream_generator",
      "start_line": 7626,
      "end_line": 7686,
      "snippet_hash": "318eab565a65dd4aaf7b5e4dea863e70ac63977a4a88cb848aa098fd8924701a",
      "excerpt": "                async def smx_stream_generator():\n                    import time\n                    t0 = time.time()\n                    \n                    # Yield evento de inicio\n                    yield {\n                        \"ty",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_parse_env_key_list",
      "kind": "functiondef",
      "name": "_parse_env_key_list",
      "start_line": 7849,
      "end_line": 7872,
      "snippet_hash": "dbdbc506f7fd8ed04e2d2417d193009b1b7187c5ba59cc4fa2aa0e76ab372f58",
      "excerpt": "def _parse_env_key_list(*names: str) -> List[str]:\n    \"\"\"Parsea keys desde vars simples, CSV o JSON list.\"\"\"\n    out: List[str] = []\n    for n in names:\n        raw = str(os.getenv(n, \"\") or \"\").strip()\n        if not raw:\n            cont",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_parse_env_numbered_keys",
      "kind": "functiondef",
      "name": "_parse_env_numbered_keys",
      "start_line": 7875,
      "end_line": 7899,
      "snippet_hash": "484bd67b46433240a0e26b59c2292c842dce1dccfa3ecd6dd6c65fee3efa97b2",
      "excerpt": "def _parse_env_numbered_keys(base_name: str) -> List[str]:\n    \"\"\"Recoge BASE y BASE_N ordenadas por N.\"\"\"\n    out: List[str] = []\n    indexed: List[Tuple[int, str, str]] = []\n    pattern = re.compile(rf\"^{re.escape(base_name)}_(\\d+)$\")\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_merge_unique",
      "kind": "functiondef",
      "name": "_merge_unique",
      "start_line": 7902,
      "end_line": 7908,
      "snippet_hash": "7aad66028a4509879d43e2c986e409f9b7f9c4f7d3a558604ff109dbda6a0f8e",
      "excerpt": "def _merge_unique(values: List[str]) -> List[str]:\n    out: List[str] = []\n    for v in values:\n        vv = str(v or \"\").strip()\n        if vv and vv not in out:\n            out.append(vv)\n    return out",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_init_provider_key_pools",
      "kind": "functiondef",
      "name": "_init_provider_key_pools",
      "start_line": 7911,
      "end_line": 7961,
      "snippet_hash": "35afc04f5157d5c098c368eeaa3888eb91b3ac7a777b22263976e72fb7a2170f",
      "excerpt": "def _init_provider_key_pools() -> None:\n    groq_keys = _merge_unique(\n        _parse_env_key_list(\n            \"GROQ_API_KEYS\",\n            \"GROQ_API_KEY\",\n            \"GROQ_CURRENT_KEY\",\n        )\n        + _parse_env_numbered_keys(\"GROQ_",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_pool",
      "kind": "functiondef",
      "name": "build_pool",
      "start_line": 7935,
      "end_line": 7953,
      "snippet_hash": "e23ac825a3ad8426d601770b4f7736dfbe4788d56c6a963a142bb76b1576dc6d",
      "excerpt": "    def build_pool(keys: List[str], daily_limit: int) -> List[Dict[str, Any]]:\n        pool = []\n        for idx, key in enumerate(keys):\n            pool.append(\n                {\n                    \"idx\": idx,\n                    \"key\": ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_init_provider_node_pools",
      "kind": "functiondef",
      "name": "_init_provider_node_pools",
      "start_line": 7964,
      "end_line": 7998,
      "snippet_hash": "32f147a859d6c930b88db58fe2eedc6d0c63b1681b23b3d56fd601fabf1503cb",
      "excerpt": "def _init_provider_node_pools() -> None:\n    def collect_urls(base_url: str, list_name: str, indexed_base: str) -> List[str]:\n        urls = _merge_unique(\n            ([base_url] if base_url else [])\n            + _parse_env_key_list(list_",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:collect_urls",
      "kind": "functiondef",
      "name": "collect_urls",
      "start_line": 7965,
      "end_line": 7971,
      "snippet_hash": "b3e25dd926ed0d1ab6c4e9817a8904754420a29193633178797aac6741efdcd1",
      "excerpt": "    def collect_urls(base_url: str, list_name: str, indexed_base: str) -> List[str]:\n        urls = _merge_unique(\n            ([base_url] if base_url else [])\n            + _parse_env_key_list(list_name)\n            + _parse_env_numbered_k",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_nodes",
      "kind": "functiondef",
      "name": "build_nodes",
      "start_line": 7981,
      "end_line": 7994,
      "snippet_hash": "3457d9682ab02a81054f2ceb586b91bf0cb66c87fff0475c3146248ac2af7e4f",
      "excerpt": "    def build_nodes(urls: List[str]) -> List[Dict[str, Any]]:\n        return [\n            {\n                \"idx\": idx,\n                \"url\": u,\n                \"last_used\": 0.0,\n                \"cooldown_until\": 0.0,\n                \"dis",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_slot_score",
      "kind": "functiondef",
      "name": "_provider_slot_score",
      "start_line": 8001,
      "end_line": 8009,
      "snippet_hash": "22d976152826fdb6a5d4265f3f5d77106d804ffed477e25b07320be39a508607",
      "excerpt": "def _provider_slot_score(slot: Dict[str, Any]) -> Tuple[float, float, float]:\n    fails = float(slot.get(\"failures\") or 0.0)\n    succ = float(slot.get(\"successes\") or 0.0)\n    fail_ratio = fails / max(1.0, succ + fails)\n    load = float(slo",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_node_score",
      "kind": "functiondef",
      "name": "_provider_node_score",
      "start_line": 8012,
      "end_line": 8020,
      "snippet_hash": "9529372a1172fd40b540c9e74b850c3298e38f1eff532bee15dd8e2b8fc76850",
      "excerpt": "def _provider_node_score(node: Dict[str, Any]) -> Tuple[float, float, float]:\n    fails = float(node.get(\"failures\") or 0.0)\n    succ = float(node.get(\"successes\") or 0.0)\n    fail_ratio = fails / max(1.0, succ + fails)\n    latency = float(",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_cb_is_open",
      "kind": "functiondef",
      "name": "_provider_cb_is_open",
      "start_line": 8023,
      "end_line": 8025,
      "snippet_hash": "7014a30fcce2f57badf580c952613cfe7e8b4f626052608a78893e877e2a990b",
      "excerpt": "def _provider_cb_is_open(provider: str) -> bool:\n    st = _PROVIDER_CB_STATE.get(provider) or {}\n    return float(st.get(\"open_until\") or 0.0) > time.time()",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_cb_record_success",
      "kind": "functiondef",
      "name": "_provider_cb_record_success",
      "start_line": 8028,
      "end_line": 8031,
      "snippet_hash": "387eee33947aa3b075c8319dca7fca484efd7c65190b1e1f05936043666a45bf",
      "excerpt": "def _provider_cb_record_success(provider: str) -> None:\n    st = _PROVIDER_CB_STATE.setdefault(provider, {\"failures\": 0, \"open_until\": 0.0})\n    st[\"failures\"] = 0\n    st[\"open_until\"] = 0.0",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_cb_record_failure",
      "kind": "functiondef",
      "name": "_provider_cb_record_failure",
      "start_line": 8034,
      "end_line": 8038,
      "snippet_hash": "181f461862a00732e7710a87ab8be206b4abeb6ab97ac4f3de07a3275a7679d7",
      "excerpt": "def _provider_cb_record_failure(provider: str) -> None:\n    st = _PROVIDER_CB_STATE.setdefault(provider, {\"failures\": 0, \"open_until\": 0.0})\n    st[\"failures\"] = int(st.get(\"failures\") or 0) + 1\n    if int(st[\"failures\"]) >= int(DENIS_PROVI",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_pick_key",
      "kind": "functiondef",
      "name": "_provider_pick_key",
      "start_line": 8041,
      "end_line": 8062,
      "snippet_hash": "c586cf4f349c19bee2dadf88bd5cbde79ef8e2649ec74d3b690a20cb517e19cd",
      "excerpt": "def _provider_pick_key(provider: str) -> Optional[Dict[str, Any]]:\n    pool = _PROVIDER_KEY_POOLS.get(provider) or []\n    if not pool:\n        return None\n    now = time.time()\n    today = date.today().isoformat()\n    for k in pool:\n       ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_pick_node",
      "kind": "functiondef",
      "name": "_provider_pick_node",
      "start_line": 8065,
      "end_line": 8080,
      "snippet_hash": "e3a4ae180adb2b73199700b6db6bd3c61e2e5d2f8692a65b3de5961e61e38adf",
      "excerpt": "def _provider_pick_node(provider: str, fallback_url: str) -> Optional[Dict[str, Any]]:\n    pool = _PROVIDER_NODE_POOLS.get(provider) or []\n    if not pool and fallback_url:\n        return {\"idx\": -1, \"url\": fallback_url}\n    now = time.time",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_key_record_success",
      "kind": "functiondef",
      "name": "_provider_key_record_success",
      "start_line": 8083,
      "end_line": 8098,
      "snippet_hash": "3e821b331100628d8ae39e6726e5949717ae5a848b0920b1a605b1a5aa74cfc9",
      "excerpt": "def _provider_key_record_success(\n    provider: str,\n    key_slot: Optional[Dict[str, Any]],\n    latency_ms: Optional[float] = None,\n) -> None:\n    if not key_slot:\n        return\n    key_slot[\"last_used\"] = time.time()\n    key_slot[\"reques",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_node_record_success",
      "kind": "functiondef",
      "name": "_provider_node_record_success",
      "start_line": 8101,
      "end_line": 8112,
      "snippet_hash": "6dea6a71c9d5ef22779bcf44fa11cc68e7ce151b1bd4c67e13c91939036d5fb0",
      "excerpt": "def _provider_node_record_success(\n    node_slot: Optional[Dict[str, Any]], latency_ms: Optional[float] = None\n) -> None:\n    if not node_slot:\n        return\n    node_slot[\"last_used\"] = time.time()\n    node_slot[\"successes\"] = int(node_sl",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_key_record_failure",
      "kind": "functiondef",
      "name": "_provider_key_record_failure",
      "start_line": 8115,
      "end_line": 8132,
      "snippet_hash": "d1cf5df1f3544bf6221717a3c47d4078b286cee913580087ffd662da7a4565e2",
      "excerpt": "def _provider_key_record_failure(\n    provider: str, key_slot: Optional[Dict[str, Any]], status_code: Optional[int]\n) -> None:\n    now = time.time()\n    if key_slot is not None:\n        key_slot[\"failures\"] = int(key_slot.get(\"failures\") or",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_node_record_failure",
      "kind": "functiondef",
      "name": "_provider_node_record_failure",
      "start_line": 8135,
      "end_line": 8150,
      "snippet_hash": "d4bfe8457d499a63226a81117cef7778dd8879c21d7a41912b9c57758d5637a8",
      "excerpt": "def _provider_node_record_failure(\n    node_slot: Optional[Dict[str, Any]], status_code: Optional[int]\n) -> None:\n    if node_slot is None:\n        return\n    now = time.time()\n    node_slot[\"failures\"] = int(node_slot.get(\"failures\") or 0)",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_provider_pool_size",
      "kind": "functiondef",
      "name": "_provider_pool_size",
      "start_line": 8153,
      "end_line": 8158,
      "snippet_hash": "89f8aa0a62f8caceda49e028d25b67a5b9a6d97489a1c864abc6f7ca3479b962",
      "excerpt": "def _provider_pool_size(provider: str) -> int:\n    keys = _PROVIDER_KEY_POOLS.get(provider) or []\n    nodes = _PROVIDER_NODE_POOLS.get(provider) or []\n    key_n = max(1, len(keys))\n    node_n = max(1, len(nodes))\n    return key_n * node_n",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_router_build_messages",
      "kind": "functiondef",
      "name": "_router_build_messages",
      "start_line": 8165,
      "end_line": 8177,
      "snippet_hash": "67b509a15537a37af18527285aa91ddf92333d7460486df43a5b761b738dadc3",
      "excerpt": "def _router_build_messages(\n    *, text: str, prompt_to_use: str, history_formatted: List[Dict[str, str]]\n) -> List[Dict[str, str]]:\n    messages: List[Dict[str, str]] = [{\"role\": \"system\", \"content\": prompt_to_use}]\n    for turn in history",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_openai_compatible_provider_call",
      "kind": "asyncfunctiondef",
      "name": "_openai_compatible_provider_call",
      "start_line": 8180,
      "end_line": 8261,
      "snippet_hash": "e005f69b46856b8d3a8c501e10a1257dc038a5ea6477944e7215c2186727d4b3",
      "excerpt": "async def _openai_compatible_provider_call(\n    *,\n    url: str,\n    api_key: str,\n    model: str,\n    messages: List[Dict[str, str]],\n    max_tokens: int,\n    temperature: float,\n    provider_name: str,\n    extra_headers: Optional[Dict[str",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_hybrid_inference_generate",
      "kind": "asyncfunctiondef",
      "name": "_hybrid_inference_generate",
      "start_line": 8264,
      "end_line": 8361,
      "snippet_hash": "6e5e8c0ded63bad93e4e7a8e0559f4b6ddb2609cb939832e7d41845af7c7f8c6",
      "excerpt": "async def _hybrid_inference_generate(\n    *,\n    text: str,\n    task_type: str,\n    prompt_to_use: str,\n    history_formatted: List[Dict[str, str]],\n    max_tokens: int,\n    temperature: float,\n    reason: str,\n) -> Dict[str, Any]:\n    \"\"\"\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_router_groq_generate",
      "kind": "asyncfunctiondef",
      "name": "_router_groq_generate",
      "start_line": 8364,
      "end_line": 8378,
      "snippet_hash": "696fe400389fcdf8bf1e8e5d6e070d01f928bfe88b2648315bc5198732fe77c0",
      "excerpt": "async def _router_groq_generate(\n    *,\n    messages: List[Dict[str, str]],\n    max_tokens: int,\n    temperature: float,\n) -> Dict[str, Any]:\n    return await _openai_compatible_provider_call(\n        url=GROQ_API_URL,\n        api_key=GROQ_",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_router_openrouter_ollama_generate",
      "kind": "asyncfunctiondef",
      "name": "_router_openrouter_ollama_generate",
      "start_line": 8381,
      "end_line": 8417,
      "snippet_hash": "ec416beed174bee11bb7f577140ab0215931a3391aa9b18ee9f51f89ada81cb9",
      "excerpt": "async def _router_openrouter_ollama_generate(\n    *,\n    messages: List[Dict[str, str]],\n    task_type: str,\n    max_tokens: int,\n    temperature: float,\n) -> Dict[str, Any]:\n    # 1) OpenRouter (free preferred, paid for complex tasks if co",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_swarm_direct_generate",
      "kind": "asyncfunctiondef",
      "name": "_swarm_direct_generate",
      "start_line": 8420,
      "end_line": 8461,
      "snippet_hash": "aba45a53145df42a25ccdea18e51247c03f49173dbf31308e997419f9e4cbbe5",
      "excerpt": "async def _swarm_direct_generate(\n    *,\n    model_key: str,\n    text: str,\n    task_type: str,\n    system_prompt: str,\n    session_id: Optional[str],\n    ocean_traits: Dict[str, float],\n    history_formatted: List[Dict[str, str]],\n    time",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:swarm_speculative_draft",
      "kind": "asyncfunctiondef",
      "name": "swarm_speculative_draft",
      "start_line": 8464,
      "end_line": 8500,
      "snippet_hash": "02c3870197f1267ca628b11061e388194e5e3c4eb468980fb226d8b22a6511c6",
      "excerpt": "async def swarm_speculative_draft(\n    *,\n    text: str,\n    task_type: str,\n    system_prompt: str,\n    session_context: Dict[str, Any],\n    ocean_traits: Dict[str, float],\n) -> Dict[str, Any]:\n    \"\"\"\n    Speculative draft path: cheap mod",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_call_llm",
      "kind": "asyncfunctiondef",
      "name": "_call_llm",
      "start_line": 8503,
      "end_line": 8536,
      "snippet_hash": "b6a63e4898e06034e5801f3671a6ec278328e44cd45196c8ee039e347d74e5fa",
      "excerpt": "async def _call_llm(\n    url: str,\n    messages: List[Dict],\n    max_tokens: int = 512,\n    temperature: float = 0.7,\n    label: str = \"unknown\",\n) -> Dict[str, Any]:\n    \"\"\"Call a single LLM endpoint.\"\"\"\n    start = time.monotonic()\n    tr",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_is_tool_intent",
      "kind": "functiondef",
      "name": "_is_tool_intent",
      "start_line": 8697,
      "end_line": 8699,
      "snippet_hash": "02fd1d5a99f74ae520616635e0b8bef67978c25866aba7acb8599de5ced015b1",
      "excerpt": "def _is_tool_intent(intent: str) -> bool:\n    # INTENT_TO_TOOL may be extended dynamically by reasoning_loop; avoid stale snapshots.\n    return intent in INTENT_TO_TOOL",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:execute_tool",
      "kind": "asyncfunctiondef",
      "name": "execute_tool",
      "start_line": 8702,
      "end_line": 8866,
      "snippet_hash": "b3aaecf0c79181e8c18e814e2e83691c5c205311b398b2759bf6f2f2d2541c5a",
      "excerpt": "async def execute_tool(tool_id: str, params: dict, user_id: str = \"system\") -> dict:\n    \"\"\"Execute a tool via Tool Executor (19005) or denis_persona_tools.\n\n    Persona tools are executed directly via denis_persona_tools.\n    Other tools u",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:resolve_tool_params",
      "kind": "asyncfunctiondef",
      "name": "resolve_tool_params",
      "start_line": 8869,
      "end_line": 9026,
      "snippet_hash": "261ae3873afe68925521022c45452f5fd1bc8272641932fe630ff5073eb972d7",
      "excerpt": "async def resolve_tool_params(intent: str, text: str, entities: list) -> dict:\n    \"\"\"Extract tool parameters from NLU entities and text.\n    Returns a params dict suitable for the tool executor.\"\"\"\n    params = {}\n\n    # Extract entity val",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:format_tool_result",
      "kind": "functiondef",
      "name": "format_tool_result",
      "start_line": 9029,
      "end_line": 9135,
      "snippet_hash": "81b0dc8a85241a16d46007422e6a97f9e1465a49ad46be203ae6899ae15983b0",
      "excerpt": "def format_tool_result(tool_id: str, result: dict) -> str:\n    \"\"\"Format tool execution result into human-readable text for the user.\"\"\"\n    if not result.get(\"success\", False):\n        return f\"Error ejecutando {tool_id}: {result.get('erro",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:classify_task_type",
      "kind": "functiondef",
      "name": "classify_task_type",
      "start_line": 9138,
      "end_line": 9186,
      "snippet_hash": "9f75b22e5e7cefda2788d051da2b8ca45b004874de9c4cdde54749fa531a1054",
      "excerpt": "def classify_task_type(intent: str, confidence: float) -> str:\n    \"\"\"Map Rasa intent to Swarm task_type.\"\"\"\n    # Check if it's a tool execution intent\n    if _is_tool_intent(intent):\n        return \"tool\"\n\n    # Check if it's a Connect de",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_infer_mental_scenario",
      "kind": "functiondef",
      "name": "_infer_mental_scenario",
      "start_line": 9194,
      "end_line": 9214,
      "snippet_hash": "4640ff6a981b492e5475745c3b7d24d30f8f568ec2856a402cc7e9cefe76a63e",
      "excerpt": "def _infer_mental_scenario(text: str, intent: str, task_type: str) -> str:\n    tl = (text or \"\").lower()\n    if task_type == \"code\" or \"code\" in (intent or \"\"):\n        return \"code_generation\"\n    if any(k in tl for k in (\"tailscale\", \"vpn",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_slot_contract_for_intent",
      "kind": "functiondef",
      "name": "_slot_contract_for_intent",
      "start_line": 9217,
      "end_line": 9227,
      "snippet_hash": "9c7c94c93baacb84d7cb1b61464d92e97034c62d04c96b087c4f2803bfc12748",
      "excerpt": "def _slot_contract_for_intent(intent: str) -> List[str]:\n    i = str(intent or \"\").strip().lower()\n    if i == \"gps_distance\":\n        return [\"origin\", \"destination\"]\n    if i in (\"search_images\", \"search_photos\", \"show_images\", \"show_phot",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_entities_to_slot_map",
      "kind": "functiondef",
      "name": "_entities_to_slot_map",
      "start_line": 9230,
      "end_line": 9241,
      "snippet_hash": "3656aafd33b51413d4a249786d484a39a819a9a19001be0cc1aefde43d740f26",
      "excerpt": "def _entities_to_slot_map(entities: List[Dict[str, Any]]) -> Dict[str, Any]:\n    out: Dict[str, Any] = {}\n    for e in entities or []:\n        if not isinstance(e, dict):\n            continue\n        key = str(e.get(\"entity\") or e.get(\"type",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_build_slot_state",
      "kind": "functiondef",
      "name": "_build_slot_state",
      "start_line": 9244,
      "end_line": 9265,
      "snippet_hash": "064e5a956a61b6551188642676f8921f65645699f90749c6d1191d8cb038d828",
      "excerpt": "def _build_slot_state(\n    intent: str, entities: List[Dict[str, Any]], text: str\n) -> Dict[str, Any]:\n    slots = _entities_to_slot_map(entities)\n    required = _slot_contract_for_intent(intent)\n    missing = [s for s in required if s not ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_detect_macro_intent_signal",
      "kind": "functiondef",
      "name": "_detect_macro_intent_signal",
      "start_line": 9268,
      "end_line": 9288,
      "snippet_hash": "9cd3bde4c04ce68736f0c32049bf700629f0d16505995fe3bc0295425f077680",
      "excerpt": "def _detect_macro_intent_signal(text: str, chain_count: int = 0) -> Dict[str, Any]:\n    tl = (text or \"\").lower()\n    keywords = (\n        \"macro\",\n        \"rutina\",\n        \"workflow\",\n        \"pipeline\",\n        \"automatiza\",\n        \"orq",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_cache_get_mental_control",
      "kind": "functiondef",
      "name": "_cache_get_mental_control",
      "start_line": 9291,
      "end_line": 9303,
      "snippet_hash": "15aca44df26532bd58166245308dc704ba247f2614a2c50dda64df5e126d73cd",
      "excerpt": "def _cache_get_mental_control(user_id: str, text_hash: str) -> Optional[Dict[str, Any]]:\n    try:\n        entry = (MENTAL_CONTROL_CACHE.get(user_id) or {}).get(text_hash)\n        if not entry:\n            return None\n        ts = float(entr",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_cache_set_mental_control",
      "kind": "functiondef",
      "name": "_cache_set_mental_control",
      "start_line": 9306,
      "end_line": 9315,
      "snippet_hash": "a7f58031e90a047aa66ade325c51a3814ae855b23a17fc33368ecad13b7330c0",
      "excerpt": "def _cache_set_mental_control(\n    user_id: str, text_hash: str, control: Dict[str, Any]\n) -> None:\n    try:\n        MENTAL_CONTROL_CACHE[user_id][text_hash] = {\n            \"timestamp\": time.monotonic(),\n            \"control\": dict(control",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_cache_set_evidence",
      "kind": "functiondef",
      "name": "_cache_set_evidence",
      "start_line": 9318,
      "end_line": 9338,
      "snippet_hash": "04c982f9e457c465272a8326ec32556eff22aa5b4de371c2a69b5eda2f4b3529",
      "excerpt": "def _cache_set_evidence(\n    session_id: str, trace_id_val: str, evidence: Dict[str, Any]\n) -> None:\n    try:\n        key = f\"{session_id}:{trace_id_val}\"\n        EVIDENCE_CACHE[key] = {\n            \"timestamp\": time.monotonic(),\n          ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_cache_get_evidence",
      "kind": "functiondef",
      "name": "_cache_get_evidence",
      "start_line": 9341,
      "end_line": 9352,
      "snippet_hash": "020c9c1adf3e785e7e19459545265d33c5c55378e2021699697e334708288019",
      "excerpt": "def _cache_get_evidence(session_id: str, trace_id_val: str) -> Optional[Dict[str, Any]]:\n    try:\n        key = f\"{session_id}:{trace_id_val}\"\n        entry = EVIDENCE_CACHE.get(key) or {}\n        ts = float(entry.get(\"timestamp\") or 0.0)\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_estimate_uncertainty",
      "kind": "functiondef",
      "name": "_estimate_uncertainty",
      "start_line": 9355,
      "end_line": 9379,
      "snippet_hash": "be928a6afe12db561542b65a7adcdd06c50125a7c57d96421269191cb67adbd9",
      "excerpt": "def _estimate_uncertainty(\n    *,\n    intent: str,\n    confidence: float,\n    reasoning: Dict[str, Any],\n    cot_control: Optional[Dict[str, Any]],\n    text: str,\n) -> float:\n    u = max(0.0, min(1.0, 1.0 - float(confidence or 0.0)))\n    if",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_select_active_neuro_layers",
      "kind": "functiondef",
      "name": "_select_active_neuro_layers",
      "start_line": 9382,
      "end_line": 9401,
      "snippet_hash": "c70eb765f9f11ea5d9071faa6d57b84fe04e2ac397e6243df18eff83b4e4b4d2",
      "excerpt": "def _select_active_neuro_layers(\n    *, scenario: str, task_type: str, tool_plan: str, emotional_state: str\n) -> List[str]:\n    active = {1, 2, 3, 5, 8, 12}\n    if task_type in (\"tool\", \"code\", \"search\"):\n        active.update({4, 5, 11})\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_build_parallel_plan",
      "kind": "functiondef",
      "name": "_build_parallel_plan",
      "start_line": 9404,
      "end_line": 9423,
      "snippet_hash": "5e01b5a1e986f2600bb682a8cd73b1cf655e310fbcb3dda6ae9d79dab4995597",
      "excerpt": "def _build_parallel_plan(\n    *, scenario: str, uncertainty: float, task_type: str, tool_plan: str\n) -> Dict[str, Any]:\n    models = list(SCENARIO_MODEL_MAP.get(scenario, [\"qwen3b\", \"qwen15b\"]))\n    deep = bool(\n        uncertainty >= 0.46\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_tokenize_for_verifier",
      "kind": "functiondef",
      "name": "_tokenize_for_verifier",
      "start_line": 9426,
      "end_line": 9431,
      "snippet_hash": "a6773cbd137e6980de91bd233f529166f26fa4da101859fc0e8a75bf13967e0d",
      "excerpt": "def _tokenize_for_verifier(text: str) -> set:\n    return {\n        t\n        for t in re.findall(r\"[a-zA-Z0-9_]{3,}\", (text or \"\").lower())\n        if t not in {\"para\", \"como\", \"esta\", \"este\", \"that\", \"with\", \"from\"}\n    }",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_candidate_verifier_score",
      "kind": "functiondef",
      "name": "_candidate_verifier_score",
      "start_line": 9434,
      "end_line": 9461,
      "snippet_hash": "f153db265d514ac9907861f6e8ec078224b427571b49be24569c26df12b7ef23",
      "excerpt": "def _candidate_verifier_score(\n    candidate: str, *, query_terms: set, evidence_terms: set, model_key: str\n) -> float:\n    c_terms = _tokenize_for_verifier(candidate)\n    if not c_terms:\n        return 0.0\n    query_cov = (\n        (len(c_",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_build_mental_control_block",
      "kind": "functiondef",
      "name": "_build_mental_control_block",
      "start_line": 9464,
      "end_line": 9527,
      "snippet_hash": "153009caac3b462a70acb6cecac3ad17aee4fbb6445fdafc262031007809640e",
      "excerpt": "def _build_mental_control_block(\n    *,\n    text: str,\n    intent: str,\n    confidence: float,\n    task_type: str,\n    reasoning: Dict[str, Any],\n    enrichment: Dict[str, Any],\n    cot_control: Optional[Dict[str, Any]],\n    slot_state: Opt",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:swarm_parallel_generate",
      "kind": "asyncfunctiondef",
      "name": "swarm_parallel_generate",
      "start_line": 9530,
      "end_line": 9683,
      "snippet_hash": "ba10c0e851d7bde3372a0bfbd784c0089648ad2ca2a7f27416e5b1219b816024",
      "excerpt": "async def swarm_parallel_generate(\n    *,\n    text: str,\n    intent: str,\n    session_context: Dict,\n    ocean_traits: Dict[str, float],\n    system_prompt_override: str,\n    mental_control: Dict[str, Any],\n    evidence: Optional[Dict[str, A",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:cognitive_enrich",
      "kind": "asyncfunctiondef",
      "name": "cognitive_enrich",
      "start_line": 9695,
      "end_line": 9908,
      "snippet_hash": "1c1a2ae23004ee40e2990271e916b7513fa2c00501b11207bcf6dde439a3e20a",
      "excerpt": "async def cognitive_enrich(\n    text: str,\n    user_id: str,\n    session_id: str,\n    nlu_intent: str,\n    nlu_confidence: float,\n    *,\n    trace_id_val: str = \"\",\n    entities: Optional[List[Dict[str, Any]]] = None,\n    runtime_context: O",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:run_identity",
      "kind": "asyncfunctiondef",
      "name": "run_identity",
      "start_line": 9729,
      "end_line": 9787,
      "snippet_hash": "a34a7cb566898441ea3022510353e4ddbe93f1b0b224a8e9df9d28c46dcbbc31",
      "excerpt": "    async def run_identity():\n        if not identity_system:\n            return\n        try:\n            # Infer emotional state from message\n            emotion = identity_system.tom_engine.infer_emotion(text)\n            enrichment[\"emot",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:run_cot",
      "kind": "asyncfunctiondef",
      "name": "run_cot",
      "start_line": 9790,
      "end_line": 9807,
      "snippet_hash": "fab0091f04c0e95e10fe5b39242487d13b3e26be7a13411fff5904714c928731",
      "excerpt": "    async def run_cot():\n        if not cot_engine:\n            return\n        try:\n            task_type = await cot_engine.analyze_task(text, trace_id=session_id)\n            enrichment[\"task_type\"] = task_type.value\n\n            # Build ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:run_memory",
      "kind": "asyncfunctiondef",
      "name": "run_memory",
      "start_line": 9810,
      "end_line": 9824,
      "snippet_hash": "7b3003feeb21921bc96fc1070e131b3852979e6dd2cb72d3abee6d2ab55a5101",
      "excerpt": "    async def run_memory():\n        if not agent_memory:\n            return\n        try:\n            similar = await agent_memory.search_similar_sessions(text, top_k=3)\n            if similar:\n                enrichment[\"memory_context\"] = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:cognitive_post_process",
      "kind": "asyncfunctiondef",
      "name": "cognitive_post_process",
      "start_line": 9911,
      "end_line": 10175,
      "snippet_hash": "f0822d0cb8325d95dacca6a4314a0cb135f041a146ca037cac08dfa71d0cecdb",
      "excerpt": "async def cognitive_post_process(\n    text: str,\n    response: str,\n    user_id: str,\n    session_id: str,\n    intent: str,\n    trace_id_val: str,\n    *,\n    meta: Optional[Dict[str, Any]] = None,\n):\n    \"\"\"Post-process: store in agent memo",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_sync_agent_log",
      "kind": "functiondef",
      "name": "_sync_agent_log",
      "start_line": 10178,
      "end_line": 10210,
      "snippet_hash": "7b904def2e9f16dca98d4463af3624c19a223fa622ff016c8f865f106304cd79",
      "excerpt": "def _sync_agent_log(text, response, user_id, session_id, intent, trace_id_val):\n    try:\n        q = (\n            \"MERGE (t:Turn {trace_id: \"\n            + chr(36)\n            + \"tid}) \"\n            + \"ON CREATE SET t.created_at = datetime",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_metacog_reflect",
      "kind": "functiondef",
      "name": "_metacog_reflect",
      "start_line": 10213,
      "end_line": 10253,
      "snippet_hash": "b26eaf8c6f4ff96985aec5d8095802fdc989ffeb3b7083ddada6d4a02da31b68",
      "excerpt": "def _metacog_reflect(\n    *,\n    intent: str,\n    nlu_confidence: float,\n    task_type: str,\n    tool_used: Optional[str],\n    response_text: str,\n) -> Dict[str, Any]:\n    \"\"\"\n    Cheap metacognition: produce a confidence score + next strat",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_extract_user_goals",
      "kind": "functiondef",
      "name": "_extract_user_goals",
      "start_line": 10272,
      "end_line": 10297,
      "snippet_hash": "94791a5250a0e9a53003020da1e3762faa5188aa8950c4f9dcd8f17d864e505d",
      "excerpt": "def _extract_user_goals(text: str, *, max_goals: int = 4) -> List[str]:\n    \"\"\"Extract explicit user goals/objectives from natural language text.\"\"\"\n    raw = str(text or \"\").strip()\n    if not raw:\n        return []\n    goals: List[str] = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_build_reflection_note",
      "kind": "functiondef",
      "name": "_build_reflection_note",
      "start_line": 10300,
      "end_line": 10328,
      "snippet_hash": "2f367feb9777e59b1cc1378c54ed0a4f6c0dd732b81fdc8e0cc8647fbfe63d70",
      "excerpt": "def _build_reflection_note(\n    *,\n    intent: str,\n    task_type: str,\n    tool_used: str,\n    tool_success: Optional[bool],\n    confidence_score: float,\n    next_turn_strategy: str,\n) -> Tuple[str, str]:\n    \"\"\"Build deterministic self-re",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_cognitive_runtime_update",
      "kind": "asyncfunctiondef",
      "name": "neo4j_cognitive_runtime_update",
      "start_line": 10331,
      "end_line": 10733,
      "snippet_hash": "271607ee29df7b85fb6b5ee0ec0738209c629759cbf405f98ec74f6fd0eb5551",
      "excerpt": "async def neo4j_cognitive_runtime_update(\n    *,\n    user_id: str,\n    session_id: str,\n    trace_id_val: str,\n    text: str,\n    intent: str,\n    task_type: str,\n    meta: Optional[Dict[str, Any]] = None,\n) -> Dict[str, Any]:\n    \"\"\"\n    P",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_safe_json_list",
      "kind": "functiondef",
      "name": "_safe_json_list",
      "start_line": 10736,
      "end_line": 10758,
      "snippet_hash": "06b7c47c90238d47a8ecc51d51133b5b77742bb993f57bacbd6714dae5f5c402",
      "excerpt": "def _safe_json_list(\n    raw: Any, *, max_items: int = 6, max_item_len: int = 120\n) -> List[str]:\n    if raw is None:\n        return []\n    try:\n        if isinstance(raw, list):\n            arr = raw\n        else:\n            arr = json.lo",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_get_cognitive_runtime_context",
      "kind": "asyncfunctiondef",
      "name": "neo4j_get_cognitive_runtime_context",
      "start_line": 10761,
      "end_line": 10979,
      "snippet_hash": "54813982ba053c0d7a067488646041f05cb6df779c539500e7170c7e99ddc777",
      "excerpt": "async def neo4j_get_cognitive_runtime_context(\n    *,\n    user_id: str,\n    intent: str = \"\",\n) -> Dict[str, Any]:\n    \"\"\"\n    Read cognitive runtime context from Neo4j so decisions are guided by real memory:\n    - active user goals\n    - t",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_layer_prompt_suffix",
      "kind": "functiondef",
      "name": "_layer_prompt_suffix",
      "start_line": 10982,
      "end_line": 11017,
      "snippet_hash": "79e8e5e3418abbc4afe9f7b740a0a3fd999c10d03150359e852998284078b901",
      "excerpt": "def _layer_prompt_suffix() -> str:\n    \"\"\"Inject the 12-layer behavior contract (best-effort) without breaking existing clients.\"\"\"\n    blocks: List[str] = []\n\n    if DENIS_COT_ENABLED:\n        blocks.append(\n            \"## Layer 5 (CoT ad",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_is_self_awareness_query",
      "kind": "functiondef",
      "name": "_is_self_awareness_query",
      "start_line": 11041,
      "end_line": 11051,
      "snippet_hash": "13d05080729526b87ee194a3bf52273589125da95fa3e0edc424037fce861206",
      "excerpt": "def _is_self_awareness_query(text_lower: str) -> bool:\n    \"\"\"\n    Keep self-aware mode strict: only explicit \"about Denis capabilities\" queries.\n    Avoid generic verbs like \"puedes\" that should route to tools/actions.\n    \"\"\"\n    if not t",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_is_explicit_capabilities_query",
      "kind": "functiondef",
      "name": "_is_explicit_capabilities_query",
      "start_line": 11054,
      "end_line": 11086,
      "snippet_hash": "ce4062182df0ddd157529ac5c47b4af606ed86435029e91bbac53194d53a7aff",
      "excerpt": "def _is_explicit_capabilities_query(text_lower: str) -> bool:\n    \"\"\"\n    Stronger gate for self-aware mode.\n    Prevent \"capabilities manifest\" responses from hijacking real tasks.\n    \"\"\"\n    if not _is_self_awareness_query(text_lower):\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:reasoning_loop",
      "kind": "asyncfunctiondef",
      "name": "reasoning_loop",
      "start_line": 11089,
      "end_line": 11320,
      "snippet_hash": "744e0cf14dbba0e4176ea40d1c0cbc4a09e29ab2dad890a39a610605ba6741a2",
      "excerpt": "async def reasoning_loop(\n    text: str,\n    user_id: str,\n    intent: str,\n    confidence: float,\n    entities: list,\n    ocean: Dict[str, float],\n    identity_data: Dict,\n    session_history: list,\n    episodic_context: str,\n    enrichmen",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:process_conversation",
      "kind": "asyncfunctiondef",
      "name": "process_conversation",
      "start_line": 11323,
      "end_line": 15524,
      "snippet_hash": "ee23280bac57d192d0255128242440477569b2063860a338dbce1e28dc0dbc5f",
      "excerpt": "async def process_conversation(req: ConversationRequest) -> ConversationResponse:\n    \"\"\"Full pipeline: Rasa NLU -> route -> Swarm LLM -> persist -> respond.\"\"\"\n    t0 = time.monotonic()\n    tid = trace_id()\n\n    # Preserve the raw user tex",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_chain_connector_label",
      "kind": "functiondef",
      "name": "_chain_connector_label",
      "start_line": 13473,
      "end_line": 13478,
      "snippet_hash": "4ea382a31fd489e6b1585b71c9a23d2f681829b3c83a924b84091ae0627e140c",
      "excerpt": "        def _chain_connector_label(part) -> str:\n            try:\n                c = getattr(part, \"connector_before\", None)\n                return str(getattr(c, \"label\", \"\") or \"\").strip().upper()\n            except Exception:\n          ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_process_chain_part",
      "kind": "asyncfunctiondef",
      "name": "_process_chain_part",
      "start_line": 13480,
      "end_line": 13860,
      "snippet_hash": "d61e992665763e2ca37e70752a2c1191cf54952ad2a3754d72a6fc50b8f0e297",
      "excerpt": "        async def _process_chain_part(\n            part, prior_success: bool = True\n        ) -> Dict[str, Any]:\n            part_text = str(getattr(part, \"text\", \"\") or \"\").strip()\n            if not part_text:\n                return {\"ok\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_get_device_candidates",
      "kind": "asyncfunctiondef",
      "name": "_get_device_candidates",
      "start_line": 14393,
      "end_line": 14438,
      "snippet_hash": "9be6aae106ab42f5c15b95074594240ab1e90dc1d60a05e1fae553d15be7630c",
      "excerpt": "                async def _get_device_candidates(\n                    location_val: Optional[str],\n                ) -> List[str]:\n                    if not redis_client:\n                        return []\n                    loc = str(loca",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_require_music_enabled",
      "kind": "functiondef",
      "name": "_require_music_enabled",
      "start_line": 15533,
      "end_line": 15537,
      "snippet_hash": "56a790c80d6c21127f5e895cae8409333e0a769a02ecd2ca2b3747547936a288",
      "excerpt": "def _require_music_enabled():\n    if not MUSIC_ENDPOINTS_ENABLED:\n        raise HTTPException(\n            404, \"Music endpoints disabled (set DENIS_MUSIC_ENABLE_ENDPOINTS=1)\"\n        )",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_require_adblock_enabled",
      "kind": "functiondef",
      "name": "_require_adblock_enabled",
      "start_line": 15540,
      "end_line": 15546,
      "snippet_hash": "3524b27f374f119f91441d85d2e0965586eac95693b031fe43d19091005087bb",
      "excerpt": "def _require_adblock_enabled(x_denis_admin_key: Optional[str] = None):\n    if not ADBLOCK_ENDPOINTS_ENABLED:\n        raise HTTPException(\n            404, \"Adblock endpoints disabled (set DENIS_ADBLOCK_ENABLE_ENDPOINTS=1)\"\n        )\n    # A",
      "synthetic": false
    },
    {
      "anchor_id": "A:synthetic:status",
      "kind": "function",
      "name": "status",
      "start_line": 15549,
      "end_line": 15629,
      "snippet_hash": "8e6b3941b240f12c23df79ae2f4473cb573155948b9c742d5b71c2104b47157c",
      "excerpt": "@app.get(\"/v1/music/status\")\nasync def v1_music_status():\n    _require_music_enabled()\n    player = get_music_player()\n    return {\"success\": True, \"status\": player.status(), \"trace_id\": trace_id()}\n\n\n@app.get(\"/v1/music/search\")\nasync def ",
      "synthetic": true
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_music_status",
      "kind": "asyncfunctiondef",
      "name": "v1_music_status",
      "start_line": 15550,
      "end_line": 15553,
      "snippet_hash": "43eebd5bc0bcc1edaa9c42b690d8fdd6f7297e8c270abfffe6947f530199058d",
      "excerpt": "async def v1_music_status():\n    _require_music_enabled()\n    player = get_music_player()\n    return {\"success\": True, \"status\": player.status(), \"trace_id\": trace_id()}",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_music_search",
      "kind": "asyncfunctiondef",
      "name": "v1_music_search",
      "start_line": 15557,
      "end_line": 15574,
      "snippet_hash": "c3242244dcd0b8c5eeebbec0aadcb7216e90e1f06b94e2f52aae9408615f5054",
      "excerpt": "async def v1_music_search(q: str, source: str = \"youtube\", limit: int = 10):\n    \"\"\"\n    Search for tracks. Requires DENIS_MUSIC_ENABLE_YTDLP=1 and DENIS_MUSIC_ENABLE_ENDPOINTS=1.\n    This endpoint does not implement any bypass for restrict",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_music_play",
      "kind": "asyncfunctiondef",
      "name": "v1_music_play",
      "start_line": 15578,
      "end_line": 15595,
      "snippet_hash": "c3d84c2a5044dc056cc2137b69e5ddc0267a068683d22283c57056cfec77d7b0",
      "excerpt": "async def v1_music_play(req: MusicPlayRequest):\n    \"\"\"\n    Server-side playback (ffplay on host).\n    Local files must be under DENIS_MUSIC_LOCAL_ROOT.\n    Remote playback is disabled by default and can be enabled via env vars:\n      DENIS",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_music_stop",
      "kind": "asyncfunctiondef",
      "name": "v1_music_stop",
      "start_line": 15599,
      "end_line": 15604,
      "snippet_hash": "d5e6ac1fa1c80eef9436e1b77123a5f162fde4c3a709195d4bfac8cf3f589a6e",
      "excerpt": "async def v1_music_stop():\n    _require_music_enabled()\n    player = get_music_player()\n    out = await player.stop()\n    out[\"trace_id\"] = trace_id()\n    return out",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_music_volume",
      "kind": "asyncfunctiondef",
      "name": "v1_music_volume",
      "start_line": 15608,
      "end_line": 15613,
      "snippet_hash": "dd2ec21d9959a3c4493312575ef6b060000ad93be06d7d1072db1b1c975e4789",
      "excerpt": "async def v1_music_volume(req: MusicVolumeRequest):\n    _require_music_enabled()\n    player = get_music_player()\n    out = player.set_volume(req.volume)\n    out[\"trace_id\"] = trace_id()\n    return out",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_adblock_status",
      "kind": "asyncfunctiondef",
      "name": "v1_adblock_status",
      "start_line": 15617,
      "end_line": 15633,
      "snippet_hash": "309cd6302296a7a22b93adf0bad124ac8bd2066756ebd0638d73beb52b2fa3e9",
      "excerpt": "async def v1_adblock_status(x_denis_admin_key: Optional[str] = Header(default=None)):\n    _require_adblock_enabled(x_denis_admin_key)\n    meta_path = ADBLOCK_OUT_DIR / \"dnsmasq.adblock.meta.json\"\n    meta = None\n    if meta_path.exists():\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_adblock_update",
      "kind": "asyncfunctiondef",
      "name": "v1_adblock_update",
      "start_line": 15637,
      "end_line": 15644,
      "snippet_hash": "32960eeaf51dc272f31aedc04f8686fd2ff275cd3149c9ddc9ee76378346a0d6",
      "excerpt": "async def v1_adblock_update(x_denis_admin_key: Optional[str] = Header(default=None)):\n    _require_adblock_enabled(x_denis_admin_key)\n    sources_file = (\n        Path(ADBLOCK_SOURCES_FILE).resolve() if ADBLOCK_SOURCES_FILE else None\n    )\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_adblock_dnsmasq_conf",
      "kind": "asyncfunctiondef",
      "name": "v1_adblock_dnsmasq_conf",
      "start_line": 15648,
      "end_line": 15655,
      "snippet_hash": "9d104660ffa46d20fd239221d9a98bc20c9a8a1eda34f00652a70d3551df5184",
      "excerpt": "async def v1_adblock_dnsmasq_conf(\n    x_denis_admin_key: Optional[str] = Header(default=None),\n):\n    _require_adblock_enabled(x_denis_admin_key)\n    out_path = ADBLOCK_OUT_DIR / \"dnsmasq.adblock.conf\"\n    if not out_path.exists():\n       ",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:AgentContextRequest",
      "kind": "classdef",
      "name": "AgentContextRequest",
      "start_line": 15658,
      "end_line": 15660,
      "snippet_hash": "70b182357c360775ca5c424d466a137d87d408c222d8b628b38bd44eff24616c",
      "excerpt": "class AgentContextRequest(BaseModel):\n    message: str\n    context: Optional[Dict[str, Any]] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_clip_ctx",
      "kind": "functiondef",
      "name": "_clip_ctx",
      "start_line": 15663,
      "end_line": 15664,
      "snippet_hash": "1a1c6d25a038a6c20d19053b18c6432e02c1819ce4e77b2667fb346288678ea5",
      "excerpt": "def _clip_ctx(val: str, width: int) -> str:\n    return textwrap.shorten(val or \"\", width=width, placeholder=\" â¦\")",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_shrink_context_bundle",
      "kind": "functiondef",
      "name": "_shrink_context_bundle",
      "start_line": 15667,
      "end_line": 15703,
      "snippet_hash": "eab90784033c9e9fc915c2cdbca7413482297d93089226604df892cfc798480a",
      "excerpt": "def _shrink_context_bundle(bundle: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"\n    Apply conservative limits to avoid blowing prompt/context sizes.\n    Keys align with consumers (Rasa Actions, OceanAI bridge).\n    \"\"\"\n\n    def shrink_list(\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:shrink_list",
      "kind": "functiondef",
      "name": "shrink_list",
      "start_line": 15673,
      "end_line": 15688,
      "snippet_hash": "80ea74b71db51b96ae59e38fc45ebed0cf7bda59b598daa25d26ef94f4593150",
      "excerpt": "    def shrink_list(\n        lst: Optional[List[Any]], per_item: int, max_items: int\n    ) -> List[Any]:\n        res: List[Any] = []\n        for item in (lst or [])[:max_items]:\n            if isinstance(item, dict) and \"snippet\" in item:\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_agent_context",
      "kind": "asyncfunctiondef",
      "name": "v1_agent_context",
      "start_line": 15707,
      "end_line": 15748,
      "snippet_hash": "19a0c11806c001dc98773ba65faa2fab32cd31233d058647f3e726778a8806f6",
      "excerpt": "async def v1_agent_context(req: AgentContextRequest) -> Dict[str, Any]:\n    \"\"\"\n    Provide a context bundle for downstream Rasa/OceanAI consumers.\n    - Echoes recent message.\n    - Includes optional open_files/diagnostics from the caller ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:health",
      "kind": "asyncfunctiondef",
      "name": "health",
      "start_line": 15752,
      "end_line": 15884,
      "snippet_hash": "b318bc3d28f57997d25a8d89ceeca3fcb7e03e428fcfd8baf57ea0c9a502a80d",
      "excerpt": "async def health():\n    \"\"\"Health check with REAL evidence -- no lying.\"\"\"\n    tid = trace_id()\n    uptime = time.time() - START_TIME\n\n    # Check each component for real\n    rasa_ok = False\n    parlai_ok = False\n    neo4j_ok = False\n    re",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:graph_kpis",
      "kind": "asyncfunctiondef",
      "name": "graph_kpis",
      "start_line": 15888,
      "end_line": 15895,
      "snippet_hash": "da46e0012771c1c87c7e2a3b946b775376e8fe44bf58ace36230ca99e7049621",
      "excerpt": "async def graph_kpis():\n    \"\"\"\n    Canonical KPI board for graph-as-source-of-truth.\n    \"\"\"\n    kpis = await neo4j_collect_graph_kpis()\n    if not kpis.get(\"ok\"):\n        return {\"ok\": False, \"error\": kpis.get(\"reason\", \"neo4j_unavailable",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:graph_reconcile_now",
      "kind": "asyncfunctiondef",
      "name": "graph_reconcile_now",
      "start_line": 15899,
      "end_line": 15905,
      "snippet_hash": "81ede105c9ae65ef8a44acabb5cd9e48894b25ccb2a6212d493d1d0832374f7b",
      "excerpt": "async def graph_reconcile_now():\n    \"\"\"\n    Run A/B/C/D reconcilers on demand.\n    \"\"\"\n    report = await neo4j_run_reconcilers_once(reason=\"api\")\n    kpis = await neo4j_collect_graph_kpis()\n    return {\"ok\": True, \"report\": report, \"kpis\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:history_endpoint",
      "kind": "asyncfunctiondef",
      "name": "history_endpoint",
      "start_line": 15909,
      "end_line": 15913,
      "snippet_hash": "f55a1c19fccc08cdd3f9fdbbb2e8108b0ae6909f85e945555d674bee71dbd96e",
      "excerpt": "async def history_endpoint(session_id: str, limit: int = 20):\n    \"\"\"Return recent session turns from Redis. Most clients use this to hydrate chat history.\"\"\"\n    turns = await get_session_history(session_id, limit=limit)\n    turns.reverse(",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:memory_store_endpoint",
      "kind": "asyncfunctiondef",
      "name": "memory_store_endpoint",
      "start_line": 15917,
      "end_line": 16021,
      "snippet_hash": "4cddebdf2f2083c7e16ec136e1a130799003441a21d4b6a96f151d72aa90e5b1",
      "excerpt": "async def memory_store_endpoint(req: MemoryStoreRequest):\n    \"\"\"\n    Ingest a memory entry into Denis (canonical entrypoint).\n    Used by Rasa Actions and other subsystems. Best-effort: never crash the persona.\n    \"\"\"\n    sid = req.sessio",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_turn_endpoint",
      "kind": "asyncfunctiondef",
      "name": "neo4j_turn_endpoint",
      "start_line": 16025,
      "end_line": 16053,
      "snippet_hash": "7bf0aca759631f654a3efdf11003a359539f559e02a109ee73620c4a3a648888",
      "excerpt": "async def neo4j_turn_endpoint(trace_id_val: str):\n    \"\"\"Fetch a persisted turn + reasoning trace from Neo4j (no credentials exposed).\"\"\"\n    if not neo4j_async_driver:\n        raise HTTPException(status_code=503, detail=\"Neo4j offline\")\n  ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:conversation_endpoint",
      "kind": "asyncfunctiondef",
      "name": "conversation_endpoint",
      "start_line": 16057,
      "end_line": 16111,
      "snippet_hash": "03da02c16cc3f985331a22442bcfdbde3606af773a9240844fea85fe820dd7aa",
      "excerpt": "async def conversation_endpoint(\n    request: Request,\n    req: ConversationRequest,\n    current_user: Optional[User] = Depends(get_current_user_optional),\n):\n    \"\"\"Main text conversation endpoint.\"\"\"\n    client_host = str(getattr(getattr(",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:cot_feedback_endpoint",
      "kind": "asyncfunctiondef",
      "name": "cot_feedback_endpoint",
      "start_line": 16115,
      "end_line": 16146,
      "snippet_hash": "29c245a9091b309d734258c88800b8896e3370cbc51d1a63fc75b76b31bc1661",
      "excerpt": "async def cot_feedback_endpoint(\n    req: CoTFeedbackRequest,\n    current_user: Optional[User] = Depends(get_current_user_optional),\n):\n    \"\"\"\n    Feedback loop for the live CoT template system (Neo4j-backed).\n    This endpoint updates tem",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:stream_endpoint",
      "kind": "asyncfunctiondef",
      "name": "stream_endpoint",
      "start_line": 16150,
      "end_line": 17093,
      "snippet_hash": "beee9c21d81f88d37dbe8569c8a73c3230312729a4fdbfafd1c0a09fabac442d",
      "excerpt": "async def stream_endpoint(\n    request: Request,\n    text: str,\n    user_id: str = \"Jotah\",\n    session_id: str = None,\n    ticket: Optional[str] = None,\n    voice_mode: bool = False,\n):\n    \"\"\"SSE streaming endpoint for token-by-token outp",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:event_generator",
      "kind": "asyncfunctiondef",
      "name": "event_generator",
      "start_line": 16176,
      "end_line": 17091,
      "snippet_hash": "d9716afb39f6e7ce4db2f778f1c5af98f2a7fc19a20bc04035981387109246ce",
      "excerpt": "    async def event_generator():\n        _CALLER_USER_ID.set(user_id)\n        _CALLER_ROLES.set(roles_for_call)\n        _CALLER_HOST.set(client_host)\n        # Fast-start: emit immediately before any network calls to reduce perceived buffer",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:stream_conversation",
      "kind": "asyncfunctiondef",
      "name": "stream_conversation",
      "start_line": 17096,
      "end_line": 17125,
      "snippet_hash": "d2abd513a4ff812e6f0be1c54a63957ae3883e0d68d2c93c743f688080ac38b8",
      "excerpt": "async def stream_conversation(req: ConversationRequest):\n    \"\"\"Stream tokens by wrapping process_conversation to avoid missing generator.\"\"\"\n    result = await process_conversation(req)\n    if hasattr(result, \"model_dump\"):\n        data = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:websocket_conversation_bridge",
      "kind": "asyncfunctiondef",
      "name": "websocket_conversation_bridge",
      "start_line": 17129,
      "end_line": 17319,
      "snippet_hash": "6914944f5cf68b92c8171202531ea5f7ff2e31e5bc566c20e1210712d6713c6c",
      "excerpt": "async def websocket_conversation_bridge(websocket: WebSocket, session_id: str):\n    \"\"\"\n    Bridge WS chat <-> existing /v1/stream SSE pipeline.\n    Frontend expects token/tool/thinking events over WS.\n    \"\"\"\n    await websocket.accept()\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_relay_sse",
      "kind": "asyncfunctiondef",
      "name": "_relay_sse",
      "start_line": 17137,
      "end_line": 17275,
      "snippet_hash": "2e6496564ce37c677be908e2762cdadf8d80e8cf1d10ac3a8f0c1f1416b90af3",
      "excerpt": "    async def _relay_sse(text: str, user_id: str, sid: str, client_msg_id: str) -> None:\n        sse_url = f\"http://127.0.0.1:{PERSONA_PORT}/v1/stream\"\n        msg_id = client_msg_id or f\"ws_{uuid.uuid4().hex[:12]}\"\n        current_event = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:websocket_conversation_bridge_legacy",
      "kind": "asyncfunctiondef",
      "name": "websocket_conversation_bridge_legacy",
      "start_line": 17323,
      "end_line": 17325,
      "snippet_hash": "44cb0d6e9deaf8fe885d62d0b702b802712a710abbcecd7565ea628d2bbcfb34",
      "excerpt": "async def websocket_conversation_bridge_legacy(websocket: WebSocket, session_id: str):\n    # Backward-compatible alias.\n    await websocket_conversation_bridge(websocket, session_id)",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_extract_audio_b64_from_voice_msg",
      "kind": "functiondef",
      "name": "_extract_audio_b64_from_voice_msg",
      "start_line": 17328,
      "end_line": 17337,
      "snippet_hash": "09076301db3d8eda536e4428fab50e2593bbb970964af3d54135a385d6643ccc",
      "excerpt": "def _extract_audio_b64_from_voice_msg(msg: Dict[str, Any]) -> str:\n    \"\"\"Extract base64 audio payload from voice websocket message.\"\"\"\n    for key in (\"audio_base64\", \"audio\", \"data\", \"chunk\"):\n        val = msg.get(key)\n        if isinsta",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_decode_b64_audio",
      "kind": "functiondef",
      "name": "_decode_b64_audio",
      "start_line": 17340,
      "end_line": 17352,
      "snippet_hash": "3f92ee29310c7a17a0ced6ff043227b16e12eb3772c14aeac59c8f3db7129c22",
      "excerpt": "def _decode_b64_audio(audio_b64: str) -> bytes:\n    s = (audio_b64 or \"\").strip()\n    if not s:\n        return b\"\"\n    if s.startswith(\"data:\") and \",\" in s:\n        s = s.split(\",\", 1)[1].strip()\n    if not s:\n        return b\"\"\n    s += \"",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_extract_stt_text",
      "kind": "functiondef",
      "name": "_extract_stt_text",
      "start_line": 17355,
      "end_line": 17374,
      "snippet_hash": "9c021e31d28335877ece00abe89886728e818b0c01b04829cc86bb598945494b",
      "excerpt": "def _extract_stt_text(stt_payload: Dict[str, Any]) -> str:\n    if not isinstance(stt_payload, dict):\n        return \"\"\n    for key in (\"text\", \"transcript\", \"transcription\", \"utterance\"):\n        val = stt_payload.get(key)\n        if isinst",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_stt_from_voice_audio",
      "kind": "asyncfunctiondef",
      "name": "_stt_from_voice_audio",
      "start_line": 17377,
      "end_line": 17461,
      "snippet_hash": "8ee6d2c833fd529e8a1b42b62a651659d68a6cf48d8618e7bfc02f62ddd1e1a0",
      "excerpt": "async def _stt_from_voice_audio(\n    audio_b64: str, *, language: str = \"es\"\n) -> Tuple[str, Dict[str, Any]]:\n    \"\"\"\n    STT with graph-first routing:\n      1) Pipecat service (/v1/stt, /stt)\n      2) Whisper service (/transcribe, /v1/tran",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_tts_synthesize_voice",
      "kind": "asyncfunctiondef",
      "name": "_tts_synthesize_voice",
      "start_line": 17464,
      "end_line": 17570,
      "snippet_hash": "f3dd56547c2c35b15fadf5fc78a1493dcd05764a117e61369707c5286e84650f",
      "excerpt": "async def _tts_synthesize_voice(\n    text: str, *, voice: str = \"\"\n) -> Tuple[Optional[bytes], Dict[str, Any]]:\n    \"\"\"\n    TTS with graph-first routing:\n      1) Voice service (/tts, /v1/tts, /synthesize)\n      2) Pipecat service (/v1/tts,",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:voice_websocket",
      "kind": "asyncfunctiondef",
      "name": "voice_websocket",
      "start_line": 17574,
      "end_line": 18004,
      "snippet_hash": "44419fa4b3c3eb1fb7b6f59d107439e362be9a868a21bacaca11cde0f6b0cec1",
      "excerpt": "async def voice_websocket(websocket: WebSocket):\n    \"\"\"\n    WebSocket for voice + text with multiplexed channels.\n    Message types: text_input, voice_chunk, status_query, interrupt\n    \"\"\"\n    await websocket.accept()\n    client_id = f\"ws",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:smx_chat_completions",
      "kind": "asyncfunctiondef",
      "name": "smx_chat_completions",
      "start_line": 18009,
      "end_line": 18115,
      "snippet_hash": "b409bc7e97825ec2b87fce6e870545beb209dbae53106f9fb4b1b1943d8db6d1",
      "excerpt": "async def smx_chat_completions(request: Request):\n    \"\"\"\n    SMX-powered chat completions with streaming support.\n    Direct path: bypasses process_conversation for pure SMX processing.\n    \"\"\"\n    body = await request.json()\n    stream = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:generate_sse",
      "kind": "asyncfunctiondef",
      "name": "generate_sse",
      "start_line": 18035,
      "end_line": 18080,
      "snippet_hash": "8ef38b68bb5230e201452d7b0a81bc29c71551ab855a3aba5216404f2bc3aa9d",
      "excerpt": "        async def generate_sse():\n            smx = await get_smx_8084()\n            if not smx or not smx._initialized:\n                yield f\"data: {json.dumps({'error': 'SMX not initialized'})}\\n\\n\"\n                return\n            \n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:openai_chat_completions",
      "kind": "asyncfunctiondef",
      "name": "openai_chat_completions",
      "start_line": 18119,
      "end_line": 18248,
      "snippet_hash": "458a9e97d7b8f4a5ba107afcc47e29c4e8e6f958d4c3760c10a05ae3637f1381",
      "excerpt": "async def openai_chat_completions(request: Request):\n    \"\"\"\n    Canonical OpenAI-compatible endpoint.\n\n    This keeps Denis usable as a drop-in provider for tooling that expects:\n    POST /v1/chat/completions {model, messages, stream, ...}",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:generate_sse",
      "kind": "asyncfunctiondef",
      "name": "generate_sse",
      "start_line": 18193,
      "end_line": 18213,
      "snippet_hash": "83137ef09d06531a27baed88d050ad8b2ab6e37faf1fefc942f1d9f697a7917d",
      "excerpt": "        async def generate_sse():\n            _CALLER_USER_ID.set(str(user_id))\n            _CALLER_ROLES.set([])\n            _CALLER_HOST.set(client_host)\n\n            async for chunk in stream_conversation(req):\n                delta = st",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:legacy_chat",
      "kind": "asyncfunctiondef",
      "name": "legacy_chat",
      "start_line": 18252,
      "end_line": 18331,
      "snippet_hash": "4eff3a83f62c8156a0a30b2ce39b2dbbe500790c6b0867728f997b4b1d9a8b4c",
      "excerpt": "async def legacy_chat(request: Request):\n    \"\"\"Legacy /v1/chat compatibility for FrontDenisACTUAL with SSE support.\"\"\"\n    source_hdr = str(request.headers.get(\"X-Denis-Source\") or \"\").strip().lower()\n    if source_hdr in PIPECAT_SOURCE_ID",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:generate_sse",
      "kind": "asyncfunctiondef",
      "name": "generate_sse",
      "start_line": 18305,
      "end_line": 18313,
      "snippet_hash": "20fb2d5efe2bd9dd8ab498f1a2e31ae8583bd617095c8578c8f88dfe5ab51a21",
      "excerpt": "        async def generate_sse():\n            _CALLER_USER_ID.set(str(user_id))\n            _CALLER_ROLES.set([])\n            _CALLER_HOST.set(client_host)\n\n            # process_conversation ahora debe soportar yield de tokens; si no, hace",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:legacy_ws_nlu_stream",
      "kind": "asyncfunctiondef",
      "name": "legacy_ws_nlu_stream",
      "start_line": 18336,
      "end_line": 18379,
      "snippet_hash": "dc560b93491ff6216ecb9e7962c02eefe4543ea4d8b1b6ac1908904a342b4049",
      "excerpt": "async def legacy_ws_nlu_stream(websocket: WebSocket):\n    \"\"\"Legacy WS endpoint for FrontDenisACTUAL hook useDenisWebSocket.\"\"\"\n    await websocket.accept()\n    client_id = f\"wsl_{uuid.uuid4().hex[:8]}\"\n    session_id = f\"ses_{uuid.uuid4().",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:proxy_to_service",
      "kind": "asyncfunctiondef",
      "name": "proxy_to_service",
      "start_line": 18398,
      "end_line": 18467,
      "snippet_hash": "88a6565aaac995d2dc6216993a9350f95e1efccdfcdd4d1004628afd7bd57d3a",
      "excerpt": "async def proxy_to_service(\n    service: str, path: str, method: str = \"GET\", data: dict = None\n):\n    \"\"\"Proxy requests to backend services\"\"\"\n    headers: Dict[str, str] = {}\n    if service == \"hass\":\n        # Pull HA token from secrets ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:voice_health",
      "kind": "asyncfunctiondef",
      "name": "voice_health",
      "start_line": 18472,
      "end_line": 18497,
      "snippet_hash": "7a0f8dace85aed818588273393a23e7738c0ce5c113266e38d6500a3588d48e4",
      "excerpt": "async def voice_health():\n    \"\"\"Voice system health\"\"\"\n    voice = await proxy_to_service(\"voice\", \"/health\")\n    pipecat = await proxy_to_service(\"pipecat\", \"/health\")\n    identity = await proxy_to_service(\"identity\", \"/health\")\n    voice",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:voice_tts",
      "kind": "asyncfunctiondef",
      "name": "voice_tts",
      "start_line": 18501,
      "end_line": 18504,
      "snippet_hash": "beb581a25376d6cef9adac4bf0b4cc40c315c701c46e1d5374ed0acd070faffa",
      "excerpt": "async def voice_tts(request: Request):\n    \"\"\"Text to Speech\"\"\"\n    data = await request.json()\n    return await proxy_to_service(\"voice\", \"/tts\", \"POST\", data)",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:voice_stt",
      "kind": "asyncfunctiondef",
      "name": "voice_stt",
      "start_line": 18508,
      "end_line": 18511,
      "snippet_hash": "464863284a77e3f427f453e12e02a282543b843aeb717a2238e0f12444958205",
      "excerpt": "async def voice_stt(request: Request):\n    \"\"\"Speech to Text via Whisper\"\"\"\n    data = await request.json()\n    return await proxy_to_service(\"whisper\", \"/transcribe\", \"POST\", data)",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_status",
      "kind": "asyncfunctiondef",
      "name": "gps_status",
      "start_line": 18516,
      "end_line": 18522,
      "snippet_hash": "53f7f511373ccf7265231306b6d9d68ded26eeb9cd41ab1ddc1aca8f172c68ce",
      "excerpt": "async def gps_status():\n    \"\"\"GPS system status\"\"\"\n    return {\n        \"status\": \"active\",\n        \"location\": {\"lat\": 41.3851, \"lng\": 2.1734, \"name\": \"Barcelona\"},\n        \"message\": \"GPS service connected\",\n    }",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_location",
      "kind": "asyncfunctiondef",
      "name": "gps_location",
      "start_line": 18526,
      "end_line": 18533,
      "snippet_hash": "f9d3d7d2fcfb13ff801d6f86d04d23de164564fcd787a448ba94186ef00985c4",
      "excerpt": "async def gps_location():\n    \"\"\"Current GPS location\"\"\"\n    return {\n        \"latitude\": 41.3851,\n        \"longitude\": 2.1734,\n        \"accuracy\": 5.0,\n        \"timestamp\": datetime.utcnow().isoformat(),\n    }",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_music_validate_preset",
      "kind": "functiondef",
      "name": "_music_validate_preset",
      "start_line": 18544,
      "end_line": 18574,
      "snippet_hash": "93bdba9c273af9a3e87a94d35d2e5e24be17fbd2f4820f053821d735f56d74a8",
      "excerpt": "def _music_validate_preset(p: Dict[str, Any]) -> Optional[Dict[str, Any]]:\n    try:\n        pid = str(p.get(\"id\") or \"\").strip()\n        name = str(p.get(\"name\") or \"\").strip()\n        url = str(p.get(\"url\") or \"\").strip()\n        kind = st",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_music_load_presets",
      "kind": "functiondef",
      "name": "_music_load_presets",
      "start_line": 18577,
      "end_line": 18611,
      "snippet_hash": "c460212a89e42b98a65d971a9a13a5b852a6e958c123666720e3c442ef82413d",
      "excerpt": "def _music_load_presets(*, bypass_cache: bool = False) -> List[Dict[str, Any]]:\n    now = time.time()\n    if (\n        not bypass_cache\n        and (now - float(_MUSIC_PRESETS_CACHE.get(\"ts\") or 0.0)) < _MUSIC_PRESETS_TTL_S\n    ):\n        r",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_music_save_presets",
      "kind": "functiondef",
      "name": "_music_save_presets",
      "start_line": 18614,
      "end_line": 18636,
      "snippet_hash": "34cf67270d944c8716b2b69f78adc6e9c056b50fc52becb49bce75c95f1524fd",
      "excerpt": "def _music_save_presets(presets: List[Dict[str, Any]]) -> int:\n    valid: List[Dict[str, Any]] = []\n    seen = set()\n    for item in presets or []:\n        if not isinstance(item, dict):\n            continue\n        v = _music_validate_pres",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_music_preset_by_id",
      "kind": "functiondef",
      "name": "_music_preset_by_id",
      "start_line": 18639,
      "end_line": 18646,
      "snippet_hash": "0f3fe8e4397d1987ef1e465b47768aa81a26ab862aa64d29a4f2b79c1b9ea372",
      "excerpt": "def _music_preset_by_id(preset_id: str) -> Optional[Dict[str, Any]]:\n    pid = (preset_id or \"\").strip()\n    if not pid:\n        return None\n    for p in _music_load_presets():\n        if p.get(\"id\") == pid:\n            return p\n    return ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_require_admin_music",
      "kind": "functiondef",
      "name": "_require_admin_music",
      "start_line": 18649,
      "end_line": 18656,
      "snippet_hash": "45e48e68724f4cb5c0b7fc0e0e6147ec99b0210164bc7c60662dba57ad9d55c6",
      "excerpt": "def _require_admin_music(x_denis_admin_key: Optional[str]) -> None:\n    expected = _resolve_admin_key()\n    if not expected:\n        raise HTTPException(\n            status_code=503, detail=\"Admin API disabled (DENIS_ADMIN_KEY missing)\"\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:music_presets",
      "kind": "asyncfunctiondef",
      "name": "music_presets",
      "start_line": 18660,
      "end_line": 18662,
      "snippet_hash": "eb114156d9fcfe4cf0ce407a58377645a705eebef43d307bf833b68520d1a4a9",
      "excerpt": "async def music_presets():\n    \"\"\"List configured presets (configured via file or admin API).\"\"\"\n    return {\"count\": len(_music_load_presets()), \"presets\": _music_load_presets()}",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:music_presets_set",
      "kind": "asyncfunctiondef",
      "name": "music_presets_set",
      "start_line": 18666,
      "end_line": 18678,
      "snippet_hash": "c597048b5a1175a3d526ffa0e4e55439c757d337041f82ce63bbe8d1636e4a7c",
      "excerpt": "async def music_presets_set(\n    request: Request, x_denis_admin_key: Optional[str] = Header(default=None)\n):\n    \"\"\"Replace presets list (admin-only). Body: {\"presets\": [...]} or a JSON list.\"\"\"\n    _require_admin_music(x_denis_admin_key)\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:music_presets_delete",
      "kind": "asyncfunctiondef",
      "name": "music_presets_delete",
      "start_line": 18682,
      "end_line": 18694,
      "snippet_hash": "d35b1f7242e78cdebc71c4bc809706ed4cefa3904f3c121b116fa125e16fc82e",
      "excerpt": "async def music_presets_delete(\n    request: Request, x_denis_admin_key: Optional[str] = Header(default=None)\n):\n    \"\"\"Delete preset by id (admin-only). Body: {\"id\":\"...\"}\"\"\"\n    _require_admin_music(x_denis_admin_key)\n    body = await req",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:music_status",
      "kind": "asyncfunctiondef",
      "name": "music_status",
      "start_line": 18698,
      "end_line": 18717,
      "snippet_hash": "15a92a2f3cc60da986595a380a34e5060e7a73c6ea11d7de60002ffd2f91f23f",
      "excerpt": "async def music_status():\n    \"\"\"Music streaming status (preset-based, configured outside code).\"\"\"\n    presets = _music_load_presets()\n    return {\n        \"status\": \"ready\",\n        \"player\": \"http-stream-proxy\",\n        \"presets_count\": ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:music_play",
      "kind": "asyncfunctiondef",
      "name": "music_play",
      "start_line": 18721,
      "end_line": 18775,
      "snippet_hash": "a7e51429655db15636db799a3b376132b2c5b9b059599e71ad9fabd63d19d385",
      "excerpt": "async def music_play(request: Request):\n    \"\"\"Resolve a stream URL to be played client-side (HTML5 audio).\"\"\"\n    data = await request.json()\n    preset_id = (data.get(\"preset_id\") or \"\").strip()\n    url = (data.get(\"url\") or \"\").strip()\n\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:music_stream",
      "kind": "asyncfunctiondef",
      "name": "music_stream",
      "start_line": 18779,
      "end_line": 18853,
      "snippet_hash": "d9f000d60610e60d238e41f25a3a7d7e45e24b9e05954c81caa042819fd14e9f",
      "excerpt": "async def music_stream(\n    request: Request, preset_id: Optional[str] = None, url: Optional[str] = None\n):\n    \"\"\"Proxy an audio stream to the browser (for iPad/desktop playback).\"\"\"\n    target = None\n    if preset_id:\n        p = _music_p",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gen",
      "kind": "asyncfunctiondef",
      "name": "gen",
      "start_line": 18834,
      "end_line": 18842,
      "snippet_hash": "9dbba27459a9443418088d960407915178c44bfbd491d88f86abd3595228c878",
      "excerpt": "    async def gen():\n        try:\n            async for chunk in upstream.aiter_bytes(chunk_size=64 * 1024):\n                yield chunk\n        finally:\n            try:\n                await upstream.aclose()\n            finally:\n        ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:get_google_calendar_service",
      "kind": "functiondef",
      "name": "get_google_calendar_service",
      "start_line": 18861,
      "end_line": 18898,
      "snippet_hash": "24eab2ea1e2cd8975e3909ae4e21c160559e6156b11adb1d2e4041c1cbbe9c6b",
      "excerpt": "def get_google_calendar_service():\n    \"\"\"Get authenticated Google Calendar service using Service Account.\"\"\"\n    try:\n        if os.path.exists(GOOGLE_SA_CREDENTIALS):\n            from google.oauth2 import service_account\n\n            cred",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:setup_google_auth",
      "kind": "functiondef",
      "name": "setup_google_auth",
      "start_line": 18901,
      "end_line": 18914,
      "snippet_hash": "bc0be7b03fda99d90a002cbbf495e2f38e03df46aa919304da8c541a72b47bac",
      "excerpt": "def setup_google_auth():\n    \"\"\"Setup Google OAuth authentication. Run this once to authenticate.\"\"\"\n    if not os.path.exists(GOOGLE_CREDENTIALS_FILE):\n        print(f\"ERROR: Credentials file not found at {GOOGLE_CREDENTIALS_FILE}\")\n      ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_calendar_events_async",
      "kind": "asyncfunctiondef",
      "name": "get_calendar_events_async",
      "start_line": 18917,
      "end_line": 18944,
      "snippet_hash": "d8e69b03bf3353bbdf2136af96d1bf0eca693fa937de63acd8366cfc1cefb738",
      "excerpt": "async def get_calendar_events_async(max_results: int = 10) -> List[Dict]:\n    \"\"\"Get events from Google Calendar.\"\"\"\n    try:\n        service = get_google_calendar_service()\n        if not service:\n            return []\n\n        now = datet",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:calendar_events",
      "kind": "asyncfunctiondef",
      "name": "calendar_events",
      "start_line": 18949,
      "end_line": 18989,
      "snippet_hash": "8a5e5cd13f56125949cb5e84e85ccd2ce313036299a088960963bf437df3d740",
      "excerpt": "async def calendar_events(max_results: int = 10):\n    \"\"\"Get calendar events from Google Calendar.\"\"\"\n    events = await get_calendar_events_async(max_results)\n\n    if not events:\n        return {\n            \"events\": [],\n            \"sour",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:calendar_create",
      "kind": "asyncfunctiondef",
      "name": "calendar_create",
      "start_line": 18993,
      "end_line": 19036,
      "snippet_hash": "5d162f4608209cbb5b1b051ef630658c7d10aeabbc6bce8aa4028b28a0cf5cdb",
      "excerpt": "async def calendar_create(request: Request):\n    \"\"\"Create a new calendar event.\"\"\"\n    data = await request.json()\n\n    service = get_google_calendar_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Calen",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:calendar_delete",
      "kind": "asyncfunctiondef",
      "name": "calendar_delete",
      "start_line": 19040,
      "end_line": 19051,
      "snippet_hash": "3cec2fbdd926218a6aec37f7530bf759f85d0f61a8d431a8d163b885e7449e48",
      "excerpt": "async def calendar_delete(event_id: str):\n    \"\"\"Delete a calendar event.\"\"\"\n    service = get_google_calendar_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Calendar not configured\"}\n\n    try:\n        s",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:calendar_auth_url",
      "kind": "asyncfunctiondef",
      "name": "calendar_auth_url",
      "start_line": 19055,
      "end_line": 19062,
      "snippet_hash": "1d5c1d1bbf57901b54170e7696868a0b6c8d41d009336d5a0be9ad68a9935ff5",
      "excerpt": "async def calendar_auth_url():\n    \"\"\"Get Google OAuth URL for calendar access.\"\"\"\n    if not os.path.exists(GOOGLE_CREDENTIALS_FILE):\n        return {\"status\": \"error\", \"message\": \"Credentials file not found\"}\n\n    flow = InstalledAppFlow.",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:get_google_photos_service",
      "kind": "functiondef",
      "name": "get_google_photos_service",
      "start_line": 19070,
      "end_line": 19089,
      "snippet_hash": "97d4b163b2ad98779ae662e93ad69d6968d7186e7a2e01eeebd4b4565746ad32",
      "excerpt": "def get_google_photos_service():\n    \"\"\"Get authenticated Google Photos service using Service Account.\"\"\"\n    try:\n        if os.path.exists(GOOGLE_SA_CREDENTIALS):\n            from google.oauth2 import service_account\n\n            creds = ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:photos_list_albums",
      "kind": "asyncfunctiondef",
      "name": "photos_list_albums",
      "start_line": 19093,
      "end_line": 19120,
      "snippet_hash": "ced8603eb4af31b473be19f0ef89a0bf3a65b6dd304bf1f1f460cb07a874e30f",
      "excerpt": "async def photos_list_albums(max_results: int = 20):\n    \"\"\"List Google Photos albums.\"\"\"\n    service = get_google_photos_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Photos not configured\"}\n\n    try:\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:photos_list_mediaitems",
      "kind": "asyncfunctiondef",
      "name": "photos_list_mediaitems",
      "start_line": 19124,
      "end_line": 19165,
      "snippet_hash": "45dc5ba18339f0cd0a197f122d0b1bded33d1c2960373478cf8d243778a10c25",
      "excerpt": "async def photos_list_mediaitems(album_id: str = None, max_results: int = 50):\n    \"\"\"List Google Photos media items.\"\"\"\n    service = get_google_photos_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Pho",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:get_google_contacts_service",
      "kind": "functiondef",
      "name": "get_google_contacts_service",
      "start_line": 19173,
      "end_line": 19192,
      "snippet_hash": "456c1c580d08eb974acc04ec373ed00af28c872d2bd0beeb9595cb84288d20c0",
      "excerpt": "def get_google_contacts_service():\n    \"\"\"Get authenticated Google Contacts service using Service Account.\"\"\"\n    try:\n        if os.path.exists(GOOGLE_SA_CREDENTIALS):\n            from google.oauth2 import service_account\n\n            cred",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:contacts_list",
      "kind": "asyncfunctiondef",
      "name": "contacts_list",
      "start_line": 19196,
      "end_line": 19224,
      "snippet_hash": "2e85f7f8f87924d235d64a0fb2a26176514623936242143bfa40d77473b4491e",
      "excerpt": "async def contacts_list(max_results: int = 100):\n    \"\"\"List Google Contacts.\"\"\"\n    return {\n        \"status\": \"info\",\n        \"message\": \"Google Contacts API requires OAuth user consent. Use /contacts/search instead with service account d",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:contacts_search",
      "kind": "asyncfunctiondef",
      "name": "contacts_search",
      "start_line": 19228,
      "end_line": 19286,
      "snippet_hash": "c87e6fcc05af03dc567f7cd758956aa031c0018a1927561a19b2dfc7718b31e9",
      "excerpt": "async def contacts_search(query: str, max_results: int = 20):\n    \"\"\"Search Google Contacts.\"\"\"\n    service = get_google_contacts_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Contacts not configured\"}\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:get_google_drive_service",
      "kind": "functiondef",
      "name": "get_google_drive_service",
      "start_line": 19294,
      "end_line": 19313,
      "snippet_hash": "13dc7ce0f4fe952684b2550432d3559aa42ced35b5cdf55e07e7eaf03048f04b",
      "excerpt": "def get_google_drive_service():\n    \"\"\"Get authenticated Google Drive service using Service Account.\"\"\"\n    try:\n        if os.path.exists(GOOGLE_SA_CREDENTIALS):\n            from google.oauth2 import service_account\n\n            creds = se",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:drive_list_files",
      "kind": "asyncfunctiondef",
      "name": "drive_list_files",
      "start_line": 19317,
      "end_line": 19352,
      "snippet_hash": "cd3e975a8b9470e0cd689896d8231b7a6ea4a8dffb177d39c48838ded34568b3",
      "excerpt": "async def drive_list_files(folder_id: str = None, max_results: int = 50):\n    \"\"\"List Google Drive files.\"\"\"\n    service = get_google_drive_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Drive not config",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:drive_search",
      "kind": "asyncfunctiondef",
      "name": "drive_search",
      "start_line": 19356,
      "end_line": 19389,
      "snippet_hash": "6f6292f8dbaa47beea91338b8700871ce1cdd902042bdf9f51bd1de2cc3ecd16",
      "excerpt": "async def drive_search(query: str, max_results: int = 20):\n    \"\"\"Search Google Drive files.\"\"\"\n    service = get_google_drive_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Drive not configured\"}\n\n    t",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:drive_upload",
      "kind": "asyncfunctiondef",
      "name": "drive_upload",
      "start_line": 19393,
      "end_line": 19437,
      "snippet_hash": "afc2ca2133cccd53847a977fe3df8f1029954832a9b8c7445662693971f2a3b9",
      "excerpt": "async def drive_upload(request: Request):\n    \"\"\"Upload file to Google Drive.\"\"\"\n    service = get_google_drive_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Drive not configured\"}\n\n    try:\n        dat",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:drive_delete_file",
      "kind": "asyncfunctiondef",
      "name": "drive_delete_file",
      "start_line": 19441,
      "end_line": 19452,
      "snippet_hash": "8cba9a8d13f601812aeb2e68a301e92c34d55d02bab4f5ddf13bfaaef825a45a",
      "excerpt": "async def drive_delete_file(file_id: str):\n    \"\"\"Delete Google Drive file.\"\"\"\n    service = get_google_drive_service()\n    if not service:\n        return {\"status\": \"error\", \"message\": \"Google Drive not configured\"}\n\n    try:\n        servi",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:hass_entities",
      "kind": "asyncfunctiondef",
      "name": "hass_entities",
      "start_line": 19457,
      "end_line": 19459,
      "snippet_hash": "dd569ff09eb048a3b9ad46e842e54e6b8bef47cd271b953e95ac719c0caeff5f",
      "excerpt": "async def hass_entities():\n    \"\"\"Get HA entities\"\"\"\n    return await proxy_to_service(\"hass\", \"/api/states\")",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:hass_call_service",
      "kind": "asyncfunctiondef",
      "name": "hass_call_service",
      "start_line": 19463,
      "end_line": 19468,
      "snippet_hash": "68fec9033ce6671a29741560e98350e5ec798bdaabfb67915736176ee83708a0",
      "excerpt": "async def hass_call_service(domain: str, service: str, request: Request):\n    \"\"\"Call HA service\"\"\"\n    data = await request.json()\n    return await proxy_to_service(\n        \"hass\", f\"/api/services/{domain}/{service}\", \"POST\", data\n    )",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:hass_media_players",
      "kind": "asyncfunctiondef",
      "name": "hass_media_players",
      "start_line": 19477,
      "end_line": 19517,
      "snippet_hash": "165adae2f90df7d9548d0e53d27cead1822c4f14826deb67b9af776a7f859e59",
      "excerpt": "async def hass_media_players():\n    \"\"\"\n    Convenience endpoint for UI/tools: returns only media_player.* entities.\n    Uses the same HA token resolution as /hass/* (secrets backend preferred).\n    \"\"\"\n    raw = await proxy_to_service(\"has",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:HassPlayMediaRequest",
      "kind": "classdef",
      "name": "HassPlayMediaRequest",
      "start_line": 19520,
      "end_line": 19525,
      "snippet_hash": "cfb6c1791f4dea1270f463645bd2ce1c13959d98fdd2fe03ee64a9217ec6cebe",
      "excerpt": "class HassPlayMediaRequest(BaseModel):\n    entity_id: str = Field(..., min_length=1, max_length=200)\n    media_content_id: str = Field(..., min_length=1, max_length=4096)\n    media_content_type: str = Field(\"music\", min_length=1, max_length",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:hass_media_players_play_media",
      "kind": "asyncfunctiondef",
      "name": "hass_media_players_play_media",
      "start_line": 19529,
      "end_line": 19558,
      "snippet_hash": "fa8532b28ab921ed3c75126516c3d2a98d858cb76199a8643376cea259d66ba8",
      "excerpt": "async def hass_media_players_play_media(req: HassPlayMediaRequest):\n    \"\"\"\n    Play a URL on a Home Assistant media_player.\n    Note: HA fetches the URL server-side; ensure it is reachable from HA.\n    \"\"\"\n    payload = {\n        \"entity_i",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:HassMediaCommandRequest",
      "kind": "classdef",
      "name": "HassMediaCommandRequest",
      "start_line": 19561,
      "end_line": 19566,
      "snippet_hash": "7ce09b101bf27edc9f4c2a9a3f5ec332153fba09f57cb19abc3141d262f3e228",
      "excerpt": "class HassMediaCommandRequest(BaseModel):\n    entity_id: str = Field(..., min_length=1, max_length=200)\n    service: str = Field(..., min_length=1, max_length=64)\n    data: Dict[str, Any] = Field(default_factory=dict)\n    user_id: Optional[",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:hass_media_players_command",
      "kind": "asyncfunctiondef",
      "name": "hass_media_players_command",
      "start_line": 19580,
      "end_line": 19608,
      "snippet_hash": "91978a58bebe346379dc3d318fd6001bb1169a6dfc4680f69de6fe8d2b8bf877",
      "excerpt": "async def hass_media_players_command(req: HassMediaCommandRequest):\n    \"\"\"\n    Common media_player commands (safe subset). For anything else, use /hass/services directly.\n    \"\"\"\n    svc = (req.service or \"\").strip()\n    if svc not in _HAS",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:ProposalCreateRequest",
      "kind": "classdef",
      "name": "ProposalCreateRequest",
      "start_line": 19616,
      "end_line": 19629,
      "snippet_hash": "3561046a8cb92ee0a332f180f409a4a561c0a5f9f5d8aa3b1a43a3d09ed8783b",
      "excerpt": "class ProposalCreateRequest(BaseModel):\n    proposal_key: Optional[str] = Field(\n        None,\n        description=\"Optional stable key for deduping proposals. If omitted, a random key is used.\",\n    )\n    title: str = Field(..., min_length",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:ProposalDecisionRequest",
      "kind": "classdef",
      "name": "ProposalDecisionRequest",
      "start_line": 19632,
      "end_line": 19634,
      "snippet_hash": "3f69b707de50d3e4a104f570fa001a0f9a19d0889ffc4400c9d8a9f0312d530a",
      "excerpt": "class ProposalDecisionRequest(BaseModel):\n    note: str = Field(\"\", max_length=4000)\n    decided_by: str = Field(\"admin\", max_length=200)",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:proposals_create",
      "kind": "asyncfunctiondef",
      "name": "proposals_create",
      "start_line": 19638,
      "end_line": 19689,
      "snippet_hash": "67fbcbf11ec95290b49664ba9a98f31d850340fae728f4f2e3cf25ac73014b2c",
      "excerpt": "async def proposals_create(\n    req: ProposalCreateRequest, x_denis_admin_key: Optional[str] = Header(default=None)\n):\n    _require_admin(x_denis_admin_key)\n    if not neo4j_async_driver:\n        raise HTTPException(status_code=503, detail=",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:proposals_list",
      "kind": "asyncfunctiondef",
      "name": "proposals_list",
      "start_line": 19693,
      "end_line": 19710,
      "snippet_hash": "391849c9be2a355f3a14ecf85fa7590bda7a1063f28c2124a045f35781a0ecaf",
      "excerpt": "async def proposals_list(\n    status: str = \"pending\",\n    user_id: Optional[str] = None,\n    limit: int = 50,\n    x_denis_admin_key: Optional[str] = Header(default=None),\n):\n    _require_admin(x_denis_admin_key)\n    if not neo4j_async_driv",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:proposals_approve",
      "kind": "asyncfunctiondef",
      "name": "proposals_approve",
      "start_line": 19714,
      "end_line": 19751,
      "snippet_hash": "09a410fee93017d1ef51b8fe53993d2ee0e4771826024a893c419a3b3c6f9bfb",
      "excerpt": "async def proposals_approve(\n    proposal_id: str,\n    req: ProposalDecisionRequest,\n    x_denis_admin_key: Optional[str] = Header(default=None),\n):\n    _require_admin(x_denis_admin_key)\n    try:\n        node = await neo4j_set_proposal_stat",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:proposals_reject",
      "kind": "asyncfunctiondef",
      "name": "proposals_reject",
      "start_line": 19755,
      "end_line": 19791,
      "snippet_hash": "fe761704356e096408e40764165640052c61c5983bbe8f71e04a0ba913b62475",
      "excerpt": "async def proposals_reject(\n    proposal_id: str,\n    req: ProposalDecisionRequest,\n    x_denis_admin_key: Optional[str] = Header(default=None),\n):\n    _require_admin(x_denis_admin_key)\n    try:\n        node = await neo4j_set_proposal_statu",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_admin_enabled",
      "kind": "functiondef",
      "name": "_admin_enabled",
      "start_line": 19801,
      "end_line": 19802,
      "snippet_hash": "27c4354a69ceafc01e3b44a297dd1c8df7f6ce146b07a0d88b68f44cb1d63c7a",
      "excerpt": "def _admin_enabled() -> bool:\n    return bool(_resolve_admin_key())",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_require_admin",
      "kind": "functiondef",
      "name": "_require_admin",
      "start_line": 19805,
      "end_line": 19812,
      "snippet_hash": "3963df36eee468c2de7df1301e4809c51c7c147b88d48f1e1c250588bd034556",
      "excerpt": "def _require_admin(x_denis_admin_key: Optional[str] = Header(default=None)) -> None:\n    expected = _resolve_admin_key()\n    if not expected:\n        raise HTTPException(\n            status_code=503, detail=\"Admin API disabled (DENIS_ADMIN_",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:SecretSetRequest",
      "kind": "classdef",
      "name": "SecretSetRequest",
      "start_line": 19815,
      "end_line": 19821,
      "snippet_hash": "76fb2f21f0f33a2e9b4bf753cbcbc17fa595639b98bcffa9de5fafeab6eb300d",
      "excerpt": "class SecretSetRequest(BaseModel):\n    key: str = Field(..., min_length=1, max_length=200)\n    value: str = Field(..., min_length=1, max_length=8192)\n    scope: str = Field(\"global\", max_length=64)\n    ttl_s: Optional[int] = Field(None, ge=",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:SecretDeleteRequest",
      "kind": "classdef",
      "name": "SecretDeleteRequest",
      "start_line": 19824,
      "end_line": 19826,
      "snippet_hash": "7e576afb9c24dd9a05f9c499712540e4f4b22d5a18fa0700f9c40c3a260794a0",
      "excerpt": "class SecretDeleteRequest(BaseModel):\n    key: str = Field(..., min_length=1, max_length=200)\n    scope: str = Field(\"global\", max_length=64)",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:secrets_status",
      "kind": "asyncfunctiondef",
      "name": "secrets_status",
      "start_line": 19830,
      "end_line": 19880,
      "snippet_hash": "cc3001b2fc0bf99c2a5dad01d3380f5a50c7f6fc7439bef828ce8584fac4b45b",
      "excerpt": "async def secrets_status():\n    \"\"\"Non-sensitive status (no values).\"\"\"\n    master, master_src = _resolve_secrets_master_key_with_source()\n    master_present = bool(master)\n    sealed = not master_present\n    redis_ok = bool(redis_client)\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:secrets_keys",
      "kind": "asyncfunctiondef",
      "name": "secrets_keys",
      "start_line": 19884,
      "end_line": 19912,
      "snippet_hash": "22edfe9fb30e6f4e8429186942adb567a5edb2c193c7fde8bef3eb278fb62326",
      "excerpt": "async def secrets_keys(\n    scope: str = \"global\",\n    limit: int = 200,\n    x_denis_admin_key: Optional[str] = Header(default=None),\n):\n    _require_admin(x_denis_admin_key)\n    if not secrets_backend:\n        raise HTTPException(\n        ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:secrets_set",
      "kind": "asyncfunctiondef",
      "name": "secrets_set",
      "start_line": 19916,
      "end_line": 19940,
      "snippet_hash": "213a581297b91747c37e95fcdb1dd88021b411edbbb9d61b8a6f75cc3aa5e9c1",
      "excerpt": "async def secrets_set(\n    req: SecretSetRequest, x_denis_admin_key: Optional[str] = Header(default=None)\n):\n    _require_admin(x_denis_admin_key)\n    if not secrets_backend:\n        raise HTTPException(\n            status_code=503, detail=",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:secrets_delete",
      "kind": "asyncfunctiondef",
      "name": "secrets_delete",
      "start_line": 19944,
      "end_line": 19953,
      "snippet_hash": "b5ce0b5d584deda73287bb5300f8e276d37b61e1437a850c44b802827d18b469",
      "excerpt": "async def secrets_delete(\n    req: SecretDeleteRequest, x_denis_admin_key: Optional[str] = Header(default=None)\n):\n    _require_admin(x_denis_admin_key)\n    if not secrets_backend:\n        raise HTTPException(\n            status_code=503, d",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:UserVaultSetRequest",
      "kind": "classdef",
      "name": "UserVaultSetRequest",
      "start_line": 19961,
      "end_line": 19967,
      "snippet_hash": "479f60c6297d8526cc53869606bac439d8a6e94d423acf4e16e1082863c1b979",
      "excerpt": "class UserVaultSetRequest(BaseModel):\n    key: str = Field(..., min_length=1, max_length=200)\n    value: Optional[str] = Field(None, max_length=8192)\n    value_json: Optional[Dict[str, Any]] = None\n    ttl_s: Optional[int] = Field(None, ge=",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:UserVaultSetResponse",
      "kind": "classdef",
      "name": "UserVaultSetResponse",
      "start_line": 19970,
      "end_line": 19977,
      "snippet_hash": "97bc474e4acaf1eef43819c814c5180836e0f910c2858d475c5725689cd51e97",
      "excerpt": "class UserVaultSetResponse(BaseModel):\n    ok: bool\n    key: str\n    scope: str\n    fingerprint: str\n    masked: str\n    updated_at: str\n    ttl_s: Optional[int] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_user_vault_scope",
      "kind": "functiondef",
      "name": "_user_vault_scope",
      "start_line": 19980,
      "end_line": 19981,
      "snippet_hash": "be03793a8f8979cc28afd4d6e5257f5dcff2b555588c2285a61c4e7d3bb6d2ce",
      "excerpt": "def _user_vault_scope(user_id: str) -> str:\n    return f\"user:{str(user_id)[:128]}\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:vault_me_status",
      "kind": "asyncfunctiondef",
      "name": "vault_me_status",
      "start_line": 19985,
      "end_line": 19994,
      "snippet_hash": "56123d78a83e27f3ca47e461276fd57bcd69836888fd208efc132a409de89fde",
      "excerpt": "async def vault_me_status(current_user: User = Depends(get_current_user)):\n    if not secrets_backend:\n        raise HTTPException(\n            status_code=503, detail=\"Secrets backend sealed/unavailable\"\n        )\n    return {\n        \"ok\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:vault_me_keys",
      "kind": "asyncfunctiondef",
      "name": "vault_me_keys",
      "start_line": 19998,
      "end_line": 20026,
      "snippet_hash": "a09bc1546eb90714ae268010659dff54666805fdc61d5b2b0a922c13ac187c58",
      "excerpt": "async def vault_me_keys(\n    limit: int = 200,\n    current_user: User = Depends(get_current_user),\n):\n    if not secrets_backend:\n        raise HTTPException(\n            status_code=503, detail=\"Secrets backend sealed/unavailable\"\n        ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:vault_me_set",
      "kind": "asyncfunctiondef",
      "name": "vault_me_set",
      "start_line": 20030,
      "end_line": 20074,
      "snippet_hash": "755422aca0a3b39e61d5c332ddaa454236de648cde625ac93be0fe0b3fc924a0",
      "excerpt": "async def vault_me_set(\n    req: UserVaultSetRequest,\n    current_user: User = Depends(get_current_user),\n):\n    if not secrets_backend:\n        raise HTTPException(\n            status_code=503, detail=\"Secrets backend sealed/unavailable\"\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:OwnerProfileRequest",
      "kind": "classdef",
      "name": "OwnerProfileRequest",
      "start_line": 20077,
      "end_line": 20088,
      "snippet_hash": "79aba8740225181d5f00545341aba3c3fddeec932e15231aa21ecfaa8bffd860",
      "excerpt": "class OwnerProfileRequest(BaseModel):\n    preferred_name: str = Field(..., min_length=1, max_length=100)\n    full_name: Optional[str] = Field(None, max_length=200)\n    pronouns: Optional[str] = Field(None, max_length=64)\n    timezone: Optio",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:vault_me_profile",
      "kind": "asyncfunctiondef",
      "name": "vault_me_profile",
      "start_line": 20092,
      "end_line": 20116,
      "snippet_hash": "9fde88983eefaad55fa126df82a231a5f58e48652925e21766d1e41b142bde8b",
      "excerpt": "async def vault_me_profile(\n    req: OwnerProfileRequest,\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Convenience endpoint: stores your \"owner profile\" in your user vault.\n    Key: profile.owner.v1 (scope=user:<user_i",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:nextcloud_status",
      "kind": "asyncfunctiondef",
      "name": "nextcloud_status",
      "start_line": 20121,
      "end_line": 20123,
      "snippet_hash": "992108b239eedb044b7d854bf5b163668649bcb4bb4e1d28cb9a80d7bab3bf4f",
      "excerpt": "async def nextcloud_status():\n    \"\"\"Nextcloud status\"\"\"\n    return await proxy_to_service(\"nextcloud\", \"/status.php\")",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:neo4j_dashboard",
      "kind": "asyncfunctiondef",
      "name": "neo4j_dashboard",
      "start_line": 20128,
      "end_line": 20161,
      "snippet_hash": "db9c14840d0071755ab1269e1bbed3f243fccc88c9000ecb5aadc857c1e34db7",
      "excerpt": "async def neo4j_dashboard():\n    \"\"\"Neo4j dashboard data\"\"\"\n    try:\n        driver = neo4j_async_driver\n        close_driver = False\n        if driver is None:\n            cfg = resolve_neo4j_config()\n            globals()[\"NEO4J_URI\"] = c",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:system_services",
      "kind": "asyncfunctiondef",
      "name": "system_services",
      "start_line": 20166,
      "end_line": 20178,
      "snippet_hash": "f025b8a1308788f39b25cdcd64538547e0112fa0fdb77f9d86311dd4f5c626c5",
      "excerpt": "async def system_services():\n    \"\"\"Get all service statuses\"\"\"\n    return {\n        \"services\": {\n            \"persona\": \"online\",\n            \"voice\": \"online\",\n            \"hass\": \"online\",\n            \"nextcloud\": \"online\",\n            ",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:build_system_manifest",
      "kind": "functiondef",
      "name": "build_system_manifest",
      "start_line": 20181,
      "end_line": 20241,
      "snippet_hash": "e09a2dffd4cc8ebf8049a88fe66d7b9b85851697da268c9fe17ea38a0d1b0ab7",
      "excerpt": "def build_system_manifest() -> Dict[str, Any]:\n    \"\"\"\n    Lightweight, non-sensitive system manifest so Denis can reason about its own stack.\n    Avoid absolute filesystem paths and never include credentials/secrets.\n    \"\"\"\n    return {\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:system_manifest",
      "kind": "asyncfunctiondef",
      "name": "system_manifest",
      "start_line": 20245,
      "end_line": 20246,
      "snippet_hash": "d0776733551aecafd945addbf3c4720b800564c1a8eda7354a13d07a11d1c6e2",
      "excerpt": "async def system_manifest():\n    return build_system_manifest()",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:relationships_dashboard",
      "kind": "asyncfunctiondef",
      "name": "relationships_dashboard",
      "start_line": 20250,
      "end_line": 20261,
      "snippet_hash": "35f96fb9f06b02efb7e33c95c6908f01d5c85ceae8dc0a32694dc5e58b8535ef",
      "excerpt": "async def relationships_dashboard(user_id: str = \"Jotah\"):\n    \"\"\"Dashboard endpoint for relationships visualization and health metrics.\"\"\"\n    try:\n        health = await execute_persona_tool(\n            \"track_relationship_health\", {\"use",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:ToolExecuteRequest",
      "kind": "classdef",
      "name": "ToolExecuteRequest",
      "start_line": 20269,
      "end_line": 20272,
      "snippet_hash": "191f2e301e532f5f94571d3e393ab9025dd28dcd4251dcf72f31f9057b624b68",
      "excerpt": "class ToolExecuteRequest(BaseModel):\n    tool_id: str\n    params: Dict[str, Any] = {}\n    user_id: str = \"Jotah\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:list_tools",
      "kind": "asyncfunctiondef",
      "name": "list_tools",
      "start_line": 20276,
      "end_line": 20310,
      "snippet_hash": "000187b42d6df9853f780de015070d27a5d9ff2ab0681de500db5dd4360bf43e",
      "excerpt": "async def list_tools():\n    \"\"\"List all available tools from the Tool Executor.\"\"\"\n    try:\n        async with httpx.AsyncClient(timeout=10.0) as client:\n            resp = await client.get(f\"{TOOL_EXECUTOR_URL}/tools\")\n            if resp.",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:tools_execute",
      "kind": "asyncfunctiondef",
      "name": "tools_execute",
      "start_line": 20314,
      "end_line": 20336,
      "snippet_hash": "10b4dd1721d4a224e19c5dfcfcebcc5277fb01a70ee5c59e24ecd02aff4ba9ba",
      "excerpt": "async def tools_execute(req: ToolExecuteRequest):\n    \"\"\"Execute a specific tool directly via the Tool Executor.\"\"\"\n    tid = trace_id()\n    logger.info(f\"[TOOL-API] Direct execute: {req.tool_id} trace={tid}\")\n\n    result = await execute_to",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:tools_search",
      "kind": "asyncfunctiondef",
      "name": "tools_search",
      "start_line": 20340,
      "end_line": 20353,
      "snippet_hash": "fd3fc18df8ce0845cbdb605b3e982bc11acd2aa047d202518bf2022d7cea8f4a",
      "excerpt": "async def tools_search(request: Request):\n    \"\"\"Search tools by description using semantic search.\"\"\"\n    body = await request.json()\n    query = body.get(\"query\", \"\")\n    try:\n        async with httpx.AsyncClient(timeout=10.0) as client:\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:tools_health",
      "kind": "asyncfunctiondef",
      "name": "tools_health",
      "start_line": 20357,
      "end_line": 20368,
      "snippet_hash": "a3c6c44e4ea0703110dfad880d22f42dbb45899a585762abd13bdf163f88bfee",
      "excerpt": "async def tools_health():\n    \"\"\"Check Tool Executor health.\"\"\"\n    try:\n        async with httpx.AsyncClient(timeout=5.0) as client:\n            resp = await client.get(f\"{TOOL_EXECUTOR_URL}/health\")\n            if resp.status_code == 200:",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:tools_stats",
      "kind": "asyncfunctiondef",
      "name": "tools_stats",
      "start_line": 20372,
      "end_line": 20395,
      "snippet_hash": "a89274cd82a35215db15e907863d94d303a838ebbdeb9e2b6eb48a06aa0dc8bf",
      "excerpt": "async def tools_stats():\n    \"\"\"Get tool usage statistics.\"\"\"\n    local_tools_total = len(TOOL_REGISTRY) if isinstance(TOOL_REGISTRY, dict) else 0\n    try:\n        # Get stats from tool executor\n        async with httpx.AsyncClient(timeout=",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:chat_experimental_endpoint",
      "kind": "asyncfunctiondef",
      "name": "chat_experimental_endpoint",
      "start_line": 20399,
      "end_line": 20432,
      "snippet_hash": "fafd8631fb662568a332fb630a41c9a06aa40be38db6141ba7328ceb8abc61b8",
      "excerpt": "async def chat_experimental_endpoint(request: Request):\n    \"\"\"\n    SSE Grafo-style endpoint with typed events.\n    Emits 8-15 granular events per interaction:\n    thinking, graph_query, graph_result, tool_start/end, speech, memory_store, d",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:event_generator",
      "kind": "asyncfunctiondef",
      "name": "event_generator",
      "start_line": 20415,
      "end_line": 20426,
      "snippet_hash": "3a1cec131fdc1e989914b03470b48c99246c22bb70d04464472c635cf0a5ea42",
      "excerpt": "    async def event_generator():\n        try:\n            async for event in generate_conversation_events_real(\n                text, user_id, session_id\n            ):\n                event_type = event.get(\"type\", \"message\")\n             ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:hakuna_matata_status",
      "kind": "asyncfunctiondef",
      "name": "hakuna_matata_status",
      "start_line": 20436,
      "end_line": 20457,
      "snippet_hash": "9dc21e3e30d76eba4232bc444baf97e269d02cfda8da5e5b4c9e2b6c58b108dd",
      "excerpt": "async def hakuna_matata_status():\n    \"\"\"Get last Hakuna Matata cycle status from Redis.\"\"\"\n    if redis_client:\n        try:\n            data = await redis_client.get(\"hakuna_matata:last_cycle\")\n            if data:\n                return ",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:InterviewStartRequest",
      "kind": "classdef",
      "name": "InterviewStartRequest",
      "start_line": 20465,
      "end_line": 20470,
      "snippet_hash": "2d64255510130b9eacec6100b3fcb382caf45c14c0abaa4b43cf2f35af747b89",
      "excerpt": "class InterviewStartRequest(BaseModel):\n    interview_type: str  # \"discovery\", \"enrich\", \"validate\"\n    target_domain: str  # \"service\", \"infrastructure\", \"persona\", \"process\"\n    user_id: str = \"jotah\"\n    session_id: Optional[str] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:InterviewAnswerRequest",
      "kind": "classdef",
      "name": "InterviewAnswerRequest",
      "start_line": 20473,
      "end_line": 20475,
      "snippet_hash": "1ed7b0f721bf2aa665d41a56e124bde162bc68b2a48aafb59770face81d99f23",
      "excerpt": "class InterviewAnswerRequest(BaseModel):\n    question_id: str\n    answer: str",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:start_interview_endpoint",
      "kind": "asyncfunctiondef",
      "name": "start_interview_endpoint",
      "start_line": 20479,
      "end_line": 20516,
      "snippet_hash": "ea441e679fb2ec0b2ace91ec9d0bebdba9db450b37bf7e7267edddab367e1ecb",
      "excerpt": "async def start_interview_endpoint(req: InterviewStartRequest):\n    \"\"\"Inicia una entrevista guiada para autodescubrimiento del grafo\"\"\"\n    try:\n        # Create interview engine instance\n        interview_engine = InterviewEngine(\n       ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:submit_interview_answer_endpoint",
      "kind": "asyncfunctiondef",
      "name": "submit_interview_answer_endpoint",
      "start_line": 20520,
      "end_line": 20557,
      "snippet_hash": "4ab06ba388ed6619c5972d9dd3a5f9546afe1ba20ed283e404b30eda53fca745",
      "excerpt": "async def submit_interview_answer_endpoint(req: InterviewAnswerRequest):\n    \"\"\"EnvÃ­a una respuesta a la pregunta actual de la entrevista\"\"\"\n    try:\n        # Create interview engine instance\n        interview_engine = InterviewEngine(\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_interview_status_endpoint",
      "kind": "asyncfunctiondef",
      "name": "get_interview_status_endpoint",
      "start_line": 20561,
      "end_line": 20601,
      "snippet_hash": "c0238e9a3d1c16bed40fa4be6d80e57bc20a9a1f71ae45a93880c6347553f198",
      "excerpt": "async def get_interview_status_endpoint(interview_id: str):\n    \"\"\"Consulta estado de una entrevista en curso o completada\"\"\"\n    try:\n        async with neo4j_async_driver.session() as session:\n            result = await session.run(\n     ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:list_interviews",
      "kind": "asyncfunctiondef",
      "name": "list_interviews",
      "start_line": 20605,
      "end_line": 20646,
      "snippet_hash": "67755875acc58a9e0653e8539c5987e069d671c00642317d62f661f02d92f817",
      "excerpt": "async def list_interviews(user_id: str = \"jotah\", limit: int = 10):\n    \"\"\"Lista entrevistas del usuario ordenadas por fecha\"\"\"\n    try:\n        async with neo4j_async_driver.session() as session:\n            result = await session.run(\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_prefetch_context",
      "kind": "asyncfunctiondef",
      "name": "_prefetch_context",
      "start_line": 20654,
      "end_line": 20734,
      "snippet_hash": "3f0da4ed03ae815bb9ad40630b08f6548155d123b6572785dd006f337c528abf",
      "excerpt": "async def _prefetch_context(\n    user_id: str, session_id: Optional[str], partial_text: str, text_hash: str\n) -> Dict:\n    \"\"\"\n    Execute preparatory work while user is still typing.\n    Returns context dict to be cached and used when fina",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_prefetch_intent",
      "kind": "asyncfunctiondef",
      "name": "_prefetch_intent",
      "start_line": 20737,
      "end_line": 20754,
      "snippet_hash": "05f92306173be5ed3aeb29de140c5c0f56f0348e890aba0666864474d7d7f4c1",
      "excerpt": "async def _prefetch_intent(text: str) -> Optional[str]:\n    \"\"\"Heuristic intent guess (no network).\"\"\"\n    tl = text.lower()\n    if any(kw in tl for kw in [\"configurar\", \"instalar\", \"setup\", \"config\"]):\n        return \"configure\"\n    if any",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_prefetch_rag",
      "kind": "asyncfunctiondef",
      "name": "_prefetch_rag",
      "start_line": 20757,
      "end_line": 20768,
      "snippet_hash": "a5348dbea49026b45478b5b43ebc0e6c43c9648584a8408a1e2bdb508f036af4",
      "excerpt": "async def _prefetch_rag(text: str) -> list:\n    \"\"\"Pre-load RAG context from Qdrant.\"\"\"\n    if len(text) < 10:\n        return []\n    try:\n        rag_context = await rag_get_context(text, \"dialog\")\n        if not rag_context:\n            re",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_prefetch_people",
      "kind": "asyncfunctiondef",
      "name": "_prefetch_people",
      "start_line": 20771,
      "end_line": 20794,
      "snippet_hash": "d8966ab53ae02a77f989ce9e5b8a74e01c3b3fce53c5006e44ed22ca405aa28c",
      "excerpt": "async def _prefetch_people(text: str, user_id: str) -> list:\n    \"\"\"Detect mentioned people and pre-load from Neo4j.\"\"\"\n    potential_names = re.findall(r\"\\b[A-Z][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+\\b\", text)\n    if not potential_names or not neo4j_async_driver:\n ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_prefetch_tools",
      "kind": "asyncfunctiondef",
      "name": "_prefetch_tools",
      "start_line": 20797,
      "end_line": 20822,
      "snippet_hash": "563096dacebb7d1c041a5ffdf88e12815ded152da57222250e10269ce9c40656",
      "excerpt": "async def _prefetch_tools(text: str, user_id: str) -> list:\n    \"\"\"Predict likely tools based on keywords in partial text.\"\"\"\n    tools = []\n    tl = text.lower()\n\n    if any(kw in tl for kw in [\"tailscale\", \"red\", \"network\", \"conectividad\"",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_neo4j_log_prefetch_event",
      "kind": "asyncfunctiondef",
      "name": "_neo4j_log_prefetch_event",
      "start_line": 20825,
      "end_line": 20860,
      "snippet_hash": "4d500ecee59b5ebe5b5d8ff865a7ca50e099b991f791eb9882ae51968e1bb900",
      "excerpt": "async def _neo4j_log_prefetch_event(\n    user_id: str, text_hash: str, intent: str, hit: bool, latency_ms: float\n):\n    \"\"\"Log prefetch event to Neo4j for analytics and learning.\"\"\"\n    if not neo4j_async_driver:\n        return\n    try:\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:_neo4j_log_correction_event",
      "kind": "asyncfunctiondef",
      "name": "_neo4j_log_correction_event",
      "start_line": 20863,
      "end_line": 20904,
      "snippet_hash": "3d0a91825b6d15432cf813206c0f6479e9c8ee9afd2a794a14bfe61a344184ac",
      "excerpt": "async def _neo4j_log_correction_event(\n    *,\n    user_id: str,\n    session_id: str,\n    trace_id_val: str,\n    original_intent: str,\n    original_text: str,\n    corrected_text: str,\n) -> None:\n    \"\"\"\n    Persist a lightweight correction r",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:websocket_prefetch",
      "kind": "asyncfunctiondef",
      "name": "websocket_prefetch",
      "start_line": 20908,
      "end_line": 21035,
      "snippet_hash": "3108c9e0b3cfc3b663e8608524ed8cbc482b1918cd568e5b36c89379381d590f",
      "excerpt": "async def websocket_prefetch(websocket: WebSocket):\n    \"\"\"\n    Predictive Context Loading WebSocket.\n    Captures partial text as user types and pre-loads context\n    (RAG, intent, Neo4j, tools) so response is near-instant on submit.\n    P",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:prefetch_metrics_endpoint",
      "kind": "asyncfunctiondef",
      "name": "prefetch_metrics_endpoint",
      "start_line": 21039,
      "end_line": 21073,
      "snippet_hash": "3eac82b50733620457001d6d829f0a9765188becd0e7e9a8e544dae06327aa67",
      "excerpt": "async def prefetch_metrics_endpoint():\n    \"\"\"Prefetch system metrics and effectiveness.\"\"\"\n    total = PREFETCH_METRICS[\"hits\"] + PREFETCH_METRICS[\"misses\"]\n    hit_rate = (PREFETCH_METRICS[\"hits\"] / total * 100) if total > 0 else 0\n    to",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:mental_router_metrics",
      "kind": "asyncfunctiondef",
      "name": "mental_router_metrics",
      "start_line": 21077,
      "end_line": 21113,
      "snippet_hash": "4dcf29cef8b1507b202dc81a4f9a9dbb723bc5260a4283df1b7bddb9c9e13fae",
      "excerpt": "async def mental_router_metrics():\n    total = int(MENTAL_ROUTER_METRICS.get(\"total\") or 0)\n    deep = int(MENTAL_ROUTER_METRICS.get(\"deep_deliberation\") or 0)\n    verifier = int(MENTAL_ROUTER_METRICS.get(\"verifier_runs\") or 0)\n    deep_rat",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:inference_router_metrics",
      "kind": "asyncfunctiondef",
      "name": "inference_router_metrics",
      "start_line": 21117,
      "end_line": 21163,
      "snippet_hash": "2e32c01c7d7399c86edadf45f02856f0e2c953b472801330dd43dbfb09e62b1c",
      "excerpt": "async def inference_router_metrics():\n    def _sanitize_pool(name: str) -> Dict[str, Any]:\n        pool = _PROVIDER_KEY_POOLS.get(name) or []\n        now = time.time()\n        return {\n            \"keys_total\": len(pool),\n            \"keys_",
      "synthetic": false
    },
    {
      "anchor_id": "A:functiondef:_sanitize_pool",
      "kind": "functiondef",
      "name": "_sanitize_pool",
      "start_line": 21118,
      "end_line": 21129,
      "snippet_hash": "3f907f62bb0efb3e315339c3248399b73dfe953d3053a2f920a2519f6e4090ef",
      "excerpt": "    def _sanitize_pool(name: str) -> Dict[str, Any]:\n        pool = _PROVIDER_KEY_POOLS.get(name) or []\n        now = time.time()\n        return {\n            \"keys_total\": len(pool),\n            \"keys_enabled\": sum(1 for k in pool if not b",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:prefetch_clear_cache",
      "kind": "asyncfunctiondef",
      "name": "prefetch_clear_cache",
      "start_line": 21167,
      "end_line": 21180,
      "snippet_hash": "3df2bb4cdcf5612ffa27b59776535ccdefd97490567f16ec898610d939dfe735",
      "excerpt": "async def prefetch_clear_cache():\n    \"\"\"Clear all prefetch caches.\"\"\"\n    count = sum(len(v) for v in PREFETCH_CACHE.values())\n    PREFETCH_CACHE.clear()\n    mental_count = sum(len(v) for v in MENTAL_CONTROL_CACHE.values())\n    MENTAL_CONT",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:websocket_events_stream",
      "kind": "asyncfunctiondef",
      "name": "websocket_events_stream",
      "start_line": 21184,
      "end_line": 21222,
      "snippet_hash": "703865910893454281a64b7b09fd4d3e4a54880f60811fe079fdb9a6a2be1670",
      "excerpt": "async def websocket_events_stream(websocket: WebSocket, session_id: str):\n    \"\"\"\n    WebSocket event stream for frontend bus consumers.\n    Mirrors /v1/events/stream semantics without SSE.\n    \"\"\"\n    await websocket.accept()\n\n    user_id ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:events_stream",
      "kind": "asyncfunctiondef",
      "name": "events_stream",
      "start_line": 21226,
      "end_line": 21273,
      "snippet_hash": "980b7be59e0b4ab0b2baebd7fb555024a824c82a4484601ff79cd88870be6c92",
      "excerpt": "async def events_stream(\n    request: Request,\n    session_id: str,\n    user_id: str,\n    ticket: Optional[str] = None,\n):\n    \"\"\"\n    SSE stream de eventos para una sesiÃ³n especÃ­fica\n    Frontend se conecta aquÃ­ para recibir progress updat",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:event_generator",
      "kind": "asyncfunctiondef",
      "name": "event_generator",
      "start_line": 21247,
      "end_line": 21267,
      "snippet_hash": "58935cbfc26ab7da074c97cb5817c87378980c6691c4fc44a5212f20f1496f65",
      "excerpt": "    async def event_generator():\n        try:\n            # Enviar historial reciente primero\n            history = event_bus.get_history(session_id, limit=10)\n            for event in history:\n                yield f\"data: {json.dumps(data",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:UiMediaEventRequest",
      "kind": "classdef",
      "name": "UiMediaEventRequest",
      "start_line": 21276,
      "end_line": 21287,
      "snippet_hash": "ce1151b1fb481e0e553f87ef73ada979f5f76eaa895f4e4856971457e4e057dd",
      "excerpt": "class UiMediaEventRequest(BaseModel):\n    session_id: str\n    user_id: str = \"Jotah\"\n    url: str\n    media_type: str = \"iframe\"\n    action: str  # play|pause|ended|time|volume|error\n    current_time: Optional[float] = None\n    duration: Op",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:UiMediaCommandRequest",
      "kind": "classdef",
      "name": "UiMediaCommandRequest",
      "start_line": 21290,
      "end_line": 21296,
      "snippet_hash": "c17f30761de520fe325c76176399563bc793d1960b213a083bdf75f78460c4d1",
      "excerpt": "class UiMediaCommandRequest(BaseModel):\n    session_id: str\n    user_id: str = \"Jotah\"\n    action: str  # play|pause|stop|mute|unmute|seek|set_volume\n    url: Optional[str] = None\n    seek_to: Optional[float] = None\n    volume: Optional[flo",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:GpsRouteRequest",
      "kind": "classdef",
      "name": "GpsRouteRequest",
      "start_line": 21299,
      "end_line": 21303,
      "snippet_hash": "6a8409fdf7a9622c11e752dc0e5f211f4e4640236bfb046de66efba206477d5c",
      "excerpt": "class GpsRouteRequest(BaseModel):\n    destination: str = Field(..., min_length=2, max_length=200)\n    origin: Optional[str] = Field(None, max_length=200)\n    user_id: str = \"Jotah\"\n    session_id: Optional[str] = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_gps_status",
      "kind": "asyncfunctiondef",
      "name": "v1_gps_status",
      "start_line": 21307,
      "end_line": 21321,
      "snippet_hash": "a9cdb98f74999a681340d4268e0163a1ae0e076f781edf152ffdf1b0e861782d",
      "excerpt": "async def v1_gps_status():\n    \"\"\"\n    Returns GPS service status and availability\n    \"\"\"\n    return {\n        \"ok\": True,\n        \"status\": \"available\",\n        \"services\": {\n            \"geocoding\": True,\n            \"routing\": True,\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_gps_location",
      "kind": "asyncfunctiondef",
      "name": "v1_gps_location",
      "start_line": 21325,
      "end_line": 21386,
      "snippet_hash": "c2819f71efd674353ce46a42ec2ce9915a1f670a0929bc7ed9b62189d747095d",
      "excerpt": "async def v1_gps_location(current_user: Optional[User] = None):\n    \"\"\"\n    Get current location from user's registered GPS devices\n    Public endpoint - works without authentication (returns default location)\n    \"\"\"\n    try:\n        # Try",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_gps_route",
      "kind": "asyncfunctiondef",
      "name": "v1_gps_route",
      "start_line": 21390,
      "end_line": 21418,
      "snippet_hash": "2ce3d405034b2380ebef97647a92f4a9390900389398d58ef4b728634f38ee92",
      "excerpt": "async def v1_gps_route(req: GpsRouteRequest):\n    \"\"\"\n    Deterministic GPS helper (no LLM):\n    - Builds map URLs for origin->destination when origin is known,\n      otherwise destination-only URLs.\n    - Emits an event so the frontend can",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_gps_places",
      "kind": "asyncfunctiondef",
      "name": "v1_gps_places",
      "start_line": 21422,
      "end_line": 21471,
      "snippet_hash": "035e82e281c665d0e1a4f7ece90d1042843df03bf17eb6bf9e423813d176d3bd",
      "excerpt": "async def v1_gps_places(query: str, limit: int = 10):\n    \"\"\"\n    Search for places using Nominatim (OpenStreetMap).\n    Returns places matching the query.\n    \"\"\"\n    if not query or len(query) < 2:\n        return []\n\n    try:\n        clie",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:v1_gps_geocode",
      "kind": "asyncfunctiondef",
      "name": "v1_gps_geocode",
      "start_line": 21475,
      "end_line": 21513,
      "snippet_hash": "7cb7fa0a5b071422db42c1b13547a5ddcd3c2bf0e68da6132302bd0de1734a1e",
      "excerpt": "async def v1_gps_geocode(address: str):\n    \"\"\"\n    Geocode an address to coordinates using Nominatim.\n    \"\"\"\n    if not address:\n        raise HTTPException(400, \"address is required\")\n\n    try:\n        client = http_client or httpx.Async",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:ui_media_event",
      "kind": "asyncfunctiondef",
      "name": "ui_media_event",
      "start_line": 21517,
      "end_line": 21548,
      "snippet_hash": "4d363ba54944afc3dbaeb65a90b350841b66e6396c45ab79a376c6015815917a",
      "excerpt": "async def ui_media_event(req: UiMediaEventRequest):\n    \"\"\"\n    Frontend -> backend media telemetry for sync + Denis awareness.\n    Updates Redis media state and publishes to event bus.\n    \"\"\"\n    state = await ui_media_get_state(req.sessi",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:ui_media_state",
      "kind": "asyncfunctiondef",
      "name": "ui_media_state",
      "start_line": 21552,
      "end_line": 21554,
      "snippet_hash": "efeffe12a1d9c7849cf3f9ef1779d1c8cdde5711b3abfb35919875ba4cd91275",
      "excerpt": "async def ui_media_state(session_id: str, user_id: str = \"Jotah\"):\n    state = await ui_media_get_state(session_id, user_id) or {}\n    return {\"ok\": True, \"session_id\": session_id, \"user_id\": user_id, \"state\": state}",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:ui_media_command",
      "kind": "asyncfunctiondef",
      "name": "ui_media_command",
      "start_line": 21558,
      "end_line": 21576,
      "snippet_hash": "bfe57e5e42c5392a8ac5e437e6717fe11018e06cc0fec5dc035314a47db5f2a8",
      "excerpt": "async def ui_media_command(req: UiMediaCommandRequest):\n    \"\"\"\n    Backend -> frontend media control.\n    Emits a command into the event bus so any connected UI can act immediately.\n    \"\"\"\n    payload = {\n        \"session_id\": req.session",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_gps_service",
      "kind": "asyncfunctiondef",
      "name": "get_gps_service",
      "start_line": 21587,
      "end_line": 21595,
      "snippet_hash": "b30a59b5b37c92c6f4af257565e005b1d9338af4c1f646d1009948708cc081bb",
      "excerpt": "async def get_gps_service() -> \"DenisGPSService\":\n    \"\"\"Get or create GPS service singleton.\"\"\"\n    global _gps_service\n    if _gps_service is None:\n        from integrations.denis_gps_service import DenisGPSService\n\n        _gps_service =",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:shutdown_gps_service",
      "kind": "asyncfunctiondef",
      "name": "shutdown_gps_service",
      "start_line": 21599,
      "end_line": 21604,
      "snippet_hash": "ee751321ee4f4d17bcac09e0a3f75e2810739c36a5c6706e62b76cfd10248767",
      "excerpt": "async def shutdown_gps_service():\n    \"\"\"Cleanup GPS service on shutdown.\"\"\"\n    global _gps_service\n    if _gps_service:\n        await _gps_service.close()\n        _gps_service = None",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:GPSDeviceRequest",
      "kind": "classdef",
      "name": "GPSDeviceRequest",
      "start_line": 21607,
      "end_line": 21608,
      "snippet_hash": "dfabeeaf84c1b07ddbca244be322d195b839ba44869f9e253c84a4a293d7b6da",
      "excerpt": "class GPSDeviceRequest(BaseModel):\n    entity_id: str",
      "synthetic": false
    },
    {
      "anchor_id": "A:classdef:GPSAutomationRequest",
      "kind": "classdef",
      "name": "GPSAutomationRequest",
      "start_line": 21611,
      "end_line": 21618,
      "snippet_hash": "bacb5858478ea99904947121b38323d83a30b73e8939294d83eee539a253c9a6",
      "excerpt": "class GPSAutomationRequest(BaseModel):\n    name: str\n    destination: str\n    trigger_type: str  # arrive, depart, nearby\n    trigger_radius_meters: int = 100\n    actions: List[Dict[str, Any]]\n    conditions: Optional[List[Dict]] = None\n   ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_list_devices",
      "kind": "asyncfunctiondef",
      "name": "gps_list_devices",
      "start_line": 21622,
      "end_line": 21635,
      "snippet_hash": "08e5657dd959f2443566242ef5637883c26e8837e0bad5e5326e030b83d98ea7",
      "excerpt": "async def gps_list_devices(user_id: str = \"Jotah\") -> Dict[str, Any]:\n    \"\"\"\n    List all GPS tracked devices from Home Assistant.\n\n    Returns:\n        List of device trackers with location info.\n    \"\"\"\n    try:\n        service = await g",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_get_device",
      "kind": "asyncfunctiondef",
      "name": "gps_get_device",
      "start_line": 21639,
      "end_line": 21667,
      "snippet_hash": "0f5a0a9bc8296ff46d5d3ae35416f3851f0526142ee802580da3f53df9e25885",
      "excerpt": "async def gps_get_device(entity_id: str, user_id: str = \"Jotah\") -> Dict[str, Any]:\n    \"\"\"\n    Get location of a specific device.\n\n    Args:\n        entity_id: HA entity ID (URL encoded)\n    \"\"\"\n    try:\n        service = await get_gps_ser",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_nearby_places",
      "kind": "asyncfunctiondef",
      "name": "gps_nearby_places",
      "start_line": 21671,
      "end_line": 21740,
      "snippet_hash": "447a7d8749f06dae207480e2938dfdd6bc1c66690b8696b3f19bab7faaf8be5b",
      "excerpt": "async def gps_nearby_places(\n    latitude: float,\n    longitude: float,\n    query: Optional[str] = None,\n    radius: int = 1000,\n    limit: int = 10,\n) -> Dict[str, Any]:\n    \"\"\"\n    Search for places near coordinates.\n\n    Args:\n        la",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_navigate",
      "kind": "asyncfunctiondef",
      "name": "gps_navigate",
      "start_line": 21744,
      "end_line": 21798,
      "snippet_hash": "aaf5f9db94040f4ff2930994e67f0b4c30997754499f103429a21860f18a5e20",
      "excerpt": "async def gps_navigate(\n    origin_lat: float, origin_lng: float, destination: str, mode: str = \"driving\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Calculate route to destination.\n\n    Args:\n        origin_lat, origin_lng: Starting point\n        des",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_travel_time",
      "kind": "asyncfunctiondef",
      "name": "gps_travel_time",
      "start_line": 21802,
      "end_line": 21840,
      "snippet_hash": "a6a941a1900e00dd79bb001cf1a66dbb544cd9d6acaa3384126fa79ca355f5d2",
      "excerpt": "async def gps_travel_time(\n    origin_lat: float, origin_lng: float, destination: str, mode: str = \"driving\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Get estimated travel time to destination.\n    \"\"\"\n    try:\n        service = await get_gps_service",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_create_automation",
      "kind": "asyncfunctiondef",
      "name": "gps_create_automation",
      "start_line": 21844,
      "end_line": 21887,
      "snippet_hash": "f37986966ea58e72693bee1eb8c826330aa4bc53f9dfa0ec7e08831e28b6ae90",
      "excerpt": "async def gps_create_automation(\n    req: GPSAutomationRequest, user_id: str = \"Jotah\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Create a location-triggered automation.\n\n    Stores in Redis for now, would need Neo4j for permanent storage.\n    \"\"\"\n  ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_list_automations",
      "kind": "asyncfunctiondef",
      "name": "gps_list_automations",
      "start_line": 21891,
      "end_line": 21916,
      "snippet_hash": "54bb5c60b1660abe557a6b9aacb0cc48f4f78e0d94f026d2231ce63ec2f1abe0",
      "excerpt": "async def gps_list_automations(user_id: str = \"Jotah\") -> Dict[str, Any]:\n    \"\"\"\n    List user's GPS automations.\n    \"\"\"\n    try:\n        from redis import asyncio as aioredis\n\n        redis_key = f\"denis:gps:automations:{user_id}\"\n      ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:gps_check_automations",
      "kind": "asyncfunctiondef",
      "name": "gps_check_automations",
      "start_line": 21920,
      "end_line": 22001,
      "snippet_hash": "248d7ea0b8269ea905c5513ef4a8e1d20ccba400a6b0eee18718f1d419029c38",
      "excerpt": "async def gps_check_automations(\n    entity_id: str, latitude: float, longitude: float, user_id: str = \"Jotah\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Check which automations should trigger based on current location.\n    Called by HA automation wh",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:orchestrate_advanced",
      "kind": "asyncfunctiondef",
      "name": "orchestrate_advanced",
      "start_line": 22010,
      "end_line": 22061,
      "snippet_hash": "2230d0003ef1d23b6bc92f84e9a44421620e4b23fb7ae6d2a673648b368e4a10",
      "excerpt": "async def orchestrate_advanced(\n    req: Dict, current_user: User = Depends(get_current_user)\n):\n    \"\"\"\n    Advanced orchestration endpoint\n\n    Soporta:\n    - Multi-intent queries\n    - Macro execution\n    - CrewAI integration\n    - Celer",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_orchestration_status",
      "kind": "asyncfunctiondef",
      "name": "get_orchestration_status",
      "start_line": 22065,
      "end_line": 22076,
      "snippet_hash": "3be698fa8789e260248015463240bac6d37c0f510ebbd2dd23b30a588711826f",
      "excerpt": "async def get_orchestration_status(\n    execution_id: str, current_user: User = Depends(get_current_user)\n):\n    \"\"\"\n    Obtiene estado de orquestaciÃ³n en progreso\n    \"\"\"\n    from integrations.denis_advanced_orchestrator import get_advance",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:create_macro",
      "kind": "asyncfunctiondef",
      "name": "create_macro",
      "start_line": 22080,
      "end_line": 22121,
      "snippet_hash": "b97bfd9bff4809944de8a0c456ab9066f30f0247b1597edf68971d510ede0e96",
      "excerpt": "async def create_macro(req: Dict, current_user: User = Depends(get_current_user)):\n    \"\"\"\n    Crea macro personalizada\n\n    Body: {\n        \"name\": \"my_custom_macro\",\n        \"description\": \"My custom automation\",\n        \"steps\": [\n      ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:list_macros",
      "kind": "asyncfunctiondef",
      "name": "list_macros",
      "start_line": 22125,
      "end_line": 22149,
      "snippet_hash": "f95cd16da8c515dfc34de3d59358eb02c67333cbadba9ce591911ab22d99ba34",
      "excerpt": "async def list_macros(current_user: User = Depends(get_current_user)):\n    \"\"\"\n    Lista todas las macros disponibles del usuario\n    \"\"\"\n    from integrations.denis_macro_system import DenisMacroManager\n\n    macro_system = DenisMacroManage",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:list_celery_tasks",
      "kind": "asyncfunctiondef",
      "name": "list_celery_tasks",
      "start_line": 22153,
      "end_line": 22165,
      "snippet_hash": "7f6a40c8c3921f3cc6637c97c751f1b0b249866a662ba0e7e23d4c57fd0b38cd",
      "excerpt": "async def list_celery_tasks(current_user: User = Depends(get_current_user)):\n    \"\"\"\n    Lista tareas Celery en ejecuciÃ³n\n    \"\"\"\n    from celery_config import app as celery_app\n\n    inspect = celery_app.control.inspect()\n\n    active = insp",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:cancel_celery_task",
      "kind": "asyncfunctiondef",
      "name": "cancel_celery_task",
      "start_line": 22169,
      "end_line": 22179,
      "snippet_hash": "e5acc34b428d4c38f17139335d92d35a514dfcb9a11711b39c2cb18fd5785bd4",
      "excerpt": "async def cancel_celery_task(\n    task_id: str, current_user: User = Depends(get_current_user)\n):\n    \"\"\"\n    Cancela tarea Celery\n    \"\"\"\n    from celery_config import app as celery_app\n\n    celery_app.control.revoke(task_id, terminate=Tru",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:list_crewai_agents",
      "kind": "asyncfunctiondef",
      "name": "list_crewai_agents",
      "start_line": 22183,
      "end_line": 22200,
      "snippet_hash": "b216e201e50e66b1b3da81dc2b2bab3663837d8f186bbd33d5f420c139072563",
      "excerpt": "async def list_crewai_agents():\n    \"\"\"\n    Lista agents CrewAI disponibles\n    \"\"\"\n    from integrations.denis_crewai_orchestrator import get_crew_orchestrator\n\n    orchestrator = get_crew_orchestrator()\n\n    agents = [\n        {\n         ",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:list_crewai_crews",
      "kind": "asyncfunctiondef",
      "name": "list_crewai_crews",
      "start_line": 22204,
      "end_line": 22213,
      "snippet_hash": "f6ad6724a0bc8705ec62b09cbb25e28d24282c9514446f0fa040556ae5d40a27",
      "excerpt": "async def list_crewai_crews():\n    \"\"\"\n    Lista crews disponibles\n    \"\"\"\n    from integrations.denis_crewai_orchestrator import get_crew_orchestrator\n\n    orchestrator = get_crew_orchestrator()\n    crews = orchestrator.list_available_crew",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:orchestration_progress_ws",
      "kind": "asyncfunctiondef",
      "name": "orchestration_progress_ws",
      "start_line": 22217,
      "end_line": 22249,
      "snippet_hash": "a58c69dd73a20829013bf881b91b57748ead1fe4cd5f12e430c3b48faa302b84",
      "excerpt": "async def orchestration_progress_ws(\n    websocket: WebSocket, execution_id: str, token: str = Query(...)\n):\n    \"\"\"\n    WebSocket para recibir progreso de orquestaciÃ³n en tiempo real\n    \"\"\"\n    await websocket.accept()\n\n    # Verify token",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:get_smx_8084",
      "kind": "asyncfunctiondef",
      "name": "get_smx_8084",
      "start_line": 22260,
      "end_line": 22268,
      "snippet_hash": "98976ed1f7dd0b81a62717a8f80c1a5ec53352f5e3f7d3f2ec83145530b2c772",
      "excerpt": "async def get_smx_8084():\n    \"\"\"Lazy initialization de SMX integrator.\"\"\"\n    global _smx_8084_integrator\n    if _smx_8084_integrator is None:\n        from denis_smx_8084 import SMX8084Integrator\n\n        _smx_8084_integrator = SMX8084Inte",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:smx_fused_endpoint",
      "kind": "asyncfunctiondef",
      "name": "smx_fused_endpoint",
      "start_line": 22272,
      "end_line": 22470,
      "snippet_hash": "096251ea8659f9f8470408521a897af4964c2978e81fa72280aca6aa0081e2fb",
      "excerpt": "async def smx_fused_endpoint(request: Request):\n    \"\"\"\n    SMX Fused Processing - 2-Fase Orchestrator en 8084.\n\n    Este endpoint integra el SMX completo:\n    - FASE 1: Tokenize + Safety + Fast (paralelo)\n    - FASE 2: Intent â Entity â Ma",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:smx_fused_stream_endpoint",
      "kind": "asyncfunctiondef",
      "name": "smx_fused_stream_endpoint",
      "start_line": 22474,
      "end_line": 22541,
      "snippet_hash": "646c12add7163e513f7bfcf5f1b18932e4397490a0a34304452c6032238e1068",
      "excerpt": "async def smx_fused_stream_endpoint(request: Request):\n    \"\"\"SMX Fused con streaming SSE.\"\"\"\n    import uuid\n\n    from fastapi.responses import StreamingResponse\n\n    try:\n        body = await request.json()\n        text = body.get(\"text\",",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:event_generator",
      "kind": "asyncfunctiondef",
      "name": "event_generator",
      "start_line": 22493,
      "end_line": 22536,
      "snippet_hash": "b772abe510725bbd99be4b813ba541691dbec412ca67023273a9c698a070190e",
      "excerpt": "        async def event_generator():\n            try:\n                # Phase 1\n                yield f\"data: {json.dumps({'phase': 1, 'status': 'started'})}\\n\\n\"\n\n                phase1_results = await smx.smx.orchestrator.phase1_parallel(",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:smx_fused_speculative_endpoint",
      "kind": "asyncfunctiondef",
      "name": "smx_fused_speculative_endpoint",
      "start_line": 22545,
      "end_line": 22651,
      "snippet_hash": "e209a513a759e604763b25b4a97715608e5f55c8f4eb307feeacfe633c0d22cc",
      "excerpt": "async def smx_fused_speculative_endpoint(request: Request):\n    \"\"\"SMX Fused con speculative decoding para respuestas mÃ¡s rÃ¡pidas.\"\"\"\n    import uuid\n\n    try:\n        body = await request.json()\n        text = body.get(\"text\", \"\").strip()\n",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:delegate_to_smx",
      "kind": "asyncfunctiondef",
      "name": "delegate_to_smx",
      "start_line": 22655,
      "end_line": 22690,
      "snippet_hash": "7c4fbd4f02a66ff1ccd38e89afe1516c7076dda8c69464aa187cb81b0e1fe941",
      "excerpt": "async def delegate_to_smx(\n    user_msg: str,\n    conversation_history: List[Dict[str, str]],\n    system_prompt: str,\n    user_id: str = \"anonymous\",\n    session_id: Optional[str] = None,\n) -> Dict[str, Any]:\n    \"\"\"Delegar a SMX (reemplazo",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:smx_status_endpoint",
      "kind": "asyncfunctiondef",
      "name": "smx_status_endpoint",
      "start_line": 22694,
      "end_line": 22753,
      "snippet_hash": "6ae0df42892c32646f69a6804ce931cd3a84eb332a4bafd6a3920a148d3fa8b3",
      "excerpt": "async def smx_status_endpoint():\n    \"\"\"Status del sistema SMX completo con gates endurecidas.\"\"\"\n    import time\n\n    start_time = time.time()\n\n    try:\n        smx = await get_smx_8084()\n\n        # GATE: Verificar inicializaciÃ³n\n        i",
      "synthetic": false
    },
    {
      "anchor_id": "A:asyncfunctiondef:smx_graph_history",
      "kind": "asyncfunctiondef",
      "name": "smx_graph_history",
      "start_line": 22757,
      "end_line": 22769,
      "snippet_hash": "213af86d1386355a68236c01c2ce107662784c1d442be446f3e863c8ec2856b7",
      "excerpt": "async def smx_graph_history(session_id: str, limit: int = 20):\n    \"\"\"\n    Obtener historial de una sesiÃ³n desde Neo4j.\n    Requiere grafo-cÃ©ntrico activo.\n    \"\"\"\n    try:\n        from denis_smx_neo4j import get_neo4j_client\n\n        neo4j",
      "synthetic": false
    },
    {
      "anchor_id": "A:synthetic:main_guard",
      "kind": "section",
      "name": "main_guard",
      "start_line": 22787,
      "end_line": 22797,
      "snippet_hash": "eed3889c7ebaa45f5b2354729c90c681d7c1152acab99170249a8209eb51a4eb",
      "excerpt": "if __name__ == \"__main__\":\n    import uvicorn\n\n    logger.info(f\"Starting Denis Persona Canonical on port {PERSONA_PORT}...\")\n    uvicorn.run(\n        \"denis_persona_canonical:app\",\n        host=\"0.0.0.0\",\n        port=PERSONA_PORT,\n       ",
      "synthetic": true
    }
  ],
  "chunks": [
    {
      "chunk_id": "C:ENTRYPOINTS",
      "title": "Entry points and dispatch",
      "anchors": [
        "A:synthetic:main_guard"
      ],
      "snippet_hash": "7214eb396bd0c9322cd7206b7094152f14726e398aa8442781c7ace4f798ae3f"
    },
    {
      "chunk_id": "C:EXTERNAL_INTERFACES",
      "title": "External interfaces (HTTP/WS/SSE)",
      "anchors": [],
      "snippet_hash": "a787d0868d6607dc3bc6604550b7677dd10b9d3b99f13c3a55b11383c0837d90"
    },
    {
      "chunk_id": "C:LEGACY_INTENT",
      "title": "Legacy intent and purpose",
      "anchors": [],
      "snippet_hash": "70138b7076a8b3f56b41adc68f32d147c58635a3870f6624a2738c8326accc36"
    },
    {
      "chunk_id": "C:A:functiondef:register_memory_routers",
      "title": "Anchor register_memory_routers",
      "anchors": [
        "A:functiondef:register_memory_routers"
      ],
      "snippet_hash": "18a15dbfe21c6379f8183fe6627545c484e236586c1e57ecbfc9291a1da57927"
    },
    {
      "chunk_id": "C:A:asyncfunctiondef:get_auth_manager",
      "title": "Anchor get_auth_manager",
      "anchors": [
        "A:asyncfunctiondef:get_auth_manager"
      ],
      "snippet_hash": "f9642a4e185f6a7b524a2ad30def000ea6b520aaba210a719867b61bb20fff9c"
    },
    {
      "chunk_id": "C:A:asyncfunctiondef:get_current_user",
      "title": "Anchor get_current_user",
      "anchors": [
        "A:asyncfunctiondef:get_current_user"
      ],
      "snippet_hash": "9eb041f1ada5c9632cbdd14dc7f2839e3b3db1c623f2ec6394bb731f5f84697b"
    },
    {
      "chunk_id": "C:A:asyncfunctiondef:get_current_user_optional",
      "title": "Anchor get_current_user_optional",
      "anchors": [
        "A:asyncfunctiondef:get_current_user_optional"
      ],
      "snippet_hash": "7183e52a9eb5bde67bbe99cc37922909fcefb349110ca8fe30453b267b8dd559"
    },
    {
      "chunk_id": "C:A:functiondef:require_permission",
      "title": "Anchor require_permission",
      "anchors": [
        "A:functiondef:require_permission"
      ],
      "snippet_hash": "b5e4c36037d46720776cb9d57384f4745b349c2e02b7cae3437548c24f918468"
    },
    {
      "chunk_id": "C:A:asyncfunctiondef:permission_checker",
      "title": "Anchor permission_checker",
      "anchors": [
        "A:asyncfunctiondef:permission_checker"
      ],
      "snippet_hash": "410fd758ee18b4fce60b46539c54d88b5d0607dbdb50ca850e1d3fabe35602b4"
    },
    {
      "chunk_id": "C:A:functiondef:_has_any_role",
      "title": "Anchor _has_any_role",
      "anchors": [
        "A:functiondef:_has_any_role"
      ],
      "snippet_hash": "e5f37d47507d2dcb8bb54e444e14bb5e2f84cb0e671d1e035a44e336bb6ebecd"
    },
    {
      "chunk_id": "C:A:functiondef:require_roles",
      "title": "Anchor require_roles",
      "anchors": [
        "A:functiondef:require_roles"
      ],
      "snippet_hash": "028a546ba308d9915dd1764d6c040dae2aa89812f3e42061a3b12d7f567305ac"
    },
    {
      "chunk_id": "C:A:asyncfunctiondef:role_checker",
      "title": "Anchor role_checker",
      "anchors": [
        "A:asyncfunctiondef:role_checker"
      ],
      "snippet_hash": "c29763cc89236f7fdd6f837cb8bf9078a7d8bd055e847374760f53a9f202fa43"
    }
  ]
}